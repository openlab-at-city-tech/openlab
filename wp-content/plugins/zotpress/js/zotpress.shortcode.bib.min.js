jQuery(document).ready((function(){if(jQuery(".zp-Zotpress-Bib").length>0){var e={},t=0;jQuery(".zp-Zotpress-Bib").each((function(t,n){var i=jQuery(n),s={zpItemkey:!1};jQuery(".ZP_ITEM_KEY",i).text().trim().length>0&&(s.zpItemkey=jQuery(".ZP_ITEM_KEY",i).text()),s.zpItemType=!1,jQuery(".ZP_ITEMTYPE",i).text().trim().length>0&&(s.zpItemType=jQuery(".ZP_ITEMTYPE",i).text()),s.zpCollectionId=!1,jQuery(".ZP_COLLECTION_ID",i).text().trim().length>0&&(s.zpCollectionId=jQuery(".ZP_COLLECTION_ID",i).text()),s.zpTagId=!1,jQuery(".ZP_TAG_ID",i).text().trim().length>0&&(s.zpTagId=jQuery(".ZP_TAG_ID",i).text()),s.zpAuthor=!1,jQuery(".ZP_AUTHOR",i).text().trim().length>0&&(s.zpAuthor=jQuery(".ZP_AUTHOR",i).text()),s.zpYear=!1,jQuery(".ZP_YEAR",i).text().trim().length>0&&(s.zpYear=jQuery(".ZP_YEAR",i).text()),s.zpStyle=!1,jQuery(".ZP_STYLE",i).text().trim().length>0&&(s.zpStyle=jQuery(".ZP_STYLE",i).text()),s.zpLimit=!1,jQuery(".ZP_LIMIT",i).text().trim().length>0&&(s.zpLimit=jQuery(".ZP_LIMIT",i).text()),s.zpTitle=!1,jQuery(".ZP_TITLE",i).text().trim().length>0&&(s.zpTitle=jQuery(".ZP_TITLE",i).text()),s.zpShowImages=!1,jQuery(".ZP_SHOWIMAGE",i).text().trim().length>0&&(s.zpShowImages=jQuery(".ZP_SHOWIMAGE",i).text().trim()),s.zpShowTags=!1,jQuery(".ZP_SHOWTAGS",i).text().trim().length>0&&(s.zpShowTags=!0),s.zpDownloadable=!1,jQuery(".ZP_DOWNLOADABLE",i).text().trim().length>0&&(s.zpDownloadable=!0),s.zpInclusive=!1,jQuery(".ZP_INCLUSIVE",i).text().trim().length>0&&(s.zpInclusive=!0),s.zpShowNotes=!1,jQuery(".ZP_NOTES",i).text().trim().length>0&&(s.zpShowNotes=!0),s.zpShowAbstracts=!1,jQuery(".ZP_ABSTRACT",i).text().trim().length>0&&(s.zpShowAbstracts=!0),s.zpCiteable=!1,jQuery(".ZP_CITEABLE",i).text().trim().length>0&&(s.zpCiteable=!0),s.zpTarget=!1,jQuery(".ZP_TARGET",i).text().trim().length>0&&(s.zpTarget=!0),s.zpURLWrap=!1,jQuery(".ZP_URLWRAP",i).text().trim().length>0&&(s.zpURLWrap=jQuery(".ZP_URLWRAP",i).text()),s.zpHighlight=!1,jQuery(".ZP_HIGHLIGHT",i).text().trim().length>0&&(s.zpHighlight=jQuery(".ZP_HIGHLIGHT",i).text()),s.zpUpdateNeeded=!1,jQuery(".ZP_UPDATENEEDED",i).text().trim().length>0&&"true"==jQuery(".ZP_UPDATENEEDED",i).text()&&(s.zpUpdateNeeded=!0),s.zpJSON=!1,jQuery(".ZP_JSON",i).text().trim().length>0&&(s.zpJSON=jQuery(".ZP_JSON",i).text().trim()),s.zpForceNumsCount=1,s.zpBibIndex=t,$fromScratch=!0,!jQuery(".ZP_JSON",i).text().trim().length>0&&($fromScratch=!1);var p=JSON.parse(decodeURIComponent(s.zpJSON));if(r(i,p,s),console.log("---"),s.zpCollectionId&&-1!=s.zpCollectionId.indexOf(","))e[t]=s.zpCollectionId.split(","),s.zpCollectionId=e[t][0],a(0,0,i,s,$fromScratch);else if(s.zpTagId&&1==s.zpInclusive&&-1!=s.zpTagId.indexOf(",")){var o=s.zpTagId.split(",");jQuery.each(o,(function(e,t){s.zpTagId=t,a(0,0,i,s,$fromScratch)}))}else if(s.zpAuthor&&-1!=s.zpAuthor.indexOf(",")){var l=s.zpAuthor.split(",");1==s.zpInclusive?jQuery.each(l,(function(e,t){s.zpAuthor=t,a(0,0,i,s,$fromScratch)})):a(0,0,i,s,$fromScratch)}else if(s.zpYear&&-1!=s.zpYear.indexOf(",")){var c=s.zpYear.split(",");jQuery.each(c,(function(e,t){s.zpYear=t,a(0,0,i,s,$fromScratch)}))}else a(0,0,i,s,$fromScratch)}))}function a(n,i,s,p,o){console.log("zp: calling zp_get_items with update check?",o),console.log("zp: is an update needed?",p.zpUpdateNeeded),void 0!==n&&"false"!=n&&""!=n||(n=0),void 0!==i&&"false"!=i&&""!=i||(i=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",instance_id:s.attr("id"),api_user_id:jQuery(".ZP_API_USER_ID",s).text(),item_type:jQuery(".ZP_ITEM_TYPE",s).text(),item_key:p.zpItemkey,itemtype:p.zpItemType,collection_id:p.zpCollectionId,tag_id:p.zpTagId,author:p.zpAuthor,year:p.zpYear,style:p.zpStyle,limit:p.zpLimit,title:p.zpTitle,showimage:p.zpShowImages,showtags:p.zpShowTags,downloadable:p.zpDownloadable,inclusive:p.zpInclusive,shownotes:p.zpShowNotes,showabstracts:p.zpShowAbstracts,citeable:p.zpCiteable,target:p.zpTarget,urlwrap:p.zpURLWrap,highlight:p.zpHighlight,sortby:jQuery(".ZP_SORTBY",s).text(),order:jQuery(".ZP_ORDER",s).text(),update:o,request_update:p.zpUpdateNeeded,request_start:n,request_last:i,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(n){var i=jQuery.parseJSON(n);if(t+=i.data.length,o?console.log("zp: running update for items:",t,"->",i.data.length):console.log("zp: adding items:",t,"->",i.data.length),"error"==i.status||"empty"==i.status||"Not found"==i.data){var l=zpShortcodeAJAX.txt_zperror+" ";0==i.data?(i.data=zpShortcodeAJAX.txt_noitemsfound,l=i.data):l+=i.data,console.log("zp: Zotpress message: "+l);var c="";jQuery("#"+i.instance+" .zp-List .zp-Entry").length>0&&(c=' class="hide"'),jQuery("#"+i.instance+" .zp-List").removeClass("loading").append("<p"+c+">"+l+"</p>")}else if(jQuery("#"+i.instance+" .zp-SEO-Content").remove(),void 0!==i&&null!=i&&0!=i&&i.data.length>0){var u="";if(1==p.zpShowNotes)var d="";!1===o?jQuery("#"+i.instance+" .zp-List").addClass("used_cache"):!0===o&&(!jQuery("#"+i.instance+" .zp-List").hasClass("updating")&&jQuery("#"+i.instance+" .zp-Citation-Notes").length>0&&jQuery("#"+i.instance+" .zp-Citation-Notes").remove(),jQuery("#"+i.instance+" .zp-List").hasClass("updating")||jQuery("#"+i.instance+" .zp-List").addClass("updating"),p.zpForceNumsCount=1),0!=i.data&&jQuery.each(i.data,(function(e,t){var a="",r=jQuery("#"+i.instance+" .zp-List #zp-ID-"+jQuery(".ZP_POSTID",s).text()+"-"+jQuery(".ZP_API_USER_ID",s).text()+"-"+t.key);if(r.length>0&&!1===o&&!jQuery("#"+i.instance+" .zp-List").hasClass("used_cache"))return!1;var n="none";t.data.hasOwnProperty("itemType")&&(n=t.data.itemType);var l="0000",c="0000";t.meta.hasOwnProperty("parsedDate")&&(l=t.meta.parsedDate.substring(0,4),c=t.meta.parsedDate);var z=t.data.title;t.meta.hasOwnProperty("creatorSummary")&&(z=t.meta.creatorSummary.replace(/ /g,"-")),a+="<div id='zp-ID-"+jQuery(".ZP_POSTID",s).text()+"-"+jQuery(".ZP_API_USER_ID",s).text()+"-"+t.key+"'",a+=" data-zp-author-date='"+z+"-"+c+"'",a+=" data-zp-date-author='"+c+"-"+z+"'",a+=" data-zp-date='"+c+"'",a+=" data-zp-year='"+l+"'",a+=" data-zp-itemtype='"+n+"'",a+=" class='zp-Entry zpSearchResultsItem",!0===o&&(a+=" zp_updated"),jQuery("#"+i.instance+" .ZP_SHOWIMAGE").text().trim().length>0&&t.hasOwnProperty("image")?(a+=" zp-HasImage'>\n",a+="<div id='zp-Citation-"+t.key+"' class='zp-Entry-Image hasImage' rel='"+t.key+"'>\n","image"==p.zpURLWrap&&""!=t.data.url&&(a+="<a href='"+t.data.url+"'",p.zpTarget&&(a+=" target='_blank'"),a+=">"),a+="<img class='thumb' src='"+t.image[0]+"' alt='image' />\n","image"==p.zpURLWrap&&""!=t.data.url&&(a+="</a>"),a+="</div>\n"):a+="'>\n",jQuery("#"+i.instance+" .ZP_FORCENUM").text().length>0&&"1"==jQuery("#"+i.instance+" .ZP_FORCENUM").text()&&(/csl-left-margin/i.test(t.bib)||(t.bib=t.bib.replace('<div class="csl-entry">','<div class="csl-entry">'+p.zpForceNumsCount+". "),p.zpForceNumsCount++)),a+=t.bib,1==p.zpShowAbstracts&&t.data.hasOwnProperty("abstractNote")&&t.data.abstractNote.length>0&&(a+="<p class='zp-Abstract'><span class='zp-Abstract-Title'>Abstract:</span> "+t.data.abstractNote+"</p>\n"),1==p.zpShowTags&&t.data.hasOwnProperty("tags")&&t.data.tags.length>0&&(a+="<p class='zp-Zotpress-ShowTags'><span class='title'>Tags:</span> ",jQuery.each(t.data.tags,(function(e,r){a+="<span class='tag'>"+r.tag+"</span>",e!=t.data.tags.length-1&&(a+="<span class='separator'>,</span> ")})),a+="</p>\n"),a+="</div>\n",1==p.zpShowNotes&&t.hasOwnProperty("notes")&&(d+=t.notes),r.length>0&&!0===o?r.replaceWith(jQuery(a)):u+=a})),jQuery("#"+i.instance+" .zp-List").append(u),1==p.zpShowNotes&&d.length>0&&(d="<div class='zp-Citation-Notes'>\n<h4>Notes</h4>\n<ol>\n"+d,d+="</ol>\n</div>\x3c!-- .zp-Citation-Notes --\x3e\n\n",jQuery("#"+i.instance).append(d)),jQuery("#"+i.instance+" .zp-List .csl-left-margin").length>0&&jQuery(".ZP_STYLE",s).text().trim().length>0&&"american-antiquity"!=jQuery(".ZP_STYLE",s).text().trim()&&(p.zpForceNumsCount=1,jQuery("#"+i.instance+" .zp-List .csl-left-margin").each((function(e,t){var a=jQuery(t).text();a=a.replace(a.match(/\d+/)[0],p.zpForceNumsCount),jQuery(t).text(a),p.zpForceNumsCount++}))),r(s,i,p),0!=i.meta.request_next&&"false"!=i.meta.request_next?a(i.meta.request_next,i.meta.request_last,s,p,o):(jQuery("#"+i.instance+" .zp-List").removeClass("loading"),i.updateneeded?(console.log("zp: update needed"),p.zpUpdateNeeded=!0,a(0,0,s,p,!0)):e[p.zpBibIndex]&&e[p.zpBibIndex].length>0&&e[p.zpBibIndex][e[p.zpBibIndex].length-1]!=p.zpCollectionId?(p.zpCollectionId=e[p.zpBibIndex][e[p.zpBibIndex].indexOf(p.zpCollectionId)+1],jQuery("#"+i.instance+" .zp-List").removeClass("updating"),a(0,0,s,p,o)):(console.log("zp: done"),console.log("---")))}else console.log("zp: done"),!0===o&&(jQuery("#"+s.attr("id")+" .zp-List").removeClass("loading"),0==jQuery("#"+s.attr("id")+" .zp-List .zp-Entry").length&&jQuery("#"+s.attr("id")+" .zp-List").append("<p>There are no citations to display.</p>\n"))},error:function(e){console.log("zp: Zotpress via WP AJAX Error: ",e)}})}function r(e,t,a){console.log("zp: reformatting instance",t.instance);var r=jQuery(".ZP_SORTBY",e).text(),n=jQuery(".ZP_ORDER",e).text(),i="data-zp-author-date";if("date"==r&&(i="data-zp-date-author"),function(e,t,a,r){console.log("zp: running typical sort for instance ",e.instance),-1!==["author","date"].indexOf(t)&&0==jQuery("#"+e.instance+" .zp-List .csl-left-margin").length&&jQuery("#"+e.instance+" .zp-List div.zp-Entry").sort((function(e,t){var n=e.getAttribute(a).toLowerCase(),i=t.getAttribute(a).toLowerCase();return n>i?"asc"==r?1:-1:n<i?"asc"==r?-1:1:0})).detach().appendTo("#"+e.instance+" .zp-List")}(t,r,i,n),!1!==a.zpTitle){var s={};jQuery("#"+t.instance+" .zp-List div.zp-Entry").each((function(e,t){var r=jQuery(t).data("zp-"+a.zpTitle);!1===s.hasOwnProperty(r)&&(s[r]=[]),s[r].push(jQuery(t).attr("id"))}));var p=Object.getOwnPropertyNames(s);if("itemtype"==a.zpTitle){var o=["book","bookSection","journalArticle","conferencePaper","thesis","report","encyclopediaArticle","newspaperArticle","magazineArticle","presentation","interview","dictionaryEntry","document","manuscript","patent","map","blogPost","webpage","artwork","film","audioRecording","statute","bill","case","hearing","forumPost","letter","email","instantMessage","software","podcast","radioBroadcast","tvBroadcast","videoRecording","attachment","note","preprint"];o.slice(0).forEach((function(e,t){-1==p.indexOf(e)&&o.splice(o.indexOf(e),1)})),p=o}else"asc"==n?p.sort((function(e,t){return e-t})):p.sort((function(e,t){return t-e}));p.forEach((function(t,i){var p=t;if("itemtype"==a.zpTitle){if(null!==p.match(/[A-Z]/)){var o=p.match(/[A-Z]/).index;p=p.substr(0,o)+" "+p.substr(o)}p=p.charAt(0).toUpperCase()+p.slice(1)}"0000"==p&&(p="No date"),a.zpTitle,0==jQuery("#"+e.attr("id")+" .zp-List h3[rel='"+t+"']").length&&jQuery("#"+e.attr("id")+" .zp-List").append("<h3 rel='"+t+"'>"+p+"</h3>\n"),("year"==a.zpTitle&&"asc"==n||"itemtype"==a.zpTitle&&"date"==r)&&s[t].reverse(),s[t].forEach((function(a,r){jQuery("#"+e.attr("id")+" #"+a).insertAfter(jQuery("#"+e.attr("id")+" .zp-List h3[rel='"+t+"']"))}))}))}}}));