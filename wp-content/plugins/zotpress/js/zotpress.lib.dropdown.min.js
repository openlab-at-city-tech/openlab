jQuery(document).ready((function(){if(jQuery(".zp-Browse").length>0)for(let o=0;o<window.zpBrowseList.length;++o){var e=jQuery("#"+window.zpBrowseList[o].id),t={zpCollectionId:!1,zpTagId:!1,zpShowTags:!1,zpShowImages:!1,zpIsAdmin:!1,zpTarget:!1,zpTopLevel:!1,zpURLWrap:!1,zpItemsFlag:!0};jQuery(".ZP_COLLECTION_ID",e).length>0&&(t.zpCollectionId=jQuery(".ZP_COLLECTION_ID",e).text()),jQuery(".ZP_TAG_ID",e).length>0&&(t.zpTagId=jQuery(".ZP_TAG_ID",e).text()),jQuery(".ZP_SHOWTAGS").length>0&&"1"==parseInt(jQuery(".ZP_SHOWTAGS").text())&&(t.zpShowTags=!0),jQuery(".ZP_SHOWIMAGE",e).length>0&&("yes"==jQuery(".ZP_SHOWIMAGE",e).text()||"true"==jQuery(".ZP_SHOWIMAGE",e).text()||"1"==jQuery(".ZP_SHOWIMAGE",e).text())&&(t.zpShowImages=!0),jQuery(".ZP_ISADMIN",e).length>0&&(t.zpIsAdmin=!0),jQuery(".ZP_TARGET",e).length>0&&jQuery(".ZP_TARGET").text().length>0&&(t.zpTarget=!0),jQuery(".ZP_TOPLEVEL",e).length>0&&(t.zpTopLevel=jQuery(".ZP_TOPLEVEL",e).text(),!1===t.zpCollectionId&&!1===t.zpTagId&&(t.zpCollectionId=t.zpTopLevel)),jQuery(".ZP_URLWRAP",e).length>0&&(t.zpURLWrap=jQuery(".ZP_URLWRAP",e).text());var a=!1;jQuery(".ZP_UPDATENEEDED",e).text().trim().length>0&&"true"==jQuery(".ZP_UPDATENEEDED",e).text()&&(a=!0);var s=!0;""==jQuery(".ZP_BROWSEBAR",e).text()&&(s=!1),s&&(r(o,t,e,0,0,!1),l(o,t,e,0,0,!1)),i(o,t,e,0,0,!1),console.log("---")}function o(e){if(0!=jQuery("div.zp-List .csl-left-margin",e).length&&/\d/.test(jQuery("div.zp-List .csl-left-margin",e).text())){var t=1;jQuery("div.zp-List .csl-left-margin",e).each((function(){jQuery(this).text(jQuery(this).text().replace(/(\d+)/,t)),t++}))}}function r(e,t,a,s,o,l){void 0!==s&&"false"!=s&&""!=s||(s=0),void 0!==o&&"false"!=o&&""!=o||(o=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",a).text(),item_type:"collections",collection_id:t.zpCollectionId,request_start:s,request_last:o,sortby:"title",get_top:!0,update:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(s){var o=jQuery.parseJSON(s),i="";!1===l&&jQuery("select.zp-Browse-Collections-Select",a).addClass("used_cache"),!0!==l||jQuery("select.zp-Browse-Collections-Select",a).hasClass("updating")||(jQuery("select.zp-Browse-Collections-Select",a).find("*").not(".blank").remove(),jQuery("select.zp-Browse-Collections-Select",a).addClass("updating"),t.zpTagId&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='blank'>--"+zpShortcodeAJAX.txt_nocollsel+"--</option>")),t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.blank",a).length&&jQuery(".ZP_COLLECTION_NAME",a).length>0&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='blank' class='blank'>"+jQuery(".ZP_COLLECTION_NAME",a).text()+"</option>\n"),"0"!=o&&o.data.length>0&&"0"!=o.data&&(jQuery.each(o.data,(function(e,a){var s="<option value='"+a.key+"'";t.zpCollectionId==a.key&&(s+=" selected='selected'"),s+=">",t.zpCollectionId&&(s+="- "),s+=a.data.name+" (",a.meta.numCollections>0&&(s+=a.meta.numCollections+" "+zpShortcodeAJAX.txt_subcoll+", "),s+=a.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",i+=s})),jQuery("select.zp-Browse-Collections-Select",a).append(i),0!=o.meta.request_next&&"false"!=o.meta.request_next?r(e,t,a,o.meta.request_next,o.meta.request_last,l):jQuery("select.zp-Browse-Collections-Select",a).hasClass("updating")||r(e,t,a,0,0,!0)),t.zpCollectionId&&"toplevel"!=t.zpCollectionId&&0==jQuery(".zp-Browse-Collections-Select option.toplevel",a).length&&jQuery("select.zp-Browse-Collections-Select",a).append("<option value='toplevel' class='toplevel'>&larr; "+zpShortcodeAJAX.txt_backtotop+"</option>\n"),jQuery("select.zp-Browse-Collections-Select",a).removeClass("loading").find(".loading").remove()},error:function(e){console.log("zp: error for zplib_get_collections(): ",e.statusText)},complete:function(e,t){}})}function l(e,t,a,s,o,r){void 0!==s&&"false"!=s&&""!=s||(s=0),void 0!==o&&"false"!=o&&""!=o||(o=0),jQuery.ajax({url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",a).text(),item_type:"tags",is_dropdown:!0,maxtags:jQuery(".ZP_MAXTAGS",a).text(),request_start:s,request_last:o,update:r,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(s){var o=jQuery.parseJSON(s),i="<option class='zp-List-Tags-Select' name='zp-List-Tags-Select'>--"+zpShortcodeAJAX.txt_notagsel+"--</option>\n";t.zpTagId&&(i="<option value='toplevel' class='toplevel'>--"+zpShortcodeAJAX.txt_unsettag+"--</option>\n"),!1===r&&jQuery("select.zp-List-Tags",a).addClass("used_cache"),!0!==r||jQuery("select.zp-List-Tags",a).hasClass("updating")||jQuery("select.zp-List-Tags",a).empty().addClass("updating"),0!==o&&o.data.length>0?(jQuery.each(o.data,(function(e,t){var s="<option class='zp-List-Tag' value='"+t.tag.replace(/ /g,"+")+"'";jQuery(".ZP_TAG_ID",a).length>0&&jQuery(".ZP_TAG_ID",a).text()==t.tag&&(s+=" selected='selected'"),s+=">"+t.tag+" ("+t.meta.numItems+" "+zpShortcodeAJAX.txt_items+")</option>\n",i+=s})),jQuery("select.zp-List-Tags",a).append(i),0!=o.meta.request_next&&"false"!=o.meta.request_next?l(e,t,a,o.meta.request_next,o.meta.request_last,r):jQuery("select.zp-List-Tags",a).hasClass("updating")||l(e,t,a,0,0,!0),jQuery("select.zp-List-Tags",a).removeClass("loading").find(".loading").remove()):(jQuery("select.zp-List-Tags",a).removeClass("loading").find(".loading").remove(),jQuery("select.zp-List-Tags",a).append("<option rel='empty' value='empty'>"+zpShortcodeAJAX.txt_notags+"</option>"))},error:function(e){console.log("zp: error for zplib_get_tags(): ",e.statusText)},complete:function(e,t){}})}function i(e,t,s,r,l,n){console.log("zp: calling zplib_get_items with update check?",n),console.log("zp: is an update needed?",a),void 0!==r&&"false"!=r&&""!=r||(r=0),void 0!==l&&"false"!=l&&""!=l||(l=0),jQuery(".zp-List",s).hasClass("loading")&&""==jQuery(".zp-List",s).find(".zp_display_progress").text()&&jQuery(".zp-List",s).append("<div class='zp_display_progress'>"+zpShortcodeAJAX.txt_loading+" ...</div>"),jQuery.ajax({async:!0,url:zpShortcodeAJAX.ajaxurl,ifModified:!0,data:{action:"zpRetrieveViaShortcode",api_user_id:jQuery(".ZP_API_USER_ID",s).text(),is_dropdown:!0,item_type:"items",citeable:jQuery(".ZP_CITEABLE",s).text(),downloadable:jQuery(".ZP_DOWNLOADABLE",s).text(),showtags:t.zpShowTags,showimage:t.zpShowImages,target:t.zpTarget,urlwrap:t.zpURLWrap,collection_id:t.zpCollectionId,tag_id:t.zpTagId,get_top:!0,sortby:jQuery(".ZP_SORTBY",s).text(),order:jQuery(".ZP_ORDER",s).text(),update:n,request_update:a,request_start:r,request_last:l,zpShortcode_nonce:zpShortcodeAJAX.zpShortcode_nonce},xhrFields:{withCredentials:!0},success:function(r){var l=jQuery.parseJSON(r);if(!1===n?jQuery(".zp-List",s).addClass("used_cache"):!0===n&&(jQuery(".zp-List",s).hasClass("updating")||jQuery(".zp-List",s).addClass("updating")),void 0!==l&&null!=l&&0!=l&&l.data.length>0&&0!=l.data){var p="";if(jQuery(".zp-List",s).hasClass("updating")||!1===l.meta.request_last||"false"==l.meta.request_last||0===l.meta.request_last||jQuery(".zp-List",s).find(".zp_display_progress").html("Loading "+l.meta.request_next+"-"+(l.meta.request_next+50)+" out of "+(parseInt(l.meta.request_last)+50)+"..."),0!=l.data&&jQuery.each(l.data,(function(e,a){var o="",r=jQuery("div.zp-List .zp-ID-"+a.library.id+"-"+a.key,s),l="0000";a.meta.hasOwnProperty("parsedDate")&&(l=a.meta.parsedDate.substring(0,4));var i=a.data.title;a.meta.hasOwnProperty("creatorSummary")&&(i=a.meta.creatorSummary.replace(/ /g,"-")),o+="<div id='zp-ID-"+a.library.id+"-"+a.key+"' class='zp-Entry zpSearchResultsItem hidden",!0===n&&(o+=" zp_updated"),o+="' data-zp-author-year='"+i+"-"+l+"'",o+="' data-zp-year-author='"+l+"-"+i+"'",o+=">\n",(t.zpIsAdmin||t.zpShowImages&&a.hasOwnProperty("image"))&&(o+="<div id='zp-Citation-"+a.key+"' class='zp-Entry-Image",a.hasOwnProperty("image")&&(o+=" hasImage"),o+="' rel='"+a.key+"'>\n",a.hasOwnProperty("image")&&(o+="<img class='thumb' src='"+a.image[0]+"' alt='image' />\n"),t.zpIsAdmin&&(a.hasOwnProperty("image")?o+="<a title='Change Image' class='upload' rel='"+a.key+"' href='#'>"+zpShortcodeAJAX.txt_changeimg+"</a>\n":o+="<a title='Set Image' class='upload' rel='"+a.key+"' href='#'>"+zpShortcodeAJAX.txt_setimg+"</a>\n"),t.zpIsAdmin&&a.hasOwnProperty("image")&&(o+="<a title='"+zpShortcodeAJAX.txt_removeimg+"' class='delete' rel='"+a.key+"' href='#'>&times;</a>\n"),o+="</div>\x3c!-- .zp-Entry-Image --\x3e\n"),o+=a.bib,t.zpShowTags&&a.data.tags.length>0&&(o+="<span class='item_key'>Tag(s): ",jQuery.each(a.data.tags,(function(e,t){0!=e&&(o+=", "),o+=t.tag}))),t.zpIsAdmin&&(o+="<label for='item_key'>"+zpShortcodeAJAX.txt_itemkey+":</label><input type='text' name='item_key' class='item_key' value='"+a.key+"'>\n"),o+="</div>\x3c!-- .zp-Entry --\x3e\n",r.length>0&&!0===n?r.replaceWith(jQuery(o)):p+=o})),!1===n&&jQuery(".zpSearchResultsContainer",s).append(p),0!=l.meta.request_next&&"false"!=l.meta.request_next)1==t.zpItemsFlag?window.zpBrowseList[e].paginate(t.zpItemsFlag,!1):window.zpBrowseList[e].paginate(t.zpItemsFlag,!0),t.zpItemsFlag=!1,o(s),i(e,t,s,l.meta.request_next,l.meta.request_last,n);else if(window.zpBrowseList[e].paginate(t.zpItemsFlag),t.zpItemsFlag=!1,jQuery(".zp-List",s).removeClass("loading"),jQuery(".zp-List",s).find(".zp_display_progress").remove(),l.updateneeded)console.log("zp: update needed"),a=!0,i(e,t,s,0,0,!0);else{a=!1;var d=jQuery(".ZP_SORTBY",s).text(),u=jQuery(".ZP_ORDER",s).text();if(-1!==["author","date"].indexOf(d)&&0==jQuery("div.zp-List .csl-left-margin",s).length){var c="data-zp-author-year";"date"==d&&(c="data-zp-year-author"),jQuery("#"+l.instance+" .zp-List div.zp-Entry",s).sort((function(e,t){var a=e.getAttribute(c).toLowerCase(),s=t.getAttribute(c).toLowerCase();return a>s?"asc"==u?1:-1:a<s?"asc"==u?-1:1:0})).detach().appendTo("#"+l.instance+" .zp-List",s)}o(s)}}else jQuery(".zp-List",s).removeClass("loading"),jQuery(".zp-List",s).find(".zp_display_progress").remove(),jQuery(".zpSearchResultsContainer",s).append("<p>"+zpShortcodeAJAX.txt_nocitations+"</p>\n")},error:function(e){console.log("Error for zplib_get_items(): ",e.statusText)}})}}));