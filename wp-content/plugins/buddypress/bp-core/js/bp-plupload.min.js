window.wp=window.wp||{},window.bp=window.bp||{},function(d,o){"undefined"!=typeof BP_Uploader&&(_.extend(d,_.pick(wp,"Backbone","ajax","template")),d.Models=d.Models||{},d.Collections=d.Collections||{},d.Views=d.Views||{},d.Uploader={},d.Uploader.uploader=function(){var n=this,e=-1!==navigator.userAgent.indexOf("Trident/")||-1!==navigator.userAgent.indexOf("MSIE ");this.params=BP_Uploader.settings,this.strings=BP_Uploader.strings,this.supports={upload:this.params.browser.supported},this.supported=this.supports.upload,this.supported?(e||"flash"!==plupload.predictRuntime(this.params.defaults)||this.params.defaults.required_features&&this.params.defaults.required_features.hasOwnProperty("send_binary_string")||(this.params.defaults.required_features=this.params.defaults.required_features||{},this.params.defaults.required_features.send_binary_string=!0),this.uploader=new plupload.Uploader(this.params.defaults),this.uploader.bind("Init",function(e){var i=o("#"+n.params.defaults.container),t=o("#"+n.params.defaults.drop_element);"html4"===e.runtime&&(e.settings.multipart_params.html4=!0),"bp_avatar_upload"===e.settings.multipart_params.action&&(e.settings.multipart_params.bp_params.ui_available_width=i.width()),e.features.dragdrop&&!n.params.browser.mobile?(i.addClass("drag-drop"),t.on("dragover.wp-uploader",function(){i.addClass("drag-over")}),t.on("dragleave.wp-uploader, drop.wp-uploader",function(){i.removeClass("drag-over")})):(i.removeClass("drag-drop"),t.off(".wp-uploader"))}),this.uploader.bind("postinit",function(e){e.refresh()}),this.uploader.init(),this.feedback=function(e,i,t){!_.isNull(t)&&t.item&&t.item.clear(),d.Uploader.filesError.unshift({message:e,data:i,file:t})},this.uploader.bind("FilesAdded",function(t,e){var s=104857600,a=parseInt(t.settings.max_file_size,10),r=this;if(!t.settings.multi_selection&&1<e.length){for(var i in e)t.removeFile(e[i]);o(n).trigger("bp-uploader-warning",n.strings.unique_file_warning)}else _.each(e,function(e){var i;plupload.FAILED!==e.status&&(s<a&&e.size>s&&"html5"!==t.runtime?r.uploadSizeError(t,e,!0):(i=_.extend({id:e.id,file:e,uploading:!0,date:new Date,filename:e.name},_.pick(e,"loaded","size","percent")),e.item=new d.Models.File(i),d.Uploader.filesQueue.add(e.item)))}),t.refresh(),t.start()}),this.uploader.bind("UploadProgress",function(e,i){i.item.set(_.pick(i,"loaded","percent"))}),this.uploader.bind("FileUploaded",function(e,i,t){var s=n.strings.default_error;try{t=JSON.parse(t.response)}catch(e){return n.feedback(s,e,i)}return!_.isObject(t)||_.isUndefined(t.success)?n.feedback(s,null,i):t.success?(_.each(["file","loaded","size","percent"],function(e){i.item.unset(e)}),i.item.set(_.extend(t.data,{uploading:!1})),void d.Uploader.filesUploaded.add(i.item)):(t.data&&t.data.message&&(s=t.data.message),n.feedback(s,t.data,i))}),this.uploader.bind("BeforeUpload",function(e,i){o(n).trigger("bp-uploader-new-upload",e,i)}),this.uploader.bind("UploadComplete",function(e,i){o(n).trigger("bp-uploader-upload-complete",e,i),d.Uploader.filesQueue.reset()}),this.uploader.bind("Error",function(e,i){var t,s=n.strings.default_error,a={FAILED:n.strings.upload_failed,FILE_EXTENSION_ERROR:n.strings.invalid_filetype,IMAGE_FORMAT_ERROR:n.strings.not_an_image,IMAGE_MEMORY_ERROR:n.strings.image_memory_exceeded,IMAGE_DIMENSIONS_ERROR:n.strings.image_dimensions_exceeded,GENERIC_ERROR:n.strings.upload_failed,IO_ERROR:n.strings.io_error,HTTP_ERROR:n.strings.http_error,SECURITY_ERROR:n.strings.security_error,FILE_SIZE_ERROR:n.strings.file_exceeds_size_limit.replace("%s",o("<span />").text(i.file.name).html())};for(t in a)if(i.code===plupload[t]){s=a[t];break}o(n).trigger("bp-uploader-warning",s),e.refresh()})):BP_Uploader=void 0},d.Models.File=Backbone.Model.extend({file:{}}),o.extend(d.Uploader,{filesQueue:new Backbone.Collection,filesUploaded:new Backbone.Collection,filesError:new Backbone.Collection}),d.View=d.Backbone.View.extend({inject:function(e){this.render(),o(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),d.Views.Uploader=d.View.extend({className:"bp-uploader-window",template:d.template("upload-window"),defaults:_.pick(BP_Uploader.settings.defaults,"container","drop_element","browse_button"),initialize:function(){this.warnings=[],this.model=new Backbone.Model(this.defaults),this.on("ready",this.initUploader)},initUploader:function(){this.uploader=new d.Uploader.uploader,o(this.uploader).on("bp-uploader-warning",_.bind(this.setWarning,this)),o(this.uploader).on("bp-uploader-new-upload",_.bind(this.resetWarning,this))},setWarning:function(e,i){_.isUndefined(i)||(i=new d.Views.uploaderWarning({value:i}).render(),this.warnings.push(i),this.$el.after(i.el))},resetWarning:function(){0!==this.warnings.length&&(_.each(this.warnings,function(e){e.remove()}),this.warnings=[])}}),d.Views.uploaderWarning=d.View.extend({tagName:"p",className:"warning",initialize:function(){this.value=this.options.value},render:function(){return this.$el.html(this.value),this}}),d.Views.uploaderStatus=d.View.extend({className:"files",initialize:function(){_.each(this.collection.models,this.addFile,this),this.collection.on("change:percent",this.progress,this),d.Uploader.filesError.on("add",this.feedback,this)},addFile:function(e){this.views.add(new d.Views.uploaderProgress({model:e}))},progress:function(e){_.isUndefined(e.get("percent"))||o("#"+e.get("id")+" .bp-progress .bp-bar").css("width",e.get("percent")+"%")},feedback:function(e){_.isUndefined(e.get("message"))||_.isUndefined(e.get("file"))||o("#"+e.get("file").id).html(e.get("message")).addClass("error")}}),d.Views.uploaderProgress=d.View.extend({className:"bp-uploader-progress",template:d.template("progress-window")}))}(window.bp,jQuery);