window.bp=window.bp||{},function(c,v){"undefined"!=typeof BP_Uploader&&(c.Models=c.Models||{},c.Collections=c.Collections||{},c.Views=c.Views||{},c.Avatar={start:function(){var e=this;this.removeLegacyUI(),this.views=new Backbone.Collection,this.jcropapi={},this.warning=null,this.setupNav(),this.avatars=c.Uploader.filesUploaded,this.Attachment=new Backbone.Model,this.historicAvatars=null,c.Uploader.filesQueue.on("reset",this.cropView,this),v("body.wp-admin").on("tb_unload","#TB_window",function(){e.resetViews()}),v("body.wp-admin").on("click",".bp-members-avatar-user-edit",function(){e.resetViews()})},removeLegacyUI:function(){v("#avatar-upload-form").length?(v("#avatar-upload").remove(),v("#avatar-upload-form p").remove()):v("#group-settings-form").length?(v("#group-settings-form p").each(function(e){0!==e&&v(this).remove()}),v("#delete-group-avatar-button").length&&v("#delete-group-avatar-button").remove()):v("#group-create-body").length?(v(".main-column p #file").remove(),v(".main-column p #upload").remove()):v("#bp_members_user_admin_avatar a.bp-members-avatar-user-admin").length&&v("#bp_members_user_admin_avatar a.bp-members-avatar-user-admin").remove()},setView:function(e){switch(_.isUndefined(this.views.models)||_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset(),_.isUndefined(this.avatars)||this.avatars.reset(),_.isEmpty(this.jcropapi)||(this.jcropapi.destroy(),this.jcropapi={}),e){case"upload":this.uploaderView();break;case"delete":this.deleteView();break;case"recycle":this.recycleView()}},resetViews:function(){this.nav.trigger("bp-avatar-view:changed","upload"),_.each(this.navItems.models,function(e){"upload"===e.id?e.set({active:1}):e.set({active:0})})},setupNav:function(){var a,i,s=this;this.navItems=new Backbone.Collection,_.each(BP_Uploader.settings.nav,function(e,t){_.isObject(e)&&((i=0)===t&&(a=e.id,i=1),s.navItems.add({id:e.id,name:e.caption,href:"#",active:i,hide:_.isUndefined(e.hide)?0:e.hide}))}),this.nav=new c.Views.Nav({collection:this.navItems}),this.nav.inject(".bp-avatar-nav"),this.setView(a),this.nav.on("bp-avatar-view:changed",_.bind(this.setView,this))},uploaderView:function(){c.Uploader.filesQueue.on("add",this.uploadProgress,this);var e=new c.Views.Uploader;this.views.add({id:"upload",view:e}),e.inject(".bp-avatar")},uploadProgress:function(){var e=new c.Views.uploaderStatus({collection:c.Uploader.filesQueue});_.isUndefined(this.views.get("status"))?this.views.add({id:"status",view:e}):this.views.set({id:"status",view:e}),e.inject(".bp-avatar-status")},cropView:function(){var e;_.isEmpty(this.avatars.models)||(_.isUndefined(this.views.get("status"))||((e=this.views.get("status")).get("view").remove(),this.views.remove({id:"status",view:e})),e=new c.Views.Avatars({collection:this.avatars}),this.views.add({id:"crop",view:e}),e.inject(".bp-avatar"))},setAvatar:function(a){var e,i=this;_.isUndefined(this.views.get("crop"))||(_.isEmpty(this.jcropapi)||(this.jcropapi.destroy(),this.jcropapi={}),(e=this.views.get("crop")).get("view").remove(),this.views.remove({id:"crop",view:e})),c.ajax.post("bp_avatar_set",{json:!0,original_file:a.get("url"),crop_w:a.get("w"),crop_h:a.get("h"),crop_x:a.get("x"),crop_y:a.get("y"),item_id:a.get("item_id"),object:a.get("object"),type:_.isUndefined(a.get("type"))?"crop":a.get("type"),nonce:a.get("nonces").set}).done(function(e){var t=new c.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"});i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status"),v("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){v(this).prop("src",e.avatar)}),c.Avatar.navItems.get("delete").set({hide:0}),i.Attachment.set(_.extend(_.pick(a.attributes,["object","item_id"]),{url:e.avatar,action:"uploaded"}))}).fail(function(e){var t=BP_Uploader.strings.default_error;_.isUndefined(e)||(t=BP_Uploader.strings.feedback_messages[e.feedback_code]);t=new c.Views.AvatarStatus({value:t,type:"error"});i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})},deleteView:function(){var e=new Backbone.Model(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces")),e=new c.Views.DeleteAvatar({model:e});this.views.add({id:"delete",view:e}),e.inject(".bp-avatar")},deleteAvatar:function(a){var e,i=this;_.isUndefined(this.views.get("delete"))||((e=this.views.get("delete")).get("view").remove(),this.views.remove({id:"delete",view:e})),c.ajax.post("bp_avatar_delete",{json:!0,item_id:a.get("item_id"),object:a.get("object"),nonce:a.get("nonces").remove}).done(function(e){var t=new c.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"});i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status"),v("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){v(this).prop("src",e.avatar)}),c.Avatar.navItems.get("delete").set({active:0,hide:1}),i.Attachment.set(_.extend(_.pick(a.attributes,["object","item_id"]),{url:e.avatar,action:"deleted"}))}).fail(function(e){var t=BP_Uploader.strings.default_error;_.isUndefined(e)||(t=BP_Uploader.strings.feedback_messages[e.feedback_code]);t=new c.Views.AvatarStatus({value:t,type:"error"});i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})},removeWarning:function(){_.isNull(this.warning)||this.warning.remove()},displayWarning:function(e){this.removeWarning(),this.warning=new c.Views.uploaderWarning({value:e}),this.warning.inject(".bp-avatar-status")},recycleView:function(){this.historicAvatars||(this.historicAvatars=new Backbone.Collection(BP_Uploader.settings.history));var e=new c.Views.RecycleAvatar({collection:this.historicAvatars});this.views.add({id:"recycle",view:e}),e.inject(".bp-avatar")},recycleHistoricAvatar:function(a){var i=this;a.set("selected",!1),c.ajax.post("bp_avatar_recycle_previous",{json:!0,item_id:BP_Uploader.settings.defaults.multipart_params.bp_params.item_id,avatar_id:a.get("id"),object:BP_Uploader.settings.defaults.multipart_params.bp_params.object,nonce:BP_Uploader.settings.historyNonces.recylePrevious}).done(function(e){var t;e.historicalAvatar&&a.collection.add(e.historicalAvatar),a.collection.remove(a),e.feedback_code&&(t=new c.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"}),i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")),v("."+BP_Uploader.settings.defaults.multipart_params.bp_params.object+"-"+e.item_id+"-avatar").each(function(){v(this).prop("src",e.avatar)})}).fail(function(e){var t=BP_Uploader.strings.default_error;e&&e.message&&(t=e.message);t=new c.Views.AvatarStatus({value:t,type:"error"});i.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})},deletePreviousAvatar:function(t){var a=this;t.set("selected",!1),c.ajax.post("bp_avatar_delete_previous",{json:!0,item_id:BP_Uploader.settings.defaults.multipart_params.bp_params.item_id,avatar_id:t.get("id"),object:BP_Uploader.settings.defaults.multipart_params.bp_params.object,nonce:BP_Uploader.settings.historyNonces.deletePrevious}).done(function(e){t.collection.remove(t),e.feedback_code&&(e=new c.Views.AvatarStatus({value:BP_Uploader.strings.feedback_messages[e.feedback_code],type:"success"}),a.views.add({id:"status",view:e}),e.inject(".bp-avatar-status"))}).fail(function(e){var t=BP_Uploader.strings.default_error;e&&e.message&&(t=e.message);t=new c.Views.AvatarStatus({value:t,type:"error"});a.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})}},c.Views.Nav=c.View.extend({tagName:"ul",className:"avatar-nav-items",events:{"click .bp-avatar-nav-item":"toggleView"},initialize:function(){1!==_.findWhere(this.collection.models,{id:"delete"}).get("hide")&&c.Avatar.displayWarning(BP_Uploader.strings.has_avatar_warning),_.each(this.collection.models,this.addNavItem,this),this.collection.on("change:hide",this.showHideNavItem,this)},addNavItem:function(e){1!==e.get("hide")&&this.views.add(new c.Views.NavItem({model:e}))},showHideNavItem:function(t){var a=null;_.each(this.views._views[""],function(e){1===e.model.get("hide")&&e.remove(),t.get("id")===e.model.get("id")&&(a=!0)}),_.isBoolean(a)||this.addNavItem(t)},toggleView:function(e){e.preventDefault(),c.Avatar.removeWarning();var t=v(e.target).data("nav");_.each(this.collection.models,function(e){e.id===t?(e.set({active:1}),this.trigger("bp-avatar-view:changed",e.id)):e.set({active:0})},this)}}),c.Views.NavItem=c.View.extend({tagName:"li",className:"avatar-nav-item",template:c.template("bp-avatar-nav"),initialize:function(){1===this.model.get("active")&&(this.el.className+=" current"),this.el.id+="bp-avatar-"+this.model.get("id"),this.model.on("change:active",this.setCurrentNav,this)},setCurrentNav:function(e){1===e.get("active")?this.$el.addClass("current"):this.$el.removeClass("current")}}),c.Views.Avatars=c.View.extend({className:"items",initialize:function(){_.each(this.collection.models,this.addItemView,this)},addItemView:function(e){var t={full_h:150,full_w:150};_.isUndefined(BP_Uploader.settings.crop.full_h)||_.isUndefined(BP_Uploader.settings.crop.full_w)||(t.full_h=BP_Uploader.settings.crop.full_h,t.full_w=BP_Uploader.settings.crop.full_w),e.set(_.extend(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces"),t)),this.views.add(new c.Views.Avatar({model:e}))}}),c.Views.Avatar=c.View.extend({className:"item",template:c.template("bp-avatar-item"),events:{"click .avatar-crop-submit":"cropAvatar"},initialize:function(){_.defaults(this.options,{full_h:BP_Uploader.settings.crop.full_h,full_w:BP_Uploader.settings.crop.full_w,aspectRatio:1}),!1!==this.model.get("feedback")&&c.Avatar.displayWarning(this.model.get("feedback")),this.on("ready",this.initCropper)},initCropper:function(){var e,t,a,i,s,n,r=this,o=this.$el.find("#avatar-to-crop img"),d=this.$el.width(),l={};_.isUndefined(this.options.full_h)||_.isUndefined(this.options.full_w)||(this.options.aspectRatio=this.options.full_w/this.options.full_h),l.w=this.model.get("width"),l.h=this.model.get("height"),this.options.full_w+l.w+20<d&&(v("#avatar-to-crop").addClass("adjust"),this.$el.find(".avatar-crop-management").addClass("adjust")),l.h<=l.w?(e=Math.round(l.h/4),t=(s=n=Math.round(l.h/2))+e,i=n+(a=(l.w-n)/2)):(a=Math.round(l.w/4),s=n=Math.round(l.w/2),i=n+a,t=s+(e=(l.h-s)/2)),o.Jcrop({onChange:_.bind(r.showPreview,r),onSelect:_.bind(r.showPreview,r),aspectRatio:r.options.aspectRatio,setSelect:[a,e,i,t]},function(){c.Avatar.jcropapi=this})},cropAvatar:function(e){e.preventDefault(),c.Avatar.setAvatar(this.model)},showPreview:function(e){var t,a;e.w&&e.h&&0<parseInt(e.w,10)&&(t=this.options.full_w,a=this.options.full_h,t=t/e.w,a=a/e.h,this.model.set({x:e.x,y:e.y,w:e.w,h:e.h}),v("#avatar-crop-preview").css({maxWidth:"none",width:Math.round(t*this.model.get("width"))+"px",height:Math.round(a*this.model.get("height"))+"px",marginLeft:"-"+Math.round(t*this.model.get("x"))+"px",marginTop:"-"+Math.round(a*this.model.get("y"))+"px"}))}}),c.Views.AvatarStatus=c.View.extend({tagName:"p",className:"updated",id:"bp-avatar-feedback",initialize:function(){this.el.className+=" "+this.options.type,this.value=this.options.value},render:function(){return this.$el.html(this.value),this}}),c.Views.DeleteAvatar=c.View.extend({tagName:"div",id:"bp-delete-avatar-container",template:c.template("bp-avatar-delete"),events:{"click #bp-delete-avatar":"deleteAvatar"},deleteAvatar:function(e){e.preventDefault(),c.Avatar.deleteAvatar(this.model)}}),c.Views.HistoryAvatarsItem=c.View.extend({tagName:"tr",className:"historic-avatar",template:c.template("bp-avatar-recycle-history-item"),events:{'change input[name="avatar_id"]':"selectAvatar"},initialize:function(){this.model.on("change:selected",this.toggleSelection,this),this.model.on("remove",this.clearView,this)},toggleSelection:function(e,t){!0===t?this.$el.parent().find("#"+e.get("id")).addClass("selected"):(this.$el.parent().find("#"+e.get("id")).removeClass("selected"),this.$el.parent().find("#avatar_"+e.get("id")).prop("checked",!1))},selectAvatar:function(e){var t;e.preventDefault(),e.currentTarget.checked&&(t=this,_.each(this.model.collection.models,function(e){t.$el.parent().find("#"+e.id).removeClass("selected"),e.set("selected",!1,{silent:!0})}),this.model.set("selected",!0))},clearView:function(){this.views.view.remove()}}),c.Views.RecycleAvatar=c.View.extend({tagName:"div",id:"bp-avatars-history-container",template:c.template("bp-avatar-recycle"),events:{"click button.avatar-history-action":"doAvatarAction"},initialize:function(){_.each(this.collection.models,function(e){this.views.add("#bp-avatars-history-list",new c.Views.HistoryAvatarsItem({model:e}))},this),this.collection.on("change:selected",this.updateButtonStatus,this),this.collection.on("add",this.addView,this)},addView:function(e){this.views.add("#bp-avatars-history-list",new c.Views.HistoryAvatarsItem({model:e}))},updateButtonStatus:function(e){!0===e.get("selected")&&this.$el.find("button.disabled").removeClass("disabled")},doAvatarAction:function(e){e.preventDefault();var t=e.currentTarget.classList,e=this.collection.findWhere({selected:!0});!t.contains("disabled")&&e&&(this.$el.find("button.avatar-history-action").addClass("disabled"),t.contains("recycle")?c.Avatar.recycleHistoricAvatar(e):t.contains("delete")&&c.Avatar.deletePreviousAvatar(e))}}),c.Avatar.start())}(window.bp,jQuery);