window.bp=window.bp||{},function(t){"undefined"!=typeof BP_Uploader&&(t.Models=t.Models||{},t.Collections=t.Collections||{},t.Views=t.Views||{},t.WebCam={start:function(){this.params={video:null,videoStream:null,capture_enable:!1,capture:null,canvas:null,warning:null,flipped:!1},t.Avatar.nav.on("bp-avatar-view:changed",_.bind(this.setView,this))},setView:function(e){"camera"===e?(e=new t.Views.WebCamAvatar({model:new Backbone.Model({user_media:!1})}),this.params.flipped=!1,t.Avatar.views.add({id:"camera",view:e}),e.inject(".bp-avatar")):_.isNull(this.params.video)||(this.stop(),this.removeWarning())},removeView:function(){var e;_.isUndefined(t.Avatar.views.get("camera"))||((e=t.Avatar.views.get("camera")).get("view").remove(),t.Avatar.views.remove({id:"camera",view:e}))},gotStream:function(e){var a=t.WebCam.params.video;t.WebCam.params.videoStream=e,t.WebCam.displayWarning("loaded"),a.onerror=function(){t.WebCam.displayWarning("videoerror"),a&&t.WebCam.stop()},e.onended=t.WebCam.noStream(),"srcObject"in a?a.srcObject=e:a.src=window.URL.createObjectURL(e),a.onloadedmetadata=function(){a.play()},t.WebCam.params.capture_enable=!0},stop:function(){t.WebCam.params.capture_enable=!1,t.WebCam.params.videoStream&&(t.WebCam.params.videoStream.stop?t.WebCam.params.videoStream.stop():t.WebCam.params.videoStream.msStop&&t.WebCam.params.videoStream.msStop(),t.WebCam.params.videoStream.onended=null,t.WebCam.params.videoStream=null),t.WebCam.params.video&&(t.WebCam.params.video.onerror=null,t.WebCam.params.video.pause(),t.WebCam.params.video.mozSrcObject&&(t.WebCam.params.video.mozSrcObject=null),t.WebCam.params.video.src="")},noStream:function(){_.isNull(t.WebCam.params.videoStream)&&(t.WebCam.displayWarning("noaccess"),t.WebCam.removeView())},setAvatar:function(e){e.get("url")||t.WebCam.displayWarning("nocapture"),t.WebCam.removeView(),t.Avatar.setAvatar(e)},removeWarning:function(){_.isNull(this.params.warning)||this.params.warning.remove()},displayWarning:function(e){this.removeWarning(),this.params.warning=new t.Views.uploaderWarning({value:BP_Uploader.strings.camera_warnings[e]}),this.params.warning.inject(".bp-avatar-status")}},t.Views.WebCamAvatar=t.View.extend({tagName:"div",id:"bp-webcam-avatar",template:t.template("bp-avatar-webcam"),events:{"click .avatar-webcam-capture":"captureStream","click .avatar-webcam-save":"saveCapture"},initialize:function(){var e;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.oGetUserMedia,void 0!==navigator.getUserMedia&&(e=_.extend(_.pick(BP_Uploader.settings.defaults.multipart_params.bp_params,"object","item_id","nonces"),{user_media:!0,w:BP_Uploader.settings.crop.full_w,h:BP_Uploader.settings.crop.full_h,x:0,y:0,type:"camera"}),this.model.set(e)),this.on("ready",this.useStream,this)},useStream:function(){this.model.get("user_media")&&(this.options.video=new t.Views.WebCamVideo,this.options.canvas=new t.Views.WebCamCanvas,this.$el.find("#avatar-to-crop").append(this.options.video.el),this.$el.find("#avatar-crop-pane").append(this.options.canvas.el),t.WebCam.params.video=this.options.video.el,t.WebCam.params.canvas=this.options.canvas.el,t.WebCam.displayWarning("requesting"),void 0===navigator.mediaDevices.getUserMedia?navigator.getUserMedia({audio:!1,video:!0},t.WebCam.gotStream,t.WebCam.noStream):navigator.mediaDevices.getUserMedia({audio:!1,video:!0}).then(t.WebCam.gotStream,t.WebCam.noStream).catch(function(){t.WebCam.displayWarning("errormsg")}))},captureStream:function(e){var a;e.preventDefault(),t.WebCam.params.capture_enable?this.model.get("h")>this.options.video.el.videoHeight||this.model.get("w")>this.options.video.el.videoWidth?t.WebCam.displayWarning("videoerror"):(a=this.options.video.el.videoHeight,e=(this.options.video.el.videoWidth-a)/2,t.WebCam.params.flipped||(this.options.canvas.el.getContext("2d").translate(this.model.get("w"),0),this.options.canvas.el.getContext("2d").scale(-1,1),t.WebCam.params.flipped=!0),this.options.canvas.el.getContext("2d").drawImage(this.options.video.el,e,0,a,a,0,0,this.model.get("w"),this.model.get("h")),t.WebCam.params.capture=this.options.canvas.el.toDataURL("image/png"),this.model.set("url",t.WebCam.params.capture),t.WebCam.displayWarning("ready")):t.WebCam.displayWarning("loading")},saveCapture:function(e){e.preventDefault(),t.WebCam.params.capture?(t.WebCam.stop(),t.WebCam.setAvatar(this.model)):t.WebCam.displayWarning("nocapture")}}),t.Views.WebCamVideo=t.View.extend({tagName:"video",id:"bp-webcam-video",attributes:{autoplay:"autoplay"}}),t.Views.WebCamCanvas=t.View.extend({tagName:"canvas",id:"bp-webcam-canvas",attributes:{width:150,height:150},initialize:function(){_.isUndefined(BP_Uploader.settings.crop.full_h)||_.isUndefined(BP_Uploader.settings.crop.full_w)||(this.el.attributes.width.value=BP_Uploader.settings.crop.full_w,this.el.attributes.height.value=BP_Uploader.settings.crop.full_h)}}),t.WebCam.start())}(window.bp);