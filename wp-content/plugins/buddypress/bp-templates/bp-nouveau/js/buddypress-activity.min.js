window.bp=window.bp||{},function(o,g){"undefined"!=typeof BP_Nouveau&&(o.Nouveau=o.Nouveau||{},o.Nouveau.Activity={start:function(){this.setupGlobals(),this.addListeners()},setupGlobals:function(){this.just_posted=[],this.current_page=1,this.mentions_count=Number(g(o.Nouveau.objectNavParent+' [data-bp-scope="mentions"]').find("a span").html())||0,this.heartbeat_data={newest:"",highlights:{},last_recorded:0,first_recorded:0,document_title:g(document).prop("title")}},addListeners:function(){g("#buddypress").on("bp_heartbeat_send",this.heartbeatSend.bind(this)),g("#buddypress").on("bp_heartbeat_tick",this.heartbeatTick.bind(this)),g('#buddypress [data-bp-list="activity"]').on("click","li.load-newest, li.load-more",this.injectActivities.bind(this)),g("#buddypress [data-bp-list]").on("bp_ajax_request",this.updateRssLink),g("#buddypress").on("bp_ajax_request",'[data-bp-list="activity"]',this.scopeLoaded.bind(this)),g('#buddypress [data-bp-list="activity"]').on("bp_ajax_append",this.hideComments),g('#buddypress [data-bp-list="activity"]').on("click",".show-all",this.showComments),g('#buddypress [data-bp-list="activity"]').on("click",".activity-item",o.Nouveau,this.activityActions),g(document).on("keydown",this.commentFormAction)},heartbeatSend:function(t,a){this.heartbeat_data.first_recorded=g("#buddypress [data-bp-list] [data-bp-activity-id]").first().data("bp-timestamp")||0,(0===this.heartbeat_data.last_recorded||this.heartbeat_data.first_recorded>this.heartbeat_data.last_recorded)&&(this.heartbeat_data.last_recorded=this.heartbeat_data.first_recorded),a.bp_activity_last_recorded=this.heartbeat_data.last_recorded,g("#buddypress .dir-search input[type=search]").length&&(a.bp_activity_last_recorded_search_terms=g("#buddypress .dir-search input[type=search]").val()),g.extend(a,{bp_heartbeat:o.Nouveau.getStorage("bp-activity")})},heartbeatTick:function(t,a){var e,i,s=o.Nouveau.objects,n=o.Nouveau.getStorage("bp-activity","scope"),d=this;void 0!==a&&a.bp_activity_newest_activities&&(this.heartbeat_data.newest=g.trim(a.bp_activity_newest_activities.activities)+this.heartbeat_data.newest,this.heartbeat_data.last_recorded=Number(a.bp_activity_newest_activities.last_recorded),i=g(this.heartbeat_data.newest).filter(".activity-item"),e=Number(i.length),s.push("mentions"),"all"===n?(g.each(i,function(t,e){e=g(e),g.each(s,function(t,a){-1!==g.inArray("bp-my-"+a,e.get(0).classList)&&(void 0===d.heartbeat_data.highlights[a]?d.heartbeat_data.highlights[a]=[e.data("bp-activity-id")]:-1===g.inArray(e.data("bp-activity-id"),d.heartbeat_data.highlights[a])&&d.heartbeat_data.highlights[a].push(e.data("bp-activity-id")))})}),a=new RegExp("bp-my-("+s.join("|")+")","g"),this.heartbeat_data.newest=this.heartbeat_data.newest.replace(a,""),g(o.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(e)):(this.heartbeat_data.highlights[n]=[],g.each(i,function(t,a){d.heartbeat_data.highlights[n].push(g(a).data("bp-activity-id"))})),g.each(s,function(t,a){var e;void 0!==d.heartbeat_data.highlights[a]&&d.heartbeat_data.highlights[a].length&&(e=0,"mentions"===a&&(e=d.mentions_count),g(o.Nouveau.objectNavParent+' [data-bp-scope="'+a+'"]').find("a span").html(Number(d.heartbeat_data.highlights[a].length)+e))}),s.pop(),g(document).prop("title","("+e+") "+this.heartbeat_data.document_title),g('#buddypress [data-bp-list="activity"] li').first().hasClass("load-newest")?(i=g('#buddypress [data-bp-list="activity"] .load-newest a').html(),g('#buddypress [data-bp-list="activity"] .load-newest a').html(i.replace(/([0-9]+)/,e))):g('#buddypress [data-bp-list="activity"] ul.activity-list').prepend('<li class="load-newest"><a href="#newest">'+BP_Nouveau.newest+" ("+e+")</a></li>"),g('#buddypress [data-bp-list="activity"]').trigger("bp_heartbeat_pending",this.heartbeat_data))},injectActivities:function(a){var e,i,t,s=o.Nouveau.getStorage("bp-activity"),n=s.scope||null,s=s.filter||null;g(a.currentTarget).hasClass("load-newest")?(a.preventDefault(),g(a.currentTarget).remove(),t=g.parseHTML(this.heartbeat_data.newest),g.each(t,function(t,a){"LI"===a.nodeName&&g(a).hasClass("just-posted")&&g("#"+g(a).prop("id")).length&&g("#"+g(a).prop("id")).remove()}),g(a.delegateTarget).find(".activity-list").prepend(this.heartbeat_data.newest).trigger("bp_heartbeat_prepend",this.heartbeat_data),this.heartbeat_data.newest="","all"===n&&g(o.Nouveau.objectNavParent+' [data-bp-scope="all"]').find("a span").html(""),"mentions"===n&&(o.Nouveau.ajax({action:"activity_clear_new_mentions"},"activity"),this.mentions_count=0),g(o.Nouveau.objectNavParent+' [data-bp-scope="'+n+'"]').find("a span").html(""),void 0!==this.heartbeat_data.highlights[n]&&(this.heartbeat_data.highlights[n]=[]),setTimeout(function(){g(a.delegateTarget).find("[data-bp-activity-id]").removeClass("newest_"+n+"_activity")},3e3),g(document).prop("title",this.heartbeat_data.document_title)):g(a.currentTarget).hasClass("load-more")&&(e=+Number(this.current_page)+1,i=this,t="",a.preventDefault(),g(a.currentTarget).find("a").first().addClass("loading"),this.just_posted=[],g(a.delegateTarget).children(".just-posted").each(function(){i.just_posted.push(g(this).data("bp-activity-id"))}),g("#buddypress .dir-search input[type=search]").length&&(t=g("#buddypress .dir-search input[type=search]").val()),o.Nouveau.objectRequest({object:"activity",scope:n,filter:s,search_terms:t,page:e,method:"append",exclude_just_posted:this.just_posted.join(","),target:"#buddypress [data-bp-list] ul.bp-list"}).done(function(t){!0===t.success&&(g(a.currentTarget).remove(),i.current_page=e)}))},hideComments:function(t){var e,i,s,n,t=g(t.target).find(".activity-comments");t.length&&t.each(function(t,a){n=g(a).children("ul"),(i=g(n).find("li")).length&&(e=g(a).closest(".activity-item"),s=g("#acomment-comment-"+e.data("bp-activity-id")+" span.comment-count").html()||" ",i.each(function(t,a){t<i.length-5&&(g(a).addClass("bp-hidden").hide(),t||void 0!==(t=e.data("bpActivityId"))&&(t=parseInt(t,10),g(a).before('<li class="show-all"><button class="text-button" type="button" data-bp-show-comments-id="#activity-'+t+'/show-all/"><span class="icon dashicons dashicons-visibility" aria-hidden="true"></span> '+BP_Nouveau.show_x_comments.replace("%d",s)+"</button></li>")))}),g(n).children(".bp-hidden").length===g(n).children("li").length-1&&g(n).find("li.show-all").length&&g(n).children("li").removeClass("bp-hidden").toggle())})},showComments:function(t){t.preventDefault(),g(t.target).addClass("loading"),setTimeout(function(){g(t.target).closest("ul").find("li").removeClass("bp-hidden").fadeIn(300,function(){g(t.target).parent("li").remove()})},600)},scopeLoaded:function(t,e){this.hideComments(t),this.current_page=1,"mentions"===e.scope&&void 0!==e.response.new_mentions?(g.each(e.response.new_mentions,function(t,a){g("#buddypress #activity-stream").find('[data-bp-activity-id="'+a+'"]').addClass("newest_mentions_activity")}),this.mentions_count=0):void 0!==this.heartbeat_data.highlights[e.scope]&&this.heartbeat_data.highlights[e.scope].length&&g.each(this.heartbeat_data.highlights[e.scope],function(t,a){g("#buddypress #activity-stream").find('[data-bp-activity-id="'+a+'"]').length&&g("#buddypress #activity-stream").find('[data-bp-activity-id="'+a+'"]').addClass("newest_"+e.scope+"_activity")}),this.heartbeat_data.newest="",g.each(g(o.Nouveau.objectNavParent+" [data-bp-scope]").find("a span"),function(t,a){0===parseInt(g(a).html(),10)&&g(a).html("")}),void 0!==this.heartbeat_data.highlights[e.scope]&&(this.heartbeat_data.highlights[e.scope]=[]),g(document).prop("title",this.heartbeat_data.document_title),setTimeout(function(){g("#buddypress #activity-stream .activity-item").removeClass("newest_"+e.scope+"_activity")},3e3)},activityActions:function(t){var e,i,s,n=t.data,d=g(t.target),o=g(t.currentTarget),a=o.data("bp-activity-id"),r=g(t.delegateTarget);if(((d=g(d).is("span")?g(d).closest("a"):d).hasClass("fav")||d.hasClass("unfav"))&&(e=d.hasClass("fav")?"fav":"unfav",t.preventDefault(),d.addClass("loading"),n.ajax({action:"activity_mark_"+e,id:a},"activity").done(function(t){var a;d.removeClass("loading"),!1!==t.success&&(d.fadeOut(200,function(){(g(this).find("span").first().length?g(this).find("span").first():g(this)).html(t.data.content),g(this).attr("data-bp-tooltip",t.data.content),"false"===g(this).attr("aria-pressed")?g(this).attr("aria-pressed","true"):g(this).attr("aria-pressed","false"),g(this).fadeIn(200)}),"fav"==e?(void 0!==t.data.directory_tab&&(g(n.objectNavParent+' [data-bp-scope="favorites"]').length||g(n.objectNavParent+' [data-bp-scope="all"]').after(t.data.directory_tab)),d.removeClass("fav"),d.addClass("unfav")):"unfav"==e&&((a=g('[data-bp-user-scope="favorites"]').hasClass("selected")||g(n.objectNavParent+' [data-bp-scope="favorites"]').hasClass("selected"))&&o.remove(),void 0!==t.data.no_favorite&&(g(n.objectNavParent+' [data-bp-scope="all"]').length&&g(n.objectNavParent+' [data-bp-scope="all"]').hasClass("selected")?g(n.objectNavParent+' [data-bp-scope="favorites"]').remove():a&&r.append(t.data.no_favorite)),d.removeClass("unfav"),d.addClass("fav")))})),d.hasClass("delete-activity")||d.hasClass("acomment-delete")||d.hasClass("spam-activity")||d.hasClass("spam-activity-comment")){var c,l,h,p,u=d.closest("[data-bp-activity-comment-id]"),m=u.data("bp-activity-comment-id"),v=0;if(t.preventDefault(),void 0!==BP_Nouveau.confirm&&!1===window.confirm(BP_Nouveau.confirm))return!1;d.addClass("loading");var b={action:"delete_activity",id:a,_wpnonce:n.getLinkParams(d.prop("href"),"_wpnonce"),is_single:d.closest("[data-bp-single]").length};(d.hasClass("spam-activity")||d.hasClass("spam-activity-comment"))&&(b.action="bp_spam_activity"),c=o,m&&(delete b.is_single,b.id=m,b.is_comment=!0,c=u),n.ajax(b,"activity").done(function(t){if(d.removeClass("loading"),!1===t.success)c.prepend(t.data.feedback),c.find(".bp-feedback").hide().fadeIn(300);else{if(t.data.redirect)return window.location.href=t.data.redirect;m&&(v=1,o.append(u.find("form")),g.each(u.find("li"),function(){v+=1}),l=o.find(".acomment-reply span.comment-count"),h=Number(l.html()-v),l.html(h),(p=o.find("li.show-all a")).length&&p.html(BP_Nouveau.show_x_comments.replace("%d",h)),0===h&&o.removeClass("has-comments")),c.slideUp(300,function(){c.remove()}),m||o.data("bp-timestamp")!==n.Activity.heartbeat_data.last_recorded||(n.Activity.heartbeat_data.newest="",n.Activity.heartbeat_data.last_recorded=0)}})}if(d.closest("span").hasClass("activity-read-more")){var _=d.closest("div"),f=d.closest("span"),y=null;if(g(_).hasClass("activity-inner")?y=a:g(_).hasClass("acomment-content")&&(y=d.closest("li").data("bp-activity-comment-id")),!y)return t;t.preventDefault(),g(f).addClass("loading"),n.ajax({action:"get_single_activity_content",id:y},"activity").done(function(t){g(f).removeClass("loading"),_.parent().find(".bp-feedback").length&&_.parent().find(".bp-feedback").remove(),!1===t.success?(_.after(t.data.feedback),_.parent().find(".bp-feedback").hide().fadeIn(300)):g(_).slideUp(300).html(t.data.contents).slideDown(300)})}(d.hasClass("acomment-reply")||d.parent().hasClass("acomment-reply"))&&(i=g("#ac-form-"+a),y=a,t.preventDefault(),d.parent().hasClass("acomment-reply")&&d.parent(),d.closest("li").data("bp-activity-comment-id")&&(y=d.closest("li").data("bp-activity-comment-id")),i.removeClass("root"),g(".ac-form").hide(),g.each(i.children("div"),function(t,a){g(a).hasClass("error")&&g(a).remove()}),y===a?(g('[data-bp-activity-id="'+y+'"] .activity-comments').append(i),i.addClass("root")):g('[data-bp-activity-comment-id="'+y+'"]').append(i),i.slideDown(200),d.attr("aria-expanded","true"),g.scrollTo(i,500,{offset:-100,easing:"swing"}),g("#ac-form-"+a+" textarea").trigger("focus")),d.hasClass("ac-reply-cancel")&&(g(d).closest(".ac-form").slideUp(200),g(".acomment-reply").attr("aria-expanded","false"),t.preventDefault()),"ac_form_submit"===d.prop("name")&&(i=d.closest("form"),y=a,t.preventDefault(),d.closest("li").data("bp-activity-comment-id")&&(y=d.closest("li").data("bp-activity-comment-id")),s=g(i).find("textarea").first(),d.addClass("loading").prop("disabled",!0),s.addClass("loading").prop("disabled",!0),y={action:"new_activity_comment",_wpnonce_new_activity_comment:g("#_wpnonce_new_activity_comment_"+a).val(),comment_id:y,form_id:a,content:s.val()},g("#_bp_as_nonce_"+a).val()&&(y["_bp_as_nonce_"+a]=g("#_bp_as_nonce_"+a).val()),n.ajax(y,"activity").done(function(t){var a,e;d.removeClass("loading"),s.removeClass("loading"),g(".acomment-reply").attr("aria-expanded","false"),!1===t.success?i.append(g(t.data.feedback).hide().fadeIn(200)):(a=i.parent(),e=g.trim(t.data.contents),i.fadeOut(200,function(){0===a.children("ul").length&&(a.hasClass("activity-comments")?a.prepend("<ul></ul>"):a.append("<ul></ul>")),a.children("ul").append(g(e).hide().fadeIn(200)),g(i).find("textarea").first().val(""),a.parent().addClass("has-comments")}),h=Number(g(o).find("a span.comment-count").html()||0)+1,g(o).find("a span.comment-count").html(h),(p=g(o).find(".show-all a"))&&p.html(BP_Nouveau.show_x_comments.replace("%d",h))),d.prop("disabled",!1),s.prop("disabled",!1)}))},commentFormAction:function(t){var a,e;return(t=t||window.event).target?a=t.target:t.srcElement&&(a=t.srcElement),3===a.nodeType&&(a=a.parentNode),!0!==t.altKey&&!0!==t.metaKey&&"TEXTAREA"===a.tagName&&g(a).hasClass("ac-input")?void(27===(e=t.keyCode||t.which)&&!1===t.ctrlKey?"TEXTAREA"===a.tagName&&g(a).closest("form").slideUp(200):t.ctrlKey&&13===e&&g(a).val()&&g(a).closest("form").find("[type=submit]").first().trigger("click")):t},updateRssLink:function(t,a){a=a.response.feed_url||"";a&&g("body:not(.bp-user) #activity-rss-feed").length&&g("#activity-rss-feed").find("a").first().prop("href",a)}},o.Nouveau.Activity.start())}(window.bp,jQuery);