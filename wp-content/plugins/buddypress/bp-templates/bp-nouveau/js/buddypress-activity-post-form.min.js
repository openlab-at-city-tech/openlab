window.wp=window.wp||{},window.bp=window.bp||{},function(n,c){n.Nouveau=n.Nouveau||{},void 0!==n.Nouveau.Activity&&"undefined"!=typeof BP_Nouveau&&(_.extend(n,_.pick(wp,"Backbone","ajax","template")),n.Models=n.Models||{},n.Collections=n.Collections||{},n.Views=n.Views||{},n.Nouveau.Activity.postForm={start:function(){this.views=new Backbone.Collection,this.ActivityObjects=new n.Collections.ActivityObjects,this.buttons=new Backbone.Collection,this.postFormView()},postFormView:function(){var e;c("#bp-nouveau-activity-form").length&&(e=new n.Views.PostForm,this.views.add({id:"post_form",view:e}),e.inject("#bp-nouveau-activity-form"))}},void 0===n.View&&(n.View=n.Backbone.View.extend({inject:function(e){this.render(),c(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}})),n.Models.Activity=Backbone.Model.extend({defaults:{user_id:0,item_id:0,object:"",content:""}}),n.Models.ActivityObject=Backbone.Model.extend({defaults:{id:0,name:"",avatar_url:"",object_type:"group"}}),n.Collections.ActivityObjects=Backbone.Collection.extend({model:n.Models.ActivityObject,sync:function(e,t,i){if("read"===e)return(i=i||{}).context=this,i.data=_.extend(i.data||{},{action:"bp_nouveau_get_activity_objects"}),n.ajax.send(i)},parse:function(e){return e=_.isArray(e)?e:[e]}}),n.Views.activityFeedback=n.View.extend({tagName:"div",id:"message",template:n.template("activity-post-form-feedback"),initialize:function(){this.model=new Backbone.Model,this.options.value&&this.model.set("message",this.options.value,{silent:!0}),this.type="info",_.isUndefined(this.options.type)||"info"===this.options.type||(this.type=this.options.type),this.el.className="bp-messages bp-feedback "+this.type}}),n.Views.ActivityInput=n.View.extend({tagName:"input",attributes:{type:"text"},initialize:function(){_.isObject(this.options)&&_.each(this.options,function(e,t){this.$el.prop(t,e)},this)}}),n.Views.WhatsNew=n.View.extend({tagName:"textarea",className:"bp-suggestions",id:"whats-new",attributes:{name:"whats-new",cols:"50",rows:"4",placeholder:BP_Nouveau.activity.strings.whatsnewPlaceholder,"aria-label":BP_Nouveau.activity.strings.whatsnewLabel},initialize:function(){this.on("ready",this.adjustContent,this),this.options.activity.on("change:content",this.resetContent,this)},adjustContent:function(){this.$el.css({resize:"none",height:"50px"});var e=n.Nouveau.getLinkParams(null,"r")||null;_.isNull(e)||(this.$el.text("@"+_.escape(e)+" "),this.$el.focus())},resetContent:function(e){_.isUndefined(e)||this.$el.val(e.get("content"))}}),n.Views.WhatsNewPostIn=n.View.extend({tagName:"select",id:"whats-new-post-in",attributes:{name:"whats-new-post-in","aria-label":BP_Nouveau.activity.strings.whatsnewpostinLabel},events:{change:"change"},keys:[],initialize:function(){this.model=new Backbone.Model,this.filters=this.options.filters||{},this.$el.html(_.chain(this.filters).map(function(e,t){return{el:c("<option></option>").val(t).html(e.text)[0],priority:e.priority||50}},this).sortBy("priority").pluck("el").value())},change:function(){var e=this.filters[this.el.value];e&&this.model.set({selected:this.el.value,placeholder:e.autocomplete_placeholder})}}),n.Views.Item=n.View.extend({tagName:"li",className:"bp-activity-object",template:n.template("activity-target-item"),attributes:{role:"checkbox"},initialize:function(){this.model.get("selected")&&(this.el.className+=" selected")},events:{click:"setObject"},setObject:function(e){e.preventDefault(),!0===this.model.get("selected")?this.model.clear():this.model.set("selected",!0)}}),n.Views.AutoComplete=n.View.extend({tagName:"ul",id:"whats-new-post-in-box-items",events:{keyup:"autoComplete"},initialize:function(){var e=new n.Views.ActivityInput({type:"text",id:"activity-autocomplete",placeholder:this.options.placeholder||""}).render();this.$el.prepend(c("<li></li>").html(e.$el)),this.on("ready",this.setFocus,this),this.collection.on("add",this.addItemView,this),this.collection.on("reset",this.cleanView,this)},setFocus:function(){this.$el.find("#activity-autocomplete").focus()},addItemView:function(e){this.views.add(new n.Views.Item({model:e}))},autoComplete:function(){var e=c("#activity-autocomplete").val();this.collection.reset(),e.length<2||this.collection.fetch({data:{type:this.options.type,search:e,nonce:BP_Nouveau.nonces.activity},success:_.bind(this.itemFetched,this),error:_.bind(this.itemFetched,this)})},itemFetched:function(e){e.length||this.cleanView()},cleanView:function(){_.each(this.views._views[""],function(e){e.remove()})}}),n.Views.FormAvatar=n.View.extend({tagName:"div",id:"whats-new-avatar",template:n.template("activity-post-form-avatar"),initialize:function(){this.model=new Backbone.Model(_.pick(BP_Nouveau.activity.params,["user_id","avatar_url","avatar_width","avatar_height","avatar_alt","user_domain"])),this.model.has("avatar_url")&&this.model.set("display_avatar",!0)}}),n.Views.FormContent=n.View.extend({tagName:"div",id:"whats-new-content",initialize:function(){this.$el.html(c("<div></div>").prop("id","whats-new-textarea")),this.views.set("#whats-new-textarea",new n.Views.WhatsNew({activity:this.options.activity}))}}),n.Views.FormOptions=n.View.extend({tagName:"div",id:"whats-new-options",template:n.template("activity-post-form-options")}),n.Views.BeforeFormInputs=n.View.extend({tagName:"div",template:n.template("activity-before-post-form-inputs")}),n.Views.FormTarget=n.View.extend({tagName:"div",id:"whats-new-post-in-box",className:"in-profile",initialize:function(){var e=new n.Views.WhatsNewPostIn({filters:BP_Nouveau.activity.params.objects});this.views.add(e),e.model.on("change",this.attachAutocomplete,this),n.Nouveau.Activity.postForm.ActivityObjects.on("change:selected",this.postIn,this)},attachAutocomplete:function(e){0!==n.Nouveau.Activity.postForm.ActivityObjects.models.length&&n.Nouveau.Activity.postForm.ActivityObjects.reset(),_.each(this.views._views[""],function(e){_.isUndefined(e.collection)||e.remove()}),"profile"!==e.get("selected")?(this.views.add(new n.Views.AutoComplete({collection:n.Nouveau.Activity.postForm.ActivityObjects,type:e.get("selected"),placeholder:e.get("placeholder")})),this.model.set("object",e.get("selected"))):this.model.set({object:"user",item_id:0}),this.updateDisplay()},postIn:function(e){_.isUndefined(e.get("id"))?(this.model.set("item_id",0),this.attachAutocomplete(new Backbone.Model({selected:this.model.get("object")}))):(this.model.set("item_id",e.get("id")),this.views.set("#whats-new-post-in-box-items",new n.Views.Item({model:e})))},updateDisplay:function(){"user"!==this.model.get("object")?this.$el.removeClass():this.$el.hasClass("in-profile")||this.$el.addClass("in-profile")}}),n.Views.FormButtons=n.View.extend({tagName:"div",id:"whats-new-actions",initialize:function(){this.views.add(new n.View({tagName:"ul",id:"whats-new-buttons"})),_.each(this.collection.models,function(e){this.addItemView(e)},this),this.collection.on("change:active",this.isActive,this)},addItemView:function(e){this.views.add("#whats-new-buttons",new n.Views.FormButton({model:e}))},isActive:function(t){_.each(this.views._views[""],function(e,t){0!==t&&e.remove()}),!0===t.get("active")?(_.each(this.views._views["#whats-new-buttons"],function(e){e.model.get("id")!==t.get("id")&&(e.model.set("active",!1,{silent:!0}),e.$el.removeClass("active"),this.collection.trigger("reset:"+e.model.get("id"),this.model))},this),this.collection.trigger("display:"+t.get("id"),this)):this.collection.trigger("reset:"+t.get("id"),this.model)}}),n.Views.FormButton=n.View.extend({tagName:"li",className:"whats-new-button",template:n.template("activity-post-form-buttons"),events:{click:"setActive"},setActive:function(e){var t=this.model.get("active")||!1;e.preventDefault(),!1===t?(this.$el.addClass("active"),this.model.set("active",!0)):(this.$el.removeClass("active"),this.model.set("active",!1))}}),n.Views.FormSubmit=n.View.extend({tagName:"div",id:"whats-new-submit",className:"in-profile",initialize:function(){var e=new n.Views.ActivityInput({type:"reset",id:"aw-whats-new-reset",className:"text-button small",value:BP_Nouveau.activity.strings.cancelButton}),t=new n.Views.ActivityInput({type:"submit",id:"aw-whats-new-submit",className:"button",name:"aw-whats-new-submit",value:BP_Nouveau.activity.strings.postUpdateButton});this.views.set([t,e]),this.model.on("change:object",this.updateDisplay,this)},updateDisplay:function(e){_.isUndefined(e)||("user"!==e.get("object")?this.$el.removeClass("in-profile"):this.$el.hasClass("in-profile")||this.$el.addClass("in-profile"))}}),n.Views.PostForm=n.View.extend({tagName:"form",className:"activity-form",id:"whats-new-form",attributes:{name:"whats-new-form",method:"post"},events:{"focus #whats-new":"displayFull",reset:"resetForm",submit:"postUpdate",keydown:"postUpdate"},initialize:function(){this.model=new n.Models.Activity(_.pick(BP_Nouveau.activity.params,["user_id","item_id","object"])),this.options.backcompat=BP_Nouveau.activity.params.backcompat;var e=[new n.Views.FormAvatar,new n.Views.FormContent({activity:this.model})];!0===this.options.backcompat.before_post_form&&e.unshift(new n.Views.BeforeFormInputs),this.resetModel=this.model.clone(),this.views.set(e),this.model.on("change:errors",this.displayFeedback,this)},displayFull:function(e){var t=!0===this.options.backcompat.before_post_form?3:2;this.cleanFeedback(),t===this.views._views[""].length&&(c(e.target).css({resize:"vertical",height:"auto"}),this.$el.addClass("activity-form-expanded"),!0===this.options.backcompat.post_form_options?this.views.add(new n.Views.FormOptions({model:this.model})):this.views.add(new n.View({id:"whats-new-options"})),_.isUndefined(BP_Nouveau.activity.params.buttons)||(n.Nouveau.Activity.postForm.buttons.set(BP_Nouveau.activity.params.buttons),this.views.add("#whats-new-options",new n.Views.FormButtons({collection:n.Nouveau.Activity.postForm.buttons,model:this.model}))),!_.isUndefined(BP_Nouveau.activity.params.objects)&&1<_.keys(BP_Nouveau.activity.params.objects).length&&this.views.add("#whats-new-options",new n.Views.FormTarget({model:this.model})),this.views.add("#whats-new-options",new n.Views.FormSubmit({model:this.model})))},resetForm:function(){var i=this.options.backcompat.before_post_form?2:1;_.each(this.views._views[""],function(e,t){i<t&&e.remove()}),c("#whats-new").css({resize:"none",height:"50px"}),this.$el.removeClass("activity-form-expanded"),this.model.clear(),this.model.set(this.resetModel.attributes),_.each(n.Nouveau.Activity.postForm.buttons.models,function(e){n.Nouveau.Activity.postForm.buttons.trigger("resetForm:"+e.get("id"),e)})},cleanFeedback:function(){this.model.unset("errors",{silent:!0}),_.each(this.views._views[""],function(e){"message"===e.$el.prop("id")&&e.remove()})},displayFeedback:function(e){_.isUndefined(this.model.get("errors"))?this.cleanFeedback():this.views.add(new n.Views.activityFeedback(e.get("errors")))},postUpdate:function(e){var o=this,t={};if(e){if("keydown"===e.type&&(13!==e.keyCode||!e.ctrlKey))return e;e.preventDefault()}_.each(this.$el.serializeArray(),function(e){e.name=e.name.replace("[]",""),"whats-new"===e.name?o.model.set("content",e.value):-1===_.indexOf(["aw-whats-new-submit","whats-new-post-in"],e.name)&&(_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)))}),this.model.set(t,{silent:!0});e={_wpnonce_post_update:BP_Nouveau.activity.params.post_nonce};c("#_bp_as_nonce").val()&&(e._bp_as_nonce=c("#_bp_as_nonce").val()),n.ajax.post("post_update",_.extend(e,this.model.attributes)).done(function(e){var t=n.Nouveau.getStorage("bp-activity"),i=c('[data-bp-search="activity"] input[type="search"]').val(),s={},a=!1;i&&(i=new RegExp(i,"im"),s=e.activity.match(i)),(a=i&&!s?a:!t.filter||0===parseInt(t.filter,10)||"activity_update"===t.filter)&&e.is_directory&&(a="all"===t.scope&&("user"===o.model.get("object")||!1===e.is_private)||o.model.get("object")+"s"===t.scope),o.resetForm(),a?c("#activity-"+e.id).length||(c("#activity-stream ul.activity-list").length||c("#activity-stream").html(c("<ul></ul>").addClass("activity-list item-list bp-list")),n.Nouveau.inject("#activity-stream ul.activity-list",e.activity,"prepend")):o.views.add(new n.Views.activityFeedback({value:e.message,type:"updated"}))}).fail(function(e){o.model.set("errors",{type:"error",value:e.message})})}}),n.Nouveau.Activity.postForm.start())}(window.bp,jQuery);