window.wp=window.wp||{},window.bp=window.bp||{},function(s,n){"undefined"!=typeof BP_Nouveau&&(_.extend(s,_.pick(wp,"Backbone","ajax","template")),s.Models=s.Models||{},s.Collections=s.Collections||{},s.Views=s.Views||{},s.Nouveau=s.Nouveau||{},s.Nouveau.GroupInvites={start:function(){this.scope=null,this.views=new Backbone.Collection,this.navItems=new Backbone.Collection,this.users=new s.Collections.Users,this.invites=this.users.clone(),this.setupNav(),this.setupLoops(),this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.users.on("change:selected",this.addInvite,this),this.invites.on("change:selected",this.manageInvite,this),this.invites.on("add",this.invitesNav,this),this.invites.on("reset",this.hideInviteNav,this)},setupNav:function(){var t;this.nav=new s.Views.invitesNav({collection:this.navItems}),_.each(BP_Nouveau.group_invites.nav,function(e,i){_.isObject(e)&&((t=0)===i&&(this.scope=e.id,t=1),this.navItems.add({id:e.id,name:e.caption,href:e.href||"#members-list",active:t,hide:_.isUndefined(e.hide)?0:e.hide}))},this),this.nav.inject(".bp-invites-nav"),this.nav.on("bp-invites:confirm",this.loadConfirmView,this),this.nav.on("bp-invites:loops",this.setupLoops,this)},setupLoops:function(e){e=e||this.scope,this.clearViews(),e!==this.scope&&this.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.scope=e,e=new s.Views.inviteUsers({collection:this.users,scope:e}),this.views.add({id:"users",view:e}),e.inject(".bp-invites-content"),this.displayFilters(this.users)},displayFilters:function(e){this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",scope:this.scope}),e=new s.Views.inviteFilters({model:this.filters,users:e}),this.views.add({id:"filters",view:e}),e.inject(".bp-invites-filters")},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}))},displayFeedback:function(e,i){this.removeFeedback(),e&&(i=new s.Views.Feedback({value:e,type:i||"info"}),this.views.add({id:"feedback",view:i}),i.inject(".bp-invites-feedback"))},addInvite:function(e){!0===e.get("selected")?this.invites.add(e):!0===(e=this.invites.get(e.get("id"))).get("selected")&&this.invites.remove(e)},manageInvite:function(e){var i=this.users.get(e.get("id"));i&&i.set("selected",!1),this.invites.remove(e),this.invites.length||this.invites.reset()},invitesNav:function(){this.navItems.get("invites").set({active:0,hide:0})},hideInviteNav:function(){this.navItems.get("invites").set({active:0,hide:1})},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},loadConfirmView:function(){this.clearViews(),this.displayFeedback(BP_Nouveau.group_invites.invites_form,"help");var e=new s.Views.invitesEditor({collection:this.invites});this.views.add({id:"invites",view:e}),e.inject(".bp-invites-content")}},s.Models.User=Backbone.Model.extend({defaults:{id:0,avatar:"",name:"",selected:!1}}),s.Collections.Users=Backbone.Collection.extend({model:s.Models.User,initialize:function(){this.options={page:1,total_page:0,group_id:BP_Nouveau.group_invites.group_id}},sync:function(e,i,t){return(t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.groups,this.options.group_id&&(t.data.group_id=this.options.group_id),"read"===e?(t.data=_.extend(t.data,{action:"groups_get_group_potential_invites"}),s.ajax.send(t)):"create"===e?(t.data=_.extend(t.data,{action:"groups_send_group_invites",_wpnonce:BP_Nouveau.group_invites.nonces.send_invites}),i&&(t.data.users=i),s.ajax.send(t)):"delete"===e?(t.data=_.extend(t.data,{action:"groups_delete_group_invite",_wpnonce:BP_Nouveau.group_invites.nonces.uninvite}),i&&(t.data.user=i),s.ajax.send(t)):void 0},parse:function(t){return _.isArray(t.users)||(t.users=[t.users]),_.each(t.users,function(e,i){_.isNull(e)||(t.users[i].id=e.id,t.users[i].avatar=e.avatar,t.users[i].name=e.name)}),_.isUndefined(t.meta)||(this.options.page=t.meta.page,this.options.total_page=t.meta.total_page),t.users}}),s.Nouveau.GroupInvites.View=s.Backbone.View.extend({inject:function(e){this.render(),n(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),s.Views.Feedback=s.Nouveau.GroupInvites.View.extend({tagName:"div",className:"bp-invites-feedback",template:s.template("bp-group-invites-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),s.Views.invitesNav=s.Nouveau.GroupInvites.View.extend({tagName:"ul",className:"subnav",events:{"click .bp-invites-nav-item":"toggleView"},initialize:function(){this.collection.on("add",this.outputNav,this),this.collection.on("change:hide",this.showHideNavItem,this),window.onbeforeunload=_.bind(this.confirmQuit,this)},outputNav:function(e){1!==e.get("hide")&&this.views.add(new s.Views.invitesNavItem({model:e}))},showHideNavItem:function(i){var t=null;_.each(this.views._views[""],function(e){1===e.model.get("hide")&&e.remove(),i.get("id")===e.model.get("id")&&(t=!0)}),_.isBoolean(t)||(i.set("invites_count",s.Nouveau.GroupInvites.invites.length),this.outputNav(i))},toggleView:function(e){var i=n(e.target);e.preventDefault();var t=(i=!i.data("nav")&&"SPAN"===e.target.tagName?n(e.target).parent():i).data("nav");_.each(this.collection.models,function(e){e.id===t?(e.set("active",1),"invites"===e.id?this.trigger("bp-invites:confirm"):this.trigger("bp-invites:loops",e.id)):1!==e.get("hide")&&e.set("active",0)},this)},confirmQuit:function(){if(s.Nouveau.GroupInvites.invites&&s.Nouveau.GroupInvites.invites.length)return n('[data-nav="invites"]').focus(),!1}}),s.Views.invitesNavItem=s.Nouveau.GroupInvites.View.extend({tagName:"li",template:s.template("bp-invites-nav"),initialize:function(){1===this.model.get("active")&&(this.el.className+=" current"),"invites"===this.model.get("id")&&(this.el.className+=" dynamic"),"invited"===this.model.get("id")&&(this.el.className+=" pending"),this.model.on("change:active",this.toggleClass,this),this.on("ready",this.updateCount,this),s.Nouveau.GroupInvites.invites.on("add",this.updateCount,this),s.Nouveau.GroupInvites.invites.on("remove",this.updateCount,this)},updateCount:function(e,i){"invites"===this.model.get("id")&&(i=_.isUndefined(i)?this.model.get("invites_count"):i.models.length,n(this.el).find("span").length?n(this.el).find("span").html(i):n(this.el).find("a").append(n('<span class="count"></span>').html(i)))},toggleClass:function(e){0===e.get("active")?n(this.el).removeClass("current"):n(this.el).addClass("current")}}),s.Views.Pagination=s.Nouveau.GroupInvites.View.extend({tagName:"div",className:"last",template:s.template("bp-invites-paginate")}),s.Views.inviteFilters=s.Nouveau.GroupInvites.View.extend({tagName:"div",template:s.template("bp-invites-filters"),events:{"search #group_invites_search":"resetSearchTerms","submit #group_invites_search_form":"setSearchTerms","click #bp-invites-next-page":"nextPage","click #bp-invites-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterUsers,this),this.options.users.on("sync",this.addPaginatation,this)},addPaginatation:function(e){_.each(this.views._views[""],function(e){e.remove()}),1!==e.options.total_page&&this.views.add(new s.Views.Pagination({model:new Backbone.Model(e.options)}))},filterUsers:function(){s.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.loading,"loading"),this.options.users.reset(),this.options.users.fetch({data:_.pick(this.model.attributes,["scope","search_terms","page"]),success:this.usersFiltered,error:this.usersFilterError})},usersFiltered:function(){s.Nouveau.GroupInvites.removeFeedback()},usersFilterError:function(e,i){var t="error";i.type&&(t=i.type),s.Nouveau.GroupInvites.displayFeedback(i.feedback,t)},resetSearchTerms:function(e){e.preventDefault(),n(e.target).val()?n(e.target).closest("form").find("[type=submit]").addClass("bp-show"):n(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:n(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),s.Views.inviteUsers=s.Nouveau.GroupInvites.View.extend({tagName:"ul",className:"item-list bp-list",id:"members-list",initialize:function(){this.requestUsers(),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addUser,this)},requestUsers:function(){this.collection.reset(),this.collection.fetch({data:_.pick(this.options,"scope"),success:this.usersFetched,error:this.usersFetchError})},usersFetched:function(e,i){s.Nouveau.GroupInvites.displayFeedback(i.feedback,"help")},usersFetchError:function(e,i){var t=i.type||"help";s.Nouveau.GroupInvites.displayFeedback(i.feedback,t)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})},addUser:function(e){this.views.add(new s.Views.inviteUser({model:e}))}}),s.Views.inviteUser=s.Nouveau.GroupInvites.View.extend({tagName:"li",template:s.template("bp-invites-users"),events:{"click .group-add-remove-invite-button":"toggleUser","click .group-remove-invite-button":"removeInvite"},initialize:function(){s.Nouveau.GroupInvites.invites.get(this.model.get("id"))&&this.model.set("selected",!0,{silent:!0})},render:function(){this.model.get("selected")?this.el.className="selected":this.el.className="",s.Nouveau.GroupInvites.View.prototype.render.apply(this,arguments)},toggleUser:function(e){e.preventDefault(),!1===this.model.get("selected")?this.model.set("selected",!0):(this.model.set("selected",!1),s.Nouveau.GroupInvites.invites.length||s.Nouveau.GroupInvites.invites.reset()),this.render()},removeInvite:function(e){e.preventDefault();e=this.model.collection;e.length&&e.sync("delete",this.model.get("id"),{success:_.bind(this.inviteRemoved,this),error:_.bind(this.uninviteError,this)})},inviteRemoved:function(e){var i=this.model.collection;i.length&&(i.remove(this.model),this.remove(),s.Nouveau.GroupInvites.removeFeedback(),!1===e.has_invites&&(s.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),s.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:1})))},uninviteError:function(e){s.Nouveau.GroupInvites.displayFeedback(e.feedback,"error")}}),s.Views.invitesEditor=s.Nouveau.GroupInvites.View.extend({tagName:"div",id:"send-invites-editor",events:{"click #bp-invites-send":"sendInvites","click #bp-invites-reset":"clearForm"},initialize:function(){this.views.add(new s.Views.selectedUsers({collection:this.collection})),this.views.add(new s.Views.invitesForm),this.collection.on("reset",this.cleanViews,this)},sendInvites:function(e){e.preventDefault(),n(this.el).addClass("bp-hide"),s.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.invites_sending,"info"),this.collection.sync("create",_.pluck(this.collection.models,"id"),{success:_.bind(this.invitesSent,this),error:_.bind(this.invitesError,this),data:{message:n(this.el).find("textarea").val()}})},invitesSent:function(e){this.collection.reset(),s.Nouveau.GroupInvites.displayFeedback(e.feedback,"success"),1!==s.Nouveau.GroupInvites.navItems.get("invited").get("hide")||BP_Nouveau.group_invites.is_group_create||s.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0})},invitesError:function(i){var e=i.type||"help";n(this.el).removeClass("bp-hide"),s.Nouveau.GroupInvites.displayFeedback(i.feedback,e),_.isUndefined(i.users)||(1===s.Nouveau.GroupInvites.navItems.get("invited").get("hide")&&i.users.length<this.collection.length&&s.Nouveau.GroupInvites.navItems.get("invited").set({active:0,hide:0}),_.each(this.collection.models,function(e){-1===_.indexOf(i.users,e.get("id"))&&e.set("selected",!1)},this))},clearForm:function(e){e.preventDefault(),this.collection.reset()},cleanViews:function(){_.each(this.views._views[""],function(e){e.remove()}),s.Nouveau.GroupInvites.displayFeedback(BP_Nouveau.group_invites.invites_form_reset,"success")}}),s.Views.invitesForm=s.Nouveau.GroupInvites.View.extend({tagName:"div",id:"bp-send-invites-form",template:s.template("bp-invites-form")}),s.Views.selectedUsers=s.Nouveau.GroupInvites.View.extend({tagName:"ul",initialize:function(){this.cleanContent(),_.each(this.collection.models,function(e){this.views.add(new s.Views.selectedUser({model:e}))},this)},cleanContent:function(){_.each(this.views._views[""],function(e){e.remove()})}}),s.Views.selectedUser=s.Nouveau.GroupInvites.View.extend({tagName:"li",template:s.template("bp-invites-selection"),events:{click:"removeSelection"},initialize:function(){this.model.on("change:selected",this.removeView,this),this.model.get("uninviteTooltip")||this.model.set("uninviteTooltip",BP_Nouveau.group_invites.removeUserInvite.replace("%s",this.model.get("name")),{silent:!0}),this.el.id="uninvite-user-"+this.model.get("id")},removeSelection:function(e){e.preventDefault(),this.model.set("selected",!1)},removeView:function(e){!1===e.get("selected")&&this.remove()}}),s.Nouveau.GroupInvites.start())}(window.bp,jQuery);