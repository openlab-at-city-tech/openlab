window.wp=window.wp||{},window.bp=window.bp||{},function(c,u){"undefined"!=typeof BP_Nouveau&&(_.extend(c,_.pick(wp,"Backbone","ajax","template")),c.Models=c.Models||{},c.Collections=c.Collections||{},c.Views=c.Views||{},c.Nouveau=c.Nouveau||{},c.Nouveau.Messages={start:function(){this.views=new Backbone.Collection,this.threads=new c.Collections.Threads,this.messages=new c.Collections.Messages,this.router=new c.Nouveau.Messages.Router,this.box="inbox",this.supportedRoutes=BP_Nouveau.messages.supportedRoutes,this.setupNav(),Backbone.history.start({pushState:!0,root:BP_Nouveau.messages.rootUrl})},setupNav:function(){var a=this;u("#compose-personal-li").addClass("last"),u("#subnav a").on("click",function(e){var s=u(e.target).prop("id"),t=_.keys(a.supportedRoutes);if(-1===_.indexOf(t,s)||"unsupported"===a.box)return e;e.preventDefault(),a.removeTinyMCE(),"compose"===s?_.isUndefined(a.views.get("compose"))?a.router.navigate(a.supportedRoutes.compose+"/",{trigger:!0}):((t=a.views.get("compose")).get("view").remove(),a.views.remove({id:"compose",view:t}),"single"===a.box&&(a.box="inbox"),a.router.navigate(a.supportedRoutes[a.box]+"/",{trigger:!0})):a.box===s&&_.isUndefined(a.views.get("compose"))||(a.clearViews(),a.router.navigate(a.supportedRoutes[s]+"/",{trigger:!0}))})},updateNav:function(e){var s=this.box;e&&(s=e),u("#subnav ul li").each(function(e,s){u(s).removeClass("current selected")}),u("#subnav a#"+s).closest("li").addClass("current selected")},removeTinyMCE:function(){"undefined"!=typeof tinymce&&null!==tinymce.get("message_content")&&tinymce.EditorManager.execCommand("mceRemoveEditor",!0,"message_content")},tinyMCEinit:function(){void 0===window.tinyMCE||null===window.tinyMCE.activeEditor||void 0===window.tinyMCE.activeEditor||_.isEmpty(c.mentions)||u(window.tinyMCE.activeEditor.contentDocument.activeElement).atwho("setIframe",u("#message_content_ifr")[0]).bp_mentions({data:[],suffix:" "})},removeFeedback:function(){var e;_.isUndefined(this.views.get("feedback"))||((e=this.views.get("feedback")).get("view").remove(),this.views.remove({id:"feedback",view:e}))},displayFeedback:function(e,s){this.removeFeedback(),e&&(e=new c.Views.Feedback({value:e,type:s||"info"}),this.views.add({id:"feedback",view:e}),e.inject(".bp-messages-feedback"))},clearViews:function(){_.isUndefined(this.views.models)||(_.each(this.views.models,function(e){e.get("view").remove()},this),this.views.reset())},composeView:function(){this.clearViews(),this.updateNav("compose");var e=new c.Views.messageForm({model:new c.Models.Message});this.views.add({id:"compose",view:e}),e.inject(".bp-messages-content")},threadsView:function(){this.updateNav();var e=new c.Views.userThreads({collection:this.threads,box:this.box});this.views.add({id:"threads",view:e}),e.inject(".bp-messages-content"),this.displayFilters(this.threads)},displayFilters:function(e){this.filters=new Backbone.Model({page:1,total_page:0,search_terms:"",box:this.box}),e=new c.Views.messageFilters({model:this.filters,threads:e}),this.views.add({id:"filters",view:e}),e.inject(".bp-messages-filters")},singleView:function(e){this.clearViews(),this.box="single";e=new c.Views.userMessages({collection:this.messages,thread:e});this.views.add({id:"single",view:e}),e.inject(".bp-messages-content")}},c.Models.Message=Backbone.Model.extend({defaults:{send_to:[],subject:"",message_content:"",meta:{}},sendMessage:function(){return c.ajax.post("messages_send_message",_.extend({nonce:BP_Nouveau.messages.nonces.send},this.attributes))}}),c.Models.Thread=Backbone.Model.extend({defaults:{id:0,message_id:0,subject:"",excerpt:"",content:"",unread:!0,sender_name:"",sender_link:"",sender_avatar:"",count:0,date:0,display_date:"",recipients:[]},updateReadState:function(e){return(e=e||{}).data=_.extend(_.pick(this.attributes,["id","message_id"]),{action:"messages_thread_read",nonce:BP_Nouveau.nonces.messages}),c.ajax.send(e)}}),c.Models.messageThread=Backbone.Model.extend({defaults:{id:0,content:"",sender_id:0,sender_name:"",sender_link:"",sender_avatar:"",date:0,display_date:""}}),c.Collections.Threads=Backbone.Collection.extend({model:c.Models.Thread,initialize:function(){this.options={page:1,total_page:0}},sync:function(e,s,t){if((t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e)return t.data=_.extend(t.data,{action:"messages_get_user_message_threads"}),c.ajax.send(t)},parse:function(t){return _.isArray(t.threads)||(t.threads=[t.threads]),_.each(t.threads,function(e,s){_.isNull(e)||(t.threads[s].id=e.id,t.threads[s].message_id=e.message_id,t.threads[s].subject=e.subject,t.threads[s].excerpt=e.excerpt,t.threads[s].content=e.content,t.threads[s].unread=e.unread,t.threads[s].sender_name=e.sender_name,t.threads[s].sender_link=e.sender_link,t.threads[s].sender_avatar=e.sender_avatar,t.threads[s].count=e.count,t.threads[s].date=new Date(e.date),t.threads[s].display_date=e.display_date,t.threads[s].recipients=e.recipients,t.threads[s].star_link=e.star_link,t.threads[s].is_starred=e.is_starred)}),_.isUndefined(t.meta)||(this.options.page=t.meta.page,this.options.total_page=t.meta.total_page),c.Nouveau.Messages.box&&(this.options.box=c.Nouveau.Messages.box),_.isUndefined(t.extraContent)||_.extend(this.options,_.pick(t.extraContent,["beforeLoop","afterLoop"])),t.threads},doAction:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data=_.extend(t.data,{action:"messages_"+e,nonce:BP_Nouveau.nonces.messages,id:s}),c.ajax.send(t)}}),c.Collections.Messages=Backbone.Collection.extend({model:c.Models.messageThread,options:{},sync:function(e,s,t){return(t=t||{}).context=this,t.data=t.data||{},t.data.nonce=BP_Nouveau.nonces.messages,"read"===e?(t.data=_.extend(t.data,{action:"messages_get_thread_messages"}),c.ajax.send(t)):"create"===e?(t.data=_.extend(t.data,{action:"messages_send_reply",nonce:BP_Nouveau.messages.nonces.send},s||{}),c.ajax.send(t)):void 0},parse:function(t){return _.isArray(t.messages)||(t.messages=[t.messages]),_.each(t.messages,function(e,s){_.isNull(e)||(t.messages[s].id=e.id,t.messages[s].content=e.content,t.messages[s].sender_id=e.sender_id,t.messages[s].sender_name=e.sender_name,t.messages[s].sender_link=e.sender_link,t.messages[s].sender_avatar=e.sender_avatar,t.messages[s].date=new Date(e.date),t.messages[s].display_date=e.display_date,t.messages[s].star_link=e.star_link,t.messages[s].is_starred=e.is_starred)}),_.isUndefined(t.thread)||(this.options.thread_id=t.thread.id,this.options.thread_subject=t.thread.subject,this.options.recipients=t.thread.recipients),t.messages}}),c.Nouveau.Messages.View=c.Backbone.View.extend({inject:function(e){this.render(),u(e).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),c.Views.Feedback=c.Nouveau.Messages.View.extend({tagName:"div",className:"bp-messages bp-user-messages-feedback",template:c.template("bp-messages-feedback"),initialize:function(){this.model=new Backbone.Model({type:this.options.type||"info",message:this.options.value})}}),c.Views.Hook=c.Nouveau.Messages.View.extend({tagName:"div",template:c.template("bp-messages-hook"),initialize:function(){this.model=new Backbone.Model({extraContent:this.options.extraContent}),this.el.className="bp-messages-hook",this.options.className&&(this.el.className+=" "+this.options.className)}}),c.Views.messageEditor=c.Nouveau.Messages.View.extend({template:c.template("bp-messages-editor"),initialize:function(){this.on("ready",this.activateTinyMce,this)},activateTinyMce:function(){"undefined"!=typeof tinymce&&tinymce.EditorManager.execCommand("mceAddEditor",!0,"message_content")}}),c.Views.messageForm=c.Nouveau.Messages.View.extend({tagName:"form",id:"send_message_form",className:"standard-form",template:c.template("bp-messages-form"),events:{"click #bp-messages-send":"sendMessage","click #bp-messages-reset":"resetForm"},initialize:function(){this.resetModel=this.model.clone(),this.views.add("#bp-message-content",new c.Views.messageEditor),this.model.on("change",this.resetFields,this),this.on("ready",this.addMentions,this)},addMentions:function(){var e=u(this.el).find("#send-to-input"),s=c.Nouveau.getLinkParams(null,"r")||null;e.bp_mentions({data:[],suffix:" "}),_.isNull(s)||(e.val("@"+_.escape(s)+" "),e.trigger("focus"))},resetFields:function(e){_.each(e.previousAttributes(),function(e,s){"message_content"===s?void 0!==tinyMCE.activeEditor&&null!==tinyMCE.activeEditor&&tinyMCE.activeEditor.setContent(""):"meta"!==s&&!1!==e&&u('input[name="'+s+'"]').val("")}),u(this.el).trigger("message:reset",_.pick(e.previousAttributes(),"meta"))},sendMessage:function(e){var s,t={},a=[],i=this,n=e.currentTarget;e.preventDefault(),c.Nouveau.Messages.removeFeedback(),u(n).addClass("disabled").prop("disabled",!0),_.each(this.$el.serializeArray(),function(e){var s;e.name=e.name.replace("[]",""),-1===_.indexOf(["send_to","subject","message_content"],e.name)?_.isUndefined(t[e.name])?t[e.name]=e.value:(_.isArray(t[e.name])||(t[e.name]=[t[e.name]]),t[e.name].push(e.value)):"send_to"===e.name?(s=e.value.match(/(^|[^@\w\-])@([a-zA-Z0-9_\-]{1,50})\b/g))?((s=s.map(function(e){return e=e.trim()}))&&_.isArray(s)||a.push("send_to"),this.model.set("send_to",s,{silent:!0})):a.push("send_to"):("message_content"===e.name&&void 0!==tinyMCE.activeEditor&&(e.value=tinyMCE.activeEditor.getContent()),e.value?this.model.set(e.name,e.value,{silent:!0}):a.push(e.name))},this),a.length?(s="",_.each(a,function(e){s+=BP_Nouveau.messages.errors[e]+"<br/>"}),c.Nouveau.Messages.displayFeedback(s,"error"),i.model.set("sending",!1,{silent:!0}),u(n).removeClass("disabled").prop("disabled",!1)):!0!==this.model.get("sending")&&(this.model.set({sending:!0,meta:t},{silent:!0}),this.model.sendMessage().done(function(e){i.model.set(i.resetModel),c.Nouveau.Messages.displayFeedback(e.feedback,e.type),c.Nouveau.Messages.removeTinyMCE();e=c.Nouveau.Messages.views.get("compose");e.get("view").remove(),c.Nouveau.Messages.views.remove({id:"compose",view:e}),c.Nouveau.Messages.router.navigate(c.Nouveau.Messages.supportedRoutes.sentbox+"/",{trigger:!0})}).fail(function(e){e.feedback&&c.Nouveau.Messages.displayFeedback(e.feedback,e.type)}).always(function(){i.model.set("sending",!1,{silent:!0}),u(n).removeClass("disabled").prop("disabled",!1)}))},resetForm:function(e){e.preventDefault(),this.model.set(this.resetModel),c.Nouveau.Messages.views.trigger("compose:resetForm")}}),c.Views.userThreads=c.Nouveau.Messages.View.extend({tagName:"div",events:{"click .subject":"changePreview"},initialize:function(){var e=[new c.Nouveau.Messages.View({tagName:"ul",id:"message-threads",className:"message-lists"}),new c.Views.previewThread({collection:this.collection})];_.each(e,function(e){this.views.add(e)},this),this.requestThreads(),this.collection.on("reset",this.cleanContent,this),this.collection.on("add",this.addThread,this)},requestThreads:function(){this.collection.reset(),c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.loading,"loading"),this.collection.fetch({data:_.pick(this.options,"box"),success:_.bind(this.threadsFetched,this),error:this.threadsFetchError})},threadsFetched:function(){c.Nouveau.Messages.removeFeedback(),this.collection.options.afterLoop&&this.views.add(new c.Views.Hook({extraContent:this.collection.options.afterLoop,className:"after-messages-loop"}),{at:1}),this.collection.options.beforeLoop&&this.views.add(new c.Views.Hook({extraContent:this.collection.options.beforeLoop,className:"before-messages-loop"}),{at:0}),c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howto,"info")},threadsFetchError:function(e,s){c.Nouveau.Messages.displayFeedback(s.feedback,s.type)},cleanContent:function(){_.each(this.views._views["#message-threads"],function(e){e.remove()})},addThread:function(e){var s=this.collection.findWhere({active:!0});_.isUndefined(s)&&e.set("active",!0),this.views.add("#message-threads",new c.Views.userThread({model:e}))},setActiveThread:function(s){s&&_.each(this.collection.models,function(e){e.id===s?e.set("active",!0):e.unset("active")},this)},changePreview:function(e){var s=u(e.currentTarget);e.preventDefault(),c.Nouveau.Messages.removeFeedback(),s.closest(".thread-item").hasClass("selected")?c.Nouveau.Messages.router.navigate("view/"+s.closest(".thread-content").data("thread-id")+"/",{trigger:!0}):(this.setActiveThread(s.closest(".thread-content").data("thread-id")),u(".message-action-view").focus())}}),c.Views.userThread=c.Nouveau.Messages.View.extend({tagName:"li",template:c.template("bp-messages-thread"),className:"thread-item",events:{"click .message-check":"singleSelect"},initialize:function(){var e,s;this.model.get("active")&&(this.el.className+=" selected"),this.model.get("unread")&&(this.el.className+=" unread"),"sentbox"===c.Nouveau.Messages.box?(s="",2===(e=this.model.get("recipients").length)?s=BP_Nouveau.messages.toOthers.one:2<e&&(s=BP_Nouveau.messages.toOthers.more.replace("%d",Number(e-1))),this.model.set({recipientsCount:e,toOthers:s},{silent:!0})):this.model.get("recipientsCount")&&this.model.unset("recipientsCount",{silent:!0}),this.model.on("change:active",this.toggleClass,this),this.model.on("change:unread",this.updateReadState,this),this.model.on("change:checked",this.bulkSelect,this),this.model.on("remove",this.cleanView,this)},toggleClass:function(e){!0===e.get("active")?u(this.el).addClass("selected"):u(this.el).removeClass("selected")},updateReadState:function(e,s){!1===s?u(this.el).removeClass("unread"):u(this.el).addClass("unread")},bulkSelect:function(e){u("#bp-message-thread-"+e.get("id")).length&&u("#bp-message-thread-"+e.get("id")).prop("checked",e.get("checked"))},singleSelect:function(e){var e=u(e.currentTarget).prop("checked"),s=(this.model.set("checked",e,{silent:!0}),!1);_.each(this.model.collection.models,function(e){!0===e.get("checked")&&(s=!0)}),s?(u("#user-messages-bulk-actions").closest(".bulk-actions-wrap").removeClass("bp-hide"),c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(u("#user-messages-bulk-actions").closest(".bulk-actions-wrap").addClass("bp-hide"),c.Nouveau.Messages.removeFeedback())},cleanView:function(){this.views.view.remove()}}),c.Views.previewThread=c.Nouveau.Messages.View.extend({tagName:"div",id:"thread-preview",template:c.template("bp-messages-preview"),events:{"click .actions button":"doAction","click .actions a":"doAction"},initialize:function(){this.collection.on("change:active",this.setPreview,this),this.collection.on("change:is_starred",this.updatePreview,this),this.collection.on("reset",this.emptyPreview,this),this.collection.on("remove",this.emptyPreview,this)},render:function(){_.isUndefined(this.model)||!0!==this.model.get("active")||c.Nouveau.Messages.View.prototype.render.apply(this,arguments)},setPreview:function(e){var s=this;!0===(this.model=e).get("unread")&&this.model.updateReadState().done(function(){s.model.set("unread",!1)}),this.render()},updatePreview:function(e){!0===e.get("active")&&this.render()},emptyPreview:function(){u(this.el).html("")},doAction:function(e){var s=u(e.currentTarget).data("bp-action"),t=this,a={},i=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault();var n=this.collection.findWhere({active:!0});n.get("id")&&(e=n.get("id"),"view"===s?c.Nouveau.Messages.router.navigate("view/"+e+"/",{trigger:!0}):("star"!==s&&"unstar"!==s||(a.data={star_nonce:n.get("star_nonce")},e=n.get("starred_id")),_.isUndefined(i[s])||c.Nouveau.Messages.displayFeedback(i[s],"loading"),this.collection.doAction(s,e,a).done(function(e){c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type),"delete"===s||"exit"===s||"starred"===t.collection.options.box&&"unstar"===s?(t.collection.remove(n.get("id")),t.collection.fetch({data:_.pick(t.collection.options,["box","search_terms","page"])})):"unstar"===s||"star"===s?(_.each(e.messages,function(e){n.set(e)}),n.set(_.first(e.messages))):e.messages&&n.set(_.first(e.messages))}).fail(function(e){c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type)})))}}),c.Views.Pagination=c.Nouveau.Messages.View.extend({tagName:"li",className:"last filter",template:c.template("bp-messages-paginate")}),c.Views.BulkActions=c.Nouveau.Messages.View.extend({tagName:"div",template:c.template("bp-bulk-actions"),events:{"click #user_messages_select_all":"bulkSelect","click .bulk-apply":"doBulkAction"},bulkSelect:function(e){var s=u(e.currentTarget).prop("checked");s?(u(this.el).find(".bulk-actions-wrap").removeClass("bp-hide").addClass("bp-show"),c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.howtoBulk,"info")):(u(this.el).find(".bulk-actions-wrap").addClass("bp-hide"),c.Nouveau.Messages.removeFeedback()),_.each(this.collection.models,function(e){e.set("checked",s)})},doBulkAction:function(e){var s,t,a,i=this,n={},o="id",d=BP_Nouveau.messages.doingAction,r=(e.preventDefault(),u("#user-messages-bulk-actions").val());r&&(e=this.collection.where({checked:!0}),t=s=_.map(e,function(e){return e.get("id")}),"star"!==r&&"unstar"!==r||(1===(t=_.map(e,function(e){return e.get("starred_id")})).length&&(n.data={star_nonce:e[0].get("star_nonce")}),o="starred_id"),a=_.object(_.map(e,function(e){return[e.get(o),e.get("id")]})),_.isUndefined(d[r])||c.Nouveau.Messages.displayFeedback(d[r],"loading"),this.collection.doAction(r,t,n).done(function(e){c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type),"delete"===r||"exit"===r||"starred"===i.collection.options.box&&"unstar"===r?(i.collection.remove(s),i.collection.fetch({data:_.pick(i.collection.options,["box","search_terms","page"])})):e.messages&&_.each(e.messages,function(e,s){i.collection.get(a[s]).set(e)})}).fail(function(e){c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type)}))}}),c.Views.messageFilters=c.Nouveau.Messages.View.extend({tagName:"ul",template:c.template("bp-messages-filters"),events:{"search #user_messages_search":"resetSearchTerms","submit #user_messages_search_form":"setSearchTerms","click #bp-messages-next-page":"nextPage","click #bp-messages-prev-page":"prevPage"},initialize:function(){this.model.on("change",this.filterThreads,this),this.options.threads.on("sync",this.addPaginatation,this)},addPaginatation:function(e){_.each(this.views._views,function(e){_.isUndefined(e)||_.first(e).remove()}),this.views.add(new c.Views.Pagination({model:new Backbone.Model(e.options)})),this.views.add(".user-messages-bulk-actions",new c.Views.BulkActions({model:new Backbone.Model(BP_Nouveau.messages.bulk_actions),collection:e}))},filterThreads:function(){c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.loading,"loading"),this.options.threads.reset(),_.extend(this.options.threads.options,_.pick(this.model.attributes,["box","search_terms"])),this.options.threads.fetch({data:_.pick(this.model.attributes,["box","search_terms","page"]),success:this.threadsFiltered,error:this.threadsFilterError})},threadsFiltered:function(){c.Nouveau.Messages.removeFeedback()},threadsFilterError:function(e,s){c.Nouveau.Messages.displayFeedback(s.feedback,s.type)},resetSearchTerms:function(e){e.preventDefault(),u(e.target).val()?u(e.target).closest("form").find("[type=submit]").addClass("bp-show").removeClass("bp-hide"):u(e.target).closest("form").submit()},setSearchTerms:function(e){e.preventDefault(),this.model.set({search_terms:u(e.target).find("input[type=search]").val()||"",page:1})},nextPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")+1)},prevPage:function(e){e.preventDefault(),this.model.set("page",this.model.get("page")-1)}}),c.Views.userMessagesHeader=c.Nouveau.Messages.View.extend({tagName:"div",template:c.template("bp-messages-single-header"),events:{"click .actions a":"doAction","click .actions button":"doAction"},doAction:function(e){var s=u(e.currentTarget).data("bp-action"),t=this,a={},i=BP_Nouveau.messages.doingAction;if(!s)return e;e.preventDefault(),this.model.get("id")&&("star"!==s&&"unstar"!==s||(a.data={star_nonce:this.model.get("star_nonce")},u(e.currentTarget).addClass("bp-hide"),u(e.currentTarget).parent().find('[data-bp-action="'+{star:"unstar",unstar:"star"}[s]+'"]').removeClass("bp-hide")),_.isUndefined(i[s])||c.Nouveau.Messages.displayFeedback(i[s],"loading"),c.Nouveau.Messages.threads.doAction(s,this.model.get("id"),a).done(function(e){"delete"===s||"exit"===s?c.Nouveau.Messages.clearViews():e.messages&&t.model.set(_.first(e.messages)),c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type)}).fail(function(e){c.Nouveau.Messages.removeFeedback(),c.Nouveau.Messages.displayFeedback(e.feedback,e.type)}))}}),c.Views.userMessagesEntry=c.Views.userMessagesHeader.extend({tagName:"li",template:c.template("bp-messages-single-list"),events:{"click [data-bp-action]":"doAction"},initialize:function(){this.model.on("change:is_starred",this.updateMessage,this)},updateMessage:function(e){this.model.get("id")===e.get("id")&&this.render()}}),c.Views.userMessages=c.Nouveau.Messages.View.extend({tagName:"div",template:c.template("bp-messages-single"),initialize:function(){this.requestMessages(),this.reply=new c.Models.messageThread,this.collection.on("add",this.addMessage,this),this.views.add("#bp-message-content",new c.Views.messageEditor)},events:{"click #send_reply_button":"sendReply"},requestMessages:function(){var e={};this.collection.reset(),c.Nouveau.Messages.displayFeedback(BP_Nouveau.messages.loading,"loading"),_.isUndefined(this.options.thread.attributes)?e.id=this.options.thread.id:(e.id=this.options.thread.get("id"),e.js_thread=!_.isEmpty(this.options.thread.get("subject"))),this.collection.fetch({data:e,success:_.bind(this.messagesFetched,this),error:this.messagesFetchError})},messagesFetched:function(e,s){s.thread&&s.thread.id&&(this.options.thread=new Backbone.Model(s.thread)),c.Nouveau.Messages.removeFeedback(),this.views.add("#bp-message-thread-header",new c.Views.userMessagesHeader({model:this.options.thread}))},messagesFetchError:function(e,s){s.feedback&&s.type&&c.Nouveau.Messages.displayFeedback(s.feedback,s.type)},addMessage:function(e){this.views.add("#bp-message-thread-list",new c.Views.userMessagesEntry({model:e}))},addEditor:function(){this.views.add("#bp-message-content",new c.Views.messageEditor)},sendReply:function(e){e.preventDefault(),!0!==this.reply.get("sending")&&((e=this.options.thread).id||(e=this.options.collection.at(0)),this.reply.set({thread_id:e.id,content:tinyMCE.activeEditor.getContent(),sending:!0}),this.collection.sync("create",_.pick(this.reply.attributes,["thread_id","content"]),{success:_.bind(this.replySent,this),error:_.bind(this.replyError,this)}))},replySent:function(e){e=this.collection.parse(e);tinyMCE.activeEditor.setContent(""),this.reply.set("sending",!1),this.collection.add(_.first(e)),c.Nouveau.Messages.removeFeedback()},replyError:function(e){e.feedback&&e.type&&c.Nouveau.Messages.displayFeedback(e.feedback,e.type),this.reply.get("sending")&&this.reply.set("sending",!1)}}),c.Nouveau.Messages.Router=Backbone.Router.extend({routes:{"view/:id/":"viewMessage","":"inboxView","*unSupported":"unSupported"},initialize:function(){var t=this;_.each(BP_Nouveau.messages.supportedRoutes,function(e,s){t.route(e+"/",s+"Route",function(){"compose"===s?t.composeMessage():"sentbox"===s?t.sentboxView():"starred"===s?t.starredView():"inbox"===s&&t.inboxView()})})},composeMessage:function(){c.Nouveau.Messages.composeView()},viewMessage:function(e){var s;e&&(void 0===(s=c.Nouveau.Messages.threads.get(e))&&((s={}).id=e),c.Nouveau.Messages.singleView(s))},sentboxView:function(){c.Nouveau.Messages.box="sentbox",c.Nouveau.Messages.threadsView()},starredView:function(){c.Nouveau.Messages.box="starred",c.Nouveau.Messages.threadsView()},unSupported:function(){c.Nouveau.Messages.box="unsupported"},inboxView:function(){c.Nouveau.Messages.box="inbox",c.Nouveau.Messages.threadsView()}}),c.Nouveau.Messages.start())}(window.bp,jQuery);