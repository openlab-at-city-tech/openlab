!function(e,n,r){"undefined"!=typeof bpGroupManageMembersSettings&&n.isRestEnabled&&(_.extend(n,_.pick(e,"Backbone","template")),n.Models=n.Models||{},n.Collections=n.Collections||{},n.Views=n.Views||{},n.Models.groupMember=Backbone.Model.extend({defaults:{id:0,name:"",avatar_urls:{},is_admin:!1,is_banned:!1,is_confirmed:!1,is_mod:!1,link:""},options:{path:bpGroupManageMembersSettings.path,type:"POST",data:{},dataType:"json"},initialize:function(){this.on("sync",this.resetRequestOptions,this)},resetRequestOptions:function(){this.options.data={},this.options.path=bpGroupManageMembersSettings.path},sync:function(e,t,i){(i=i||{}).context=this;var s=i.data||{};if(this.options.path=this.options.path.concat("/"+t.get("id")),_.extend(i,this.options),_.extend(i.data,s),"delete"===e||"update"===e)return i.headers="delete"===e?{"X-HTTP-Method-Override":"DELETE"}:{"X-HTTP-Method-Override":"PUT"},n.apiRequest(i)},parse:function(e){return e=_.isArray(e)?_.first(e):e}}),n.Collections.groupMembers=Backbone.Collection.extend({model:n.Models.groupMember,options:{path:bpGroupManageMembersSettings.path,type:"GET",data:{},dataType:"json"},initialize:function(){this.on("reset",function(){this.options.data={}},this)},sync:function(e,t,s){(s=s||{}).context=this;var i=s.data||{};if(_.extend(s,this.options),_.extend(s.data,i),"read"===e){var o=this,r=s.success;return s.success=function(e,t,i){if(_.isUndefined(i)||(o.totalPages=parseInt(i.getResponseHeader("X-WP-TotalPages"),10),o.totalGroupMembers=parseInt(i.getResponseHeader("X-WP-Total"),10)),o.currentPage=s.data.page||1,r)return r.apply(this,arguments)},n.apiRequest(s)}}}),n.View=n.View||n.Backbone.View.extend({prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),n.Views.GroupMemberUpdatingInfo=n.View.extend({tagName:"p",template:n.template("bp-manage-members-updating"),initialize:function(){this.model=new Backbone.Model({type:this.options.value})}}),n.Views.GroupMemberErrorInfo=n.View.extend({tagName:"p",template:n.template("bp-manage-members-error"),initialize:function(){this.model=new Backbone.Model({message:this.options.value})}}),n.Views.GroupsMembersLabel=n.Views.GroupMemberUpdatingInfo.extend({tagName:"label",template:n.template("bp-manage-members-label")}),n.Views.GroupRolesDropDown=n.View.extend({tagName:"select",filters:_.extend({all:{name:bpGroupManageMembersSettings.strings.allMembers}},bpGroupManageMembersSettings.roles),events:{change:"change"},initialize:function(){this.options.omits&&(this.filters=_.omit(this.filters,this.options.omits)),this.$el.html(_.chain(this.filters).map(function(e,t){e=r("<option></option>").val(t).html(e.name)[0];return this.options.currentRole&&t===this.options.currentRole?{el:r(e).prop("selected",!0)}:{el:e}},this).pluck("el").value())},change:function(e){var t=r(e.target).val(),e={roles:[t]};this.collection&&("all"===t?(this.collection.currentRole="",e={exclude_admins:!1}):this.collection.currentRole=t,this.collection.currentPage=1,e.page=1,r("#manage-members-search").val(""),this.collection.fetch({data:e,reset:!0}))}}),n.Views.GroupMembersSearch=n.View.extend({className:"bp-dir-search-form",tagName:"form",template:n.template("bp-manage-members-search"),events:{"click #manage-members-search-submit":"searchMember"},searchMember:function(e){e.preventDefault();e=r("#manage-members-search").val(),e=_.extend(this.collection.options.data,{search:e,page:1});this.collection.currentPage=1,this.collection.currentRole?e.roles=[this.collection.currentRole]:e.exclude_admins=!1,this.collection.fetch({data:e,reset:!0})}}),n.Views.GroupsMembersPagination=n.View.extend({className:"bp-pagination",template:n.template("bp-manage-members-paginate"),events:{"click .group-members-paginate-button":"queryPage"},initialize:function(){this.collection.on("reset",this.setPagination,this)},setPagination:function(e){e=_.pick(e,["currentPage","totalGroupMembers","totalPages"]);1<e.totalPages&&(e.nextPage=e.currentPage+1,e.prevPage=e.currentPage-1),this.model=new Backbone.Model(e),this.render()},queryPage:function(e){e.preventDefault();var t=r(e.currentTarget).data("page"),e=r("#manage-members-search").val(),t=_.extend(this.collection.options.data,{search:e,page:t});this.collection.currentRole?t.roles=[this.collection.currentRole]:t.exclude_admins=!1,this.collection.fetch({data:t,reset:!0})}}),n.Views.GroupMembersNoMatches=n.View.extend({tagName:"tr",template:n.template("bp-manage-members-empty-row")}),n.Views.GroupMembersListRow=n.View.extend({tagName:"tr",template:n.template("bp-manage-members-row"),events:{"click .group-member-actions a":"doMemberAction","change .group-member-edit select":"editMemberRole"},initialize:function(){var t=["is_admin","is_banned","is_confirmed","is_mod"],i=this;_.each(bpGroupManageMembersSettings.roles,function(e){_.isMatch(i.model.attributes,_.pick(e,t))&&i.model.set("role",_.pick(e,["id","name"]),{silent:!0})}),this.model.collection.on("reset",this.clearRow,this)},clearRow:function(){this.views.view.remove()},renderEditForm:function(){var e=this.model.get("id");this.render(),this.views.set("#edit-group-member-"+e,[new n.Views.GroupsMembersLabel({value:e,attributes:{for:"group-member"+e+"-role"}}),new n.Views.GroupRolesDropDown({id:"group-member"+e+"-role",omits:["all","banned"],currentRole:this.model.get("role").id}).render()])},resetRow:function(){return this.model.set("editing",!1),this.render()},getRoleObject:function(e){var t=bpGroupManageMembersSettings.roles;return _.isUndefined(t[e])?{}:_.extend({role:_.pick(t[e],["id","name"])},_.pick(t[e],["is_admin","is_banned","is_confirmed","is_mod"]))},doMemberAction:function(e){e.preventDefault();var t=r(e.target).data("action"),i=this;if("edit"===t)return this.model.set("editing",!0),this.renderEditForm();if("abort"===t)return this.resetRow();if("ban"===t||"unban"===t){e=this.getRoleObject("ban"===t?"banned":"member");if(!e)return this.resetRow();this.model.set("managingBan",!0),this.render(),this.views.set("#edit-group-member-"+this.model.get("id"),new n.Views.GroupMemberUpdatingInfo({value:t}).render()),this.model.save(e,{wait:!0,data:{action:t},success:function(e){return i.model.collection.remove(e),i.clearRow()},error:function(e,t){i.views.set("#edit-group-member-"+e.get("id"),new n.Views.GroupMemberErrorInfo({value:t.responseJSON.message}).render()),e.resetRequestOptions(),e.set("managingBan",!1)}})}else"remove"===t&&(this.model.set("removing",!0),this.render(),this.views.set("#edit-group-member-"+this.model.get("id"),new n.Views.GroupMemberUpdatingInfo({value:t}).render()),this.model.destroy({wait:!0,data:{},success:function(){return i.clearRow()},error:function(e,t){i.views.set("#edit-group-member-"+e.get("id"),new n.Views.GroupMemberErrorInfo({value:t.responseJSON.message}).render()),e.resetRequestOptions(),e.set("removing",!1)}}))},editMemberRole:function(e){var t=r(e.target).val(),i=this.getRoleObject(t),s=this.model.get("role").id,e="promote",o=this;if(t===this.model.get("role").id||!i)return this.resetRow();this.views.set("#edit-group-member-"+this.model.get("id"),(new n.Views.GroupMemberUpdatingInfo).render()),this.model.save(i,{wait:!0,data:{action:e="admin"===s||"mod"===s&&"member"===t?"demote":e,role:t},success:function(e){return o.model.collection.currentRole&&t!==o.model.collection.currentRole?(o.model.collection.remove(e),o.clearRow()):o.resetRow()},error:function(e,t){o.views.set("#edit-group-member-"+e.get("id"),new n.Views.GroupMemberErrorInfo({value:t.responseJSON.message}).render()),e.resetRequestOptions(),e.set("editing",!1)}})}}),n.Views.GroupMembersListHeader=n.View.extend({tagName:"thead",template:n.template("bp-manage-members-header")}),n.Views.GroupMembersListTable=n.View.extend({tagName:"tbody",initialize:function(){var e=bpGroupManageMembersSettings.preloaded||{},t=[];this.collection.on("reset",this.addListTableRows,this),e.body&&0<e.body.length?(_.each(e.body,function(e){t.push(new n.Models.groupMember(e))}),this.collection.currentPage=1,e.headers&&e.headers["X-WP-TotalPages"]&&(this.collection.totalPages=parseInt(e.headers["X-WP-TotalPages"],10)),e.headers&&e.headers["X-WP-Total"]&&(this.collection.totalGroupMembers=parseInt(e.headers["X-WP-Total"],10)),this.collection.reset(t)):this.collection.fetch({data:{exclude_admins:!1},reset:!0})},addListTableRows:function(e){var t;!this.views._views||(t=_.findWhere(this.views._views[""],{id:"bp-no-group-members"}))&&t.remove(),e.length?_.each(e.models,function(e){this.views.add(new n.Views.GroupMembersListRow({model:e}))},this):this.views.add(new n.Views.GroupMembersNoMatches({id:"bp-no-group-members"}))}}),n.Views.GroupMembersUI=n.View.extend({className:"group-members",initialize:function(){var e=new n.Collections.groupMembers;this.views.set("#group-roles-filter",[new n.Views.GroupsMembersLabel({attributes:{for:"group-members-role-filter"}}),new n.Views.GroupRolesDropDown({id:"group-members-role-filter",collection:e})]),this.views.set("#group-members-search-form",new n.Views.GroupMembersSearch({id:"group-members-search",collection:e})),this.views.set("#group-members-pagination",new n.Views.GroupsMembersPagination({collection:e})),this.views.set("#group-members-list-table",[new n.Views.GroupMembersListHeader,new n.Views.GroupMembersListTable({collection:e})])}}),n.manageGroupMembersUI=new n.Views.GroupMembersUI({el:"#group-manage-members-ui"}).render())}(window.wp||{},window.bp||{},jQuery);