var tribe_aggregator=tribe_aggregator||{};tribe_aggregator.fields={selector:{container:".tribe-ea",form:".tribe-ea-form",help:".tribe-ea-help",fields:".tribe-ea-field",dropdown:".tribe-ea-dropdown",origin_field:"#tribe-ea-field-origin",field_url_source:"#tribe-ea-field-url_source",eventbrite_url_source:"#tribe-ea-field-eventbrite_source",post_status:".tribe-ea-field-post_status",import_type_field:".tribe-import-type",media_button:".tribe-ea-media_button",datepicker:".tribe-datepicker",save_credentials_button:".enter-credentials .tribe-save",preview_container:".tribe-preview-container",preview_button:".tribe-preview:visible",refine_filters:".tribe-refine-filters",clear_filters_button:".tribe-clear-filters",finalize_button:".tribe-finalize",cancel_button:".tribe-cancel",schedule_delete_link:".tribe-ea-tab-scheduled a.submitdelete",tab_new:".tribe-ea-tab-new",action:"#tribe-action",view_filters:".tribe-view-filters"},media:{},$:{},construct:{},events:{},import_id:null,result_fetch_count:0,max_result_fetch_count:15,polling_frequency_index:0,polling_frequencies:[500,1e3,5e3,2e4],eventbrite:{refineControls:".tribe-refine-filters.eventbrite, .tribe-refine-filters.eventbrite .tribe-refine",refineControlsHideMap:{event:"tr.tribe-refine-filters",organizer:""},detect_type:function(e){if(!tribe_aggregator.source_origin_regexp.eventbrite)return null;var t=tribe_aggregator.source_origin_regexp.eventbrite,i={event:t+"e/[A-z0-9_-]+",organizer:t+"o/[A-z0-9_-]+"},r=void 0;return _.each(i,function(t,i){null!==new RegExp(t,"g").exec(e)&&(r=i)}),r}}},function(e,t,i,r){"use strict";i.init=function(){if(i.$.container=e(i.selector.container),i.$.form=e(i.selector.form),i.$.action=e(i.selector.action),i.$.fields=i.$.container.find(i.selector.fields),i.$.preview_container=e(i.selector.preview_container),i.origin=e("#tribe-ea-field-origin"),i.importType=e("#tribe-ea-field-url_import_type"),i.urlImport={startDate:e("#tribe-ea-field-url_start"),originalMinDate:function(){return e("#tribe-ea-field-url_start").datepicker("option","minDate")||""}},e.each(i.construct,function(e,t){t(i.$.fields)}),void 0!==typeof tribe_ev||void 0!==typeof tribe_ev.state){var a=e(document.getElementById("eventDetails"));a.data("datepicker_format")&&(tribe_ev.state.datepicker_format=a.data("datepicker_format"))}e(document).on("keypress",i.selector.fields,i.events.trigger_field_change).on("click",i.selector.save_credentials_button,i.events.trigger_save_credentials).on("click",i.selector.clear_filters_button,i.clear_filters).on("click",i.selector.finalize_button,i.finalize_manual_import).on("click",i.selector.preview_button,i.preview_import).on("click",i.selector.cancel_button,i.events.cancel_edit).on("click",i.selector.schedule_delete_link,i.events.verify_schedule_delete).on("click",i.selector.view_filters,i.events.toggle_view_filters).on("blur",i.selector.datepicker,i.date_helper).on("submit",i.selector.tab_new,i.events.suppress_submission).on("change",i.selector.import_type_field,function(){i.reset_preview();var t=e(this),r=e(this).next(i.selector.fields),a=t.val();r.val("schedule"===a?"daily":"").trigger("change"),i.$.form.attr("data-type",a),i.maybeLimitUrlStartDate()}).on("change",i.selector.origin_field,function(){var t=e(this),a=(e(this).data("select2"),t.val());i.$.form.attr("data-origin",a),i.reset_preview(),e(".tribe-bumpdown-active").removeClass("tribe-bumpdown-active"),e(".tribe-bumpdown:visible").hide(),"redirect"===e(this).val()&&(window.open("https://theeventscalendar.com/wordpress-event-aggregator/?utm_source=importoptions&utm_medium=plugin-tec&utm_campaign=in-app","_blank"),location.reload()),""!==a&&e(i.selector.post_status).val(r.default_settings[a].post_status).trigger("change"),i.maybeLimitUrlStartDate()}).on("change",i.selector.eventbrite_url_source,function(t){e(i.eventbrite.refineControls).show();var r=i.eventbrite.detect_type(e("#tribe-ea-field-eventbrite_source").val());if(r){var a=i.eventbrite.refineControlsHideMap[r];a&&e(a).hide()}}).on("change",i.selector.field_url_source,function(a){var n=e(this),l=(e(this).data("select2"),n.val()),o=null;if(l&&(t.each(r.source_origin_regexp,function(e,t){null!==new RegExp(e,"g").exec(l)&&(o=t)}),null!=o)){var s=e(i.selector.origin_field);if(s.find('option[value="'+o+'"]').length){var c=e("#tribe-ea-field-url_import_type"),d=c.val(),_=null;"schedule"===d&&(_=e("#tribe-ea-field-url_import_frequency").val()),c.val(""),s.val(o).trigger("change"),e("#tribe-ea-field-"+o+"_import_type").val(d).trigger("change"),"schedule"===d&&e("#tribe-ea-field-"+o+"_import_frequency").val(_).trigger("change"),"eventbrite"===o&&(e("#tribe-ea-field-"+o+"_source_type_url").trigger("click"),e("#tribe-ea-field-"+o+"_import_source").val("source_type_url").trigger("change")),e("#tribe-ea-field-"+o+"_source").val(l).trigger("change")}}}),e(".tribe-dependency").trigger("change"),tribe_timepickers.setup_timepickers(e(tribe_timepickers.selector.timepicker)),"edit"===i.$.action.val()&&(i.$.form.addClass("edit-form"),e(i.selector.finalize_button).html(r.l10n.edit_save)),"object"==typeof tribe_aggregator_save&&e(document).trigger("tribe_aggregator_init_notice")},i.preview_import=function(t){t.preventDefault();var r=e(".tribe-ea-form.tribe-validation");if(i.reset_post_status(),r.trigger("validation.tribe"),!tribe.validation.hasErrors(r)){i.reset_polling_counter();e(".tribe-fetch-warning-message").html("");var a=e("#tribe-post_id");a.data("value",a.val()),a.val("");var n=e("#tribe-import_id");n.data("value",n.val()),n.val("");var l=e(i.selector.preview_button),o=(r=l.closest("form")).serialize();a.val(a.data("value")),n.val(a.data("value")),i.$.preview_container.addClass("tribe-fetching").removeClass("tribe-fetch-error"),i.$.form.removeClass("show-data"),l.prop("disabled",!0);var s=e(".dataTable").data("table");void 0!==s&&s.clear().draw(),"edit"===i.$.action.val()?i.preview_save_import(o):i.create_import(o)}},i.reset_post_status=function(){var t=e(i.selector.origin_field),a=0===t.length?"":t.val();""!==a&&e(i.selector.post_status).val(r.default_settings[a].post_status).trigger("change")},i.reset_polling_counter=function(){i.polling_frequency_index=0,i.result_fetch_count=0},i.reset_form=function(){i.$.fields.val("").trigger("change"),e('[id$="import_frequency"]').val("daily").trigger("change"),i.$.form.removeClass("show-data")},i.reset_preview=function(){i.$.form.removeClass("show-data"),e(".tribe-fetched, .tribe-fetching, .tribe-fetch-error").removeClass("tribe-fetched tribe-fetching tribe-fetch-error")},i.clear_filters=function(){e(i.selector.refine_filters).find("input, select").val("").trigger("change")},i.preview_save_import=function(t){e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_preview_import",data:t,dataType:"json"}).done(i.handle_preview_create_results)},i.create_import=function(t){e.ajax({type:"POST",url:ajaxurl+"?action=tribe_aggregator_create_import",data:t,dataType:"json"}).done(i.handle_preview_create_results)},i.handle_preview_create_results=function(a){if(!a.success){var n=a.data;return t.isString(n)||(n=n.message),void i.display_fetch_error(["<b>",r.l10n.preview_fetch_error_prefix,"</b>"," "+n].join(" "))}if(i.import_id=a.data.data.import_id,e("#tribe-import_id").val(i.import_id),void 0!==a.data.data.items)return i.init_datatable(a.data.data),void i.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched");i.$.container.find(".spinner-message").html(r.l10n.preview_polling[0]),setTimeout(i.poll_for_results,i.polling_frequencies[i.polling_frequency_index])},i.poll_for_results=function(){i.result_fetch_count++,e.ajax({type:"GET",url:ajaxurl+"?action=tribe_aggregator_fetch_import&import_id="+i.import_id,dataType:"json"}).done(function(t){if(void 0!==t.data.warning&&t.data.warning){var a=t.data.warning;i.display_fetch_warning(["<b>",r.l10n.preview_fetch_warning_prefix,"</b>"," "+a].join(" "))}var n;if(!t.success)return void 0!==t.data.message?n=t.data.message:void 0!==t.data[0].message&&(n=t.data[0].message),void i.display_fetch_error(["<b>",r.l10n.preview_fetch_error_prefix,"</b>"," "+n].join(" "));"error"===t.data.status?i.display_fetch_error(t.data.message):"success"!==t.data.status?(i.result_fetch_count>i.max_result_fetch_count&&(i.polling_frequency_index++,i.$.container.find(".spinner-message").html(r.l10n.preview_polling[i.polling_frequency_index]),i.result_fetch_count=0),void 0===i.polling_frequencies[i.polling_frequency_index]?i.display_fetch_error(r.l10n.preview_timeout):setTimeout(i.poll_for_results,i.polling_frequencies[i.polling_frequency_index])):(t.data.data.items=t.data.data.events,i.init_datatable(t.data.data),i.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetched"),e(i.selector.preview_button).prop("disabled",!1))})},i.init_datatable=function(t){var a=!1,n="csv"===($=e(i.selector.origin_field).val()),l=e('[id$="import_type"]:visible'),o="manual";if(void 0!==r.default_settings[$])for(var s in r.default_settings[$]){if(r.default_settings[$].hasOwnProperty(s))e("#tribe-ea-field-"+s).val(r.default_settings[$][s]).trigger("change")}if(l.length&&(o=e("#"+l.first().attr("id").replace("s2id_","")).val()),"manual"!==o||t.items.length){l.length&&"manual"!==o||(a=!0);var c=i.$.preview_container.find(".data-container table"),d=[];for(var _ in t.items){var u=t.items[_];u.checkbox=a?'<input type="checkbox">':"",u.all_day?u.start_time=r.l10n.all_day:(void 0!==u.start_meridian&&u.start_meridian||(parseInt(u.start_hour,10)>11?u.start_meridian=r.l10n.pm:u.start_meridian=r.l10n.am),u.start_hour>12&&(u.start_hour=u.start_hour-12),u.start_time=(0===parseInt(u.start_hour,10)?12:u.start_hour)+":"+("00"+u.start_minute).slice(-2),u.start_time+=" "+u.start_meridian),d.push(u)}a&&!n?c.addClass("display-checkboxes"):c.removeClass("display-checkboxes"),i.$.form.addClass("show-data");var f,p={lengthMenu:[[5,10,25,50,-1],[5,10,25,50,tribe_l10n_datatables.pagination.all]],order:[[1,"asc"]],columnDefs:[{cellType:"th",className:"check-column",orderable:!1,targets:0}],data:d};if(void 0!==t.columns){p.columns=[{data:"checkbox"}];var v=c.find("thead tr"),g=c.find("tfoot tr"),m=e({}),b="",h="";if(v.find("th:first").nextAll().remove(),g.find("th:first").nextAll().remove(),n){var w=c.closest(".data-container");c.closest(".data-container").addClass("csv-data"),w.find(".tribe-preview-message .tribe-csv-filename").html(e("#tribe-ea-field-csv_file_name").text()),v.closest("thead").prepend('<tr class="tribe-column-map"><th scope="row" class="check-column column-cb"></th></tr>'),m=e(".tribe-column-map"),h=(h=e("#tribe-ea-field-csv_content_type").val()).replace("tribe_",""),b=e("#tribe-csv-column-map-"+h).html()}var y=0;for(_ in t.columns){if(p.columns.push({data:t.columns[_]}),v.append('<th scope="col">'+t.columns[_]+"</th>"),g.append('<th scope="col">'+t.columns[_]+"</th>"),n){var x=t.columns[_].toLowerCase().replace(/^\s+|\s+$/g,"").replace(/\s/g,"_").replace(/[^a-z0-9_]/g,"");m.append('<th scope="col">'+b.replace('name="column_map[]"','name="aggregator[column_map]['+y+']" id="column-'+y+'"')+"</th>");var k=m.find("#column-"+y);void 0!==r.csv_column_mapping[h][y]&&(x=r.csv_column_mapping[h][y]),k.find('option[value="'+x+'"]').prop("selected",!0)}y++}p.scrollX=!0}else p.columns=[{data:"checkbox"},{data:"start_date"},{data:"start_time"},{data:"end_date"},{data:"title"}],p.autoWidth=!1;c.tribeDataTable(p),i.wrap_cell_content(),c.on("select.dt",i.events.twiddle_finalize_button_text).on("deselect.dt",i.events.twiddle_finalize_button_text).on("draw.dt",i.wrap_cell_content),"new"===i.$.action.val()&&(f="manual"===o&&n?r.l10n.import_all_no_number:"manual"===o?r.l10n.import_all.replace("%d",d.length):r.l10n.create_schedule),e(i.selector.finalize_button).html(f)}else{var $=t.origin,C=void 0!==r.l10n[$]&&void 0!==r.l10n[$].no_results?r.l10n[$].no_results:r.l10n.no_results;i.display_fetch_error(C)}},i.wrap_cell_content=function(){e(".dataTable").find("tbody td").each(function(){var t=e(this);t.html('<div class="tribe-td-height-limit">'+t.html()+"</div>")})},i.display_fetch_error=function(t){var r=e(".tribe-fetch-error-message");i.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-error"),r.html(""),i.display_error(r,t),e(i.selector.preview_button).prop("disabled",!1)},i.display_fetch_warning=function(t){var r=e(".tribe-fetch-warning-message");i.$.preview_container.removeClass("tribe-fetching").addClass("tribe-fetch-warning"),r.html(""),i.display_warning(r,t)},i.display_error=function(e,t){e.prepend(['<div class="notice notice-error">',"<p>",t,"</p>","</div>"].join(""))},i.display_warning=function(e,t){e.prepend(['<div class="notice notice-warning">',"<p>",t,"</p>","</div>"].join(""))},i.display_success=function(e,t){e.prepend(['<div class="notice notice-success">',"<p>",t,"</p>","</div>"].join(""))},i.save_credentials=function(t){var i=t.find(".tribe-fieldset").find("input").serialize(),r=ajaxurl+"?action=tribe_aggregator_save_credentials";e.post(r,i).done(function(e){e.success&&(t.addClass("credentials-entered"),t.find('[name="has-credentials"]').val(1).trigger("change"))})},i.finalize_manual_import=function(){var t=e("#tribe-ea-field-origin").val(),a=e(".dataTable"),n=window.tribe_data_table;if(a.hasClass("display-checkboxes")){var l=n.rows({selected:!0});if(l[0].length||(l=n.rows()),!l[0].length)return void i.display_error(e(".tribe-finalize-container"),r.l10n.events_required_for_manual_submit);var o=l.data(),s=[],c=null;if("meetup"===t?c="meetup_id":"eventbrite"===t?c="eventbrite_id":"ical"===t||"ics"===t||"gcal"===t?c="uid":"url"===t&&(c="id"),null!==c){for(var d in o)isNaN(d)||void 0!==o[d][c]&&s.push(o[d][c]);e("#tribe-selected-rows").text(JSON.stringify(s))}else e("#tribe-selected-rows").text("all")}else e("#tribe-selected-rows").text("all");e(".dataTables_scrollBody").find('[name^="aggregator[column_map]"]').remove(),i.$.form.trigger("submit")},i.search_id=function(e){var t=null;return void 0!==e.id?t=e.id:void 0!==e.ID?t=e.ID:void 0!==e.value&&(t=e.value),null==e?null:t},i.construct.dropdown=function(t){var i=function(t){var i=e(t.element);return"string"==typeof i.data("subtitle")&&(t.text=t.text+'<br><span class="tribe-dropdown-subtitle">'+i.data("subtitle")+"</span>"),t.text},r={formatResult:i,formatSelection:i};return tribe_dropdowns.dropdown(t.filter(".tribe-ea-dropdown"),r),t},i.construct.media_button=function(t){var r=t.filter(i.selector.media_button);return"undefined"!=typeof wp&&wp.media&&wp.media.editor?(r.each(function(){var t=e(this),r=t.data("input"),a=e("#"+r),n=e("#"+r+"_name"),l=i.media[r]=wp.media({title:t.data("mediaTitle"),library:{type:t.data("mimeType")},multiple:!1});l.on("select",function(){var e=l.state().get("selection");e&&e.each(function(e){a.data({id:e.attributes.id,text:e.attributes.title}),a.val(e.attributes.id),a.trigger("change"),n.html(e.attributes.filename),n.attr("title",e.attributes.filename)})})}),i.$.container.on("click",i.selector.media_button,function(t){if(t.preventDefault(),e(this).is(":visible")){var r=e(this).data("input");return i.media[r].open(r),!1}}),r):r},i.events.trigger_field_change=function(){e(this).trigger("change")},i.events.trigger_save_credentials=function(){i.save_credentials(e(this).closest(".enter-credentials"))},i.events.suppress_submission=function(t){e("#tribe-ea-field-origin").val();if(e("#tribe-selected-rows").val().length)return!0;t.preventDefault()},i.events.twiddle_finalize_button_text=function(t,a){if("new"===i.$.action.val()){var n=a.rows({selected:!0})[0].length,l=r.l10n.import_checked;n||(l=r.l10n.import_all,n=a.rows()[0].length),l=l.replace("%d",n),e(i.selector.finalize_button).html(l)}},i.events.cancel_edit=function(e){e.preventDefault();var t=window.location.href;t=(t=t.replace("tab=edit","tab=scheduled")).replace(/id=\d+/,""),window.location.href=t},i.events.verify_schedule_delete=function(){return confirm(r.l10n.verify_schedule_delete)},i.events.toggle_view_filters=function(t){t.preventDefault();var i=e(this);i.toggleClass("tribe-active"),i.is(".tribe-active")?i.html(r.l10n.hide_filters):i.html(r.l10n.view_filters)},i.date_helper=function(){var t;if((t=e(this)).hasClass("tribe-datepicker")){var i=t.val();if(""!==i&&null!==i){var r=t.attr("id").match("tribe-ea-field-(.*)_start")[1];""!==r&&null!==r&&jQuery("#tribe-date-helper-date-"+r).html(i)}}},i.maybeLimitUrlStartDate=function(){"url"===i.origin.val()&&("schedule"!==i.importType.val()?i.urlImport.startDate.data("datepicker-min-date",null):i.urlImport.startDate.data("datepicker-min-date","today"))},e(i.init)}(jQuery,_,tribe_aggregator.fields,tribe_aggregator);