"use strict";jQuery(function(n){var o={Models:{},Views:{}};o.Models.SelectableItems=Backbone.Collection.extend({selected:function(){return this.filter(function(e){return 1==e.get("selected")})},deselect_all:function(){this.each(function(e){e.set("selected",!1)})},selected_ids:function(){return _.pluck(this.selected(),"id")},select:function(t){_.isArray(t)||(t=[t]),this.each(function(e){0<=_.indexOf(t,e.id)&&e.set("selected",!0)}),this.trigger("selected")}}),o.Views.SelectTag=Backbone.View.extend({tagName:"select",collection:null,multiple:!1,value_field:"id",text_field:"title",initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this),this.collection.on("add",this.render_new_option,this),this.collection.on("remove",this.remove_existing_option,this),this.collection.on("reset",this.empty_list,this)},events:{change:"selection_changed"},empty_list:function(){this.$el.empty()},render_new_option:function(e){this.$el.append(new this.Option({model:e,value_field:this.value_field,text_field:this.text_field}).render().el)},remove_existing_option:function(e){this.$el.find("option[value='"+e.id+"']").remove()},selection_changed:function(){var t=_.map(this.$el.find(":selected"),function(e){return n(e).val()});this.collection.each(function(e){0<=_.indexOf(t,e.id)||0<=_.indexOf(t,e.id.toString())?e.set("selected",!0):e.set("selected",!1)}),this.collection.trigger("selected"),this.onSelect&&this.onSelect()},render:function(){return this.$el.empty(),this.multiple&&(this.$el.prop("multiple",!0),this.$el.attr("multiple","multiple")),this.collection.each(function(e){e=new this.Option({model:e,value_field:this.value_field,text_field:this.text_field});this.$el.append(e.render().el)},this),this.width&&this.$el.width(this.width),this},Option:Backbone.View.extend({tagName:"option",model:null,initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this),this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.model.get(this.text_field).replace(/\\&/g,"&").replace(/\\'/g,"'")),this.$el.prop({value:"id"==this.value_field?this.model.id:this.model.get(this.value_field)}),1==this.model.get("selected")&&this.$el.prop("selected",!0).attr("selected","selected"),this}})}),o.Views.Chosen=Backbone.View.extend({tagName:"span",initialize:function(e){this.options=e||{},this.collection=this.options.collection,this.select_tag=new o.Views.SelectTag(this.options),this.collection.on("change",this.selection_changed,this)},selection_changed:function(e){_.isUndefined(e.changed.selected)&&this.render()},render:function(){return this.$el.append(this.select_tag.render().$el),this.options.width&&this.select_tag.$el.width(this.options.width),this.select2_opts={placeholder:this.options.placeholder},this.select_tag.$el.select2(this.select2_opts),this}}),o.DisplayTab={Models:{},Views:{},App:{}},o.Models.Remote_Collection=o.Models.SelectableItems.extend({fetch_limit:5e3,in_progress:!1,fetch_url:photocrati_ajax.rest_url,action:"",extra_data:{},_create_request:function(e,t){var i,s={nonce:igw_data.nonce};for(i in this.extra_data){var l=this.extra_data[i];void 0===s[i]&&(s[i]={}),void 0!==l.toJSON&&(l=l.toJSON()),s[i]=_.extend(s[i],l)}return s},_add_item:function(e){this.push(e)},fetch:function(e,t){var i=this;this.in_progress=!0,n.ajax({url:this.fetch_url+this.action,data:this._create_request(e,t),beforeSend:function(e){e.setRequestHeader("X-WP-Nonce",igw_data.nonce)}}).done(function(e){"undefined"!=typeof _&&(e=_.isObject(e)?e:JSON.parse(e)).items&&(_.each(e.items,function(e){i._add_item(e)}),i.in_progress=!1,i.trigger("finished_fetching"))})}}),o.DisplayTab.Models.Displayed_Gallery=Backbone.Model.extend({defaults:{source:null,container_ids:[],entity_ids:[],display_type:null,display_settings:{},exclusions:[],sortorder:[],slug:null},to_shortcode:function(){retval=null;function e(e,t){if(e=e[t],void 0!==igw_data.shortcode_defaults[t]&&igw_data.shortcode_defaults[t]==e&&(e=null),e=_.isArray(e)?0<e.length?e.join(","):null:e)return e=(e=e.toString().replace("[","&#91;")).toString().replace("]","&#93;"),(t=void 0!==igw_data.shortcode_attr_replacements[t]?igw_data.shortcode_attr_replacements[t]:t)+'="'+e+'"'}var t,i=o.DisplayTab.instance.display_types.find_by_name_or_alias(this.get("display_type")),s=this.toJSON(),l=(s.display_type=i.get_shortcode_value(),"[ngg"),n=null;for(t in(n=e(s,"source"))&&(l+=" "+n),(n=e(s,"container_ids"))&&(l+=" "+n),(n=e(s,"entity_ids"))&&(l+=" "+n),(n=e(s,"exclusions"))&&(l+=" "+n),(n=e(s,"sortorder"))&&(l+=" "+n),s)if(!(-1<["source","container_ids","entity_ids","exclusions","sortorder","__defaults_set","id_field","post_category","ID"].indexOf(t)))if("display_settings"==t)for(var a in s[t])(n=e(s[t],a))&&(l+=" "+n);else(n=e(s,t))&&(l+=" "+n);return l+="]"}}),o.DisplayTab.Models.Source=Backbone.Model.extend({idAttribute:"name",defaults:{title:"",name:"",selected:!1}}),o.DisplayTab.Models.Source_Collection=o.Models.SelectableItems.extend({model:o.DisplayTab.Models.Source,selected_value:function(){var e=null,t=this.selected();return e=0<t.length?t[0].get("name"):e},find_by_name_or_alias:function(t){return this.find(function(e){return e.get("name")==t||_.isArray(e.get("aliases"))&&-1<e.get("aliases").indexOf(t)})}}),o.DisplayTab.Models.Gallery=Backbone.Model.extend({idAttribute:igw_data.gallery_primary_key,defaults:{title:"",name:""}}),o.DisplayTab.Models.Gallery_Collection=o.Models.Remote_Collection.extend({model:o.DisplayTab.Models.Gallery,action:"ngg/v1/admin/attach_to_post/galleries"}),o.DisplayTab.Models.Album=Backbone.Model.extend({defaults:{title:"",name:""}}),o.DisplayTab.Models.Album_Collection=o.Models.Remote_Collection.extend({model:o.DisplayTab.Models.Album,action:"ngg/v1/admin/attach_to_post/albums"}),o.DisplayTab.Models.Tag=Backbone.Model.extend({defaults:{title:""}}),o.DisplayTab.Models.Tag_Collection=o.Models.Remote_Collection.extend({model:o.DisplayTab.Models.Tag,action:"ngg/v1/admin/attach_to_post/tags"}),o.DisplayTab.Models.Display_Type=Backbone.Model.extend({idAttribute:"name",defaults:{title:""},is_compatible_with_source:function(e){var t=!0;for(index in e.get("returns")){var i=e.get("returns")[index];if(_.indexOf(this.get("entity_types"),i)<0){t=!1;break}}return t},get_shortcode_value:function(){var e=this.id,t=this.get("aliases");return e=_.isArray(t)&&0<t.length?t[0]:e}}),o.DisplayTab.Models.Display_Type_Collection=o.Models.SelectableItems.extend({model:o.DisplayTab.Models.Display_Type,selected_value:function(){var e=this.selected();return 0<e.length?e[0].get("name"):null},find_by_name_or_alias:function(t){return this.find(function(e){return e.get("name")==t||_.isArray(e.get("aliases"))&&-1<e.get("aliases").indexOf(t)})}}),o.DisplayTab.Models.Entity=Backbone.Model.extend({entity_id:function(){return this.get(this.get("id_field"))},is_excluded:function(){return current_value=this.get("exclude"),!_.isUndefined(current_value)&&(_.isBoolean(current_value)?current_value:0!=parseInt(current_value))},is_included:function(){return!this.is_excluded()},is_gallery:function(){return retval=!1,retval=1==this.get("is_gallery")?!0:retval},is_album:function(){return retval=!1,retval=1==this.get("is_album")?!0:retval},is_image:function(){return!this.is_album()&&!this.is_gallery()},alttext:function(){return this.is_image()?this.get("alttext"):this.is_gallery()?this.get("title"):this.is_album()?this.get("name"):void 0}}),o.DisplayTab.Models.Entity_Collection=o.Models.Remote_Collection.extend({model:o.DisplayTab.Models.Entity,action:"ngg/v1/admin/attach_to_post/images",_add_item:function(e){e.exclude=1==parseInt(e.exclude),e.is_gallery=1==parseInt(e.is_gallery),e.is_album=1==parseInt(e.is_album),this.push(e)},entity_ids:function(){return this.map(function(e){return e.entity_id()})},included_ids:function(){return _.compact(this.map(function(e){if(e.is_included())return e.entity_id()}))},excluded_ids:function(){return _.compact(this.map(function(e){if(!e.is_included())return e.entity_id()}))}}),o.DisplayTab.Models.SortOrder=Backbone.Model.extend({}),o.DisplayTab.Models.SortOrder_Options=o.Models.SelectableItems.extend({model:o.DisplayTab.Models.SortOrder}),o.DisplayTab.Models.SortDirection=Backbone.Model.extend({}),o.DisplayTab.Models.SortDirection_Options=Backbone.Collection.extend({model:o.DisplayTab.Models.SortDirection}),o.DisplayTab.Models.Slug=Backbone.Model.extend({}),o.DisplayTab.Views.Source_Config=Backbone.View.extend({el:"#source_configuration",selected_view:null,initialize:function(){this.sources=o.DisplayTab.instance.sources,this.sources.on("selected",this.render,this),_.bindAll(this,"render"),this.render()},render:function(){var e=new o.Views.Chosen({id:"source_select",collection:this.sources,placeholder:"Select a source",width:500,onSelect:function(){n(".main_menu_tab").off("scroll")}}),t=_.template('<tr><td id="source_column"></td><td><label><%- sources %></label></td></tr>'),t=(this.$el.html(t(igw_data.i18n)),this.$el.find("#source_column").append(e.render().el),this.sources.selected());return t.length&&(e=t.pop().id,t=(e=String(e)).charAt(0).toUpperCase()+e.slice(1)+"Source",void 0!==o.DisplayTab.Views[t])&&(e=new o.DisplayTab.Views[t],this.$el.append(e.render().el)),this}}),o.DisplayTab.Views.Slug_Config=Backbone.View.extend({el:"#slug_configuration",selected_view:null,initialize:function(){this.displayed_gallery=o.DisplayTab.instance.displayed_gallery,this.slug=o.DisplayTab.instance.displayed_gallery.get("slug"),this.render()},render:function(){var e=this,t=n("<input>").prop({type:"text",name:"slug",value:this.slug,placeholder:igw_data.i18n.optional,id:"field_slug"}),i=(t.on("input",function(){n(this).val(n(this).val().replace(/\s|\?|\\|\/|&|=|\[|]|#/gm,"-")),e.displayed_gallery.set("slug",n(this).val())}),t.on("change",function(){n(this).val(n(this).val().replace(/^-*/gm,"").replace(/-*$/gm,"")),e.displayed_gallery.set("slug",n(this).val())}),_.template('<tr><td id="slug_label"><label for="field_slug" class="tooltip" title="<%- slug_tooltip %><"><<%- slug_label %></label></td><td id="slug_column"></td></tr>'));return this.$el.append(i(igw_data.i18n)),this.$el.find("#slug_column").append(t),this}}),o.DisplayTab.Views.Display_Type_Selector=Backbone.View.extend({el:"#display_type_selector",initialize:function(){this.display_types=o.DisplayTab.instance.display_types,this.display_type_order_base=o.DisplayTab.instance.display_type_order_base,this.display_type_order_step=o.DisplayTab.instance.display_type_order_step,this.sources=o.DisplayTab.instance.sources,this.render()},selection_changed:function(t){this.display_types.each(function(e){e.get("name")==t?e.set("selected",!0):e.set("selected",!1)}),n(".display_settings_form").each(function(){($this=n(this)).attr("rel")==t?$this.removeClass("hidden"):$this.addClass("hidden")})},render:function(){var i=this.sources.selected(),i=0<i.length&&i[0],s=(this.$el.empty(),this.display_type_order_base),l=this.display_type_order_step;return this.display_types.each(function(e){if(i&&!e.is_compatible_with_source(i)){var t=n("#display_type_tab_content:visible");if(0==t.length)return;if("hidden"==t.css("visibility"))return}t=new o.DisplayTab.Views.DisplayType;t.model=e,t.on("selected",this.selection_changed,this),this.display_types.selected_value()||(e.set("selected",!0),this.selection_changed(e.id));e=(e=e.get("view_order"))||s,e=Math.floor(e/l);this.$el.append(t.render().el)},this),this.$el.append('<li class="clear" style="height: 10px; list-style-type:none" />'),this}}),o.DisplayTab.Views.DisplayType=Backbone.View.extend({className:"display_type_preview",events:{click:"clicked"},clicked:function(e){this.trigger("selected",this.model.get("name"))},render:function(){var e=n('<label style="display: block; cursor: pointer;"/>').addClass("image_container"),t=n("<img/>").attr({src:this.model.get("preview_image_url"),title:this.model.get("title"),alt:this.model.get("alt")}),i=n("<div/>"),s=n("<input/>").prop({type:"radio",value:this.model.get("name"),title:this.model.get("title"),name:"display_type",checked:this.model.get("selected")}),l=n("<br>");return e.append(i),e.append(t),e.append("<br>"),e.append(this.model.get("title").replace(/nextgen /gi,"")),i.append(s),i.append(l),this.$el.append(e),this}}),o.DisplayTab.Views.Preview_Area=Backbone.View.extend({el:"#preview_area",initialize:function(){this.entities=o.DisplayTab.instance.entities,this.sources=o.DisplayTab.instance.sources,this.displayed_gallery=o.DisplayTab.instance.displayed_gallery,this.entity_list=n("<ul/>").attr("id","entity_list").append('<li class="clear"/>'),this.entities.on("add",this.render_entity,this),this.entities.on("remove",this.remove_entity,this),this.entities.on("reset",this.entities_reset,this),this.entities.on("change:sortorder",function(e){this.entities.remove(e,{silent:!0}),this.entities.add(e,{at:e.changed.sortorder,silent:!0}),this.displayed_gallery.set("sortorder",this.entities.entity_ids()),"undefined"!=typeof console&&void 0!==console.log&&console.log(this.entities.entity_ids()),this.displayed_gallery.set("order_by","sortorder")},this),this.sources.on("selected",this.render,this),this.render()},events:{opened:"entities_reset"},entities_reset:function(e){this.entities.reset(null,{silent:!0}),this.entity_list.empty().append('<li class="clear"/>'),this.entities.in_progress||this.entities.fetch()},render_entity:function(e){var t=new this.EntityElement({model:e});this.entity_list.find(".clear").before(t.render().$el),t.$el.css("visibility","hidden"),setTimeout(function(){t.$el.css("visibility","visible")},0),1==this.$el.find(".no_entities").length?this.render():1<this.entities.length&&this.entity_list.sortable("refresh")},remove_entity:function(e){e=this.id=e.get("id_field")+"_"+e.entity_id();this.entity_list.find("#"+e).remove();this.entity_list.sortable("refresh"),0==this.entities.length&&this.render_no_images_notice()},render_no_images_notice:function(){this.$el.empty(),this.$el.append("<p class='no_entities'>"+igw_data.i18n.no_entities+"</p>")},render:function(){return this.$el.empty(),0<this.entities.length&&0<this.displayed_gallery.get("container_ids").length?(this.$el.append(new this.RefreshButton({entities:this.entities}).render().el),this.$el.append(new this.SortButtons({entities:this.entities,displayed_gallery:this.displayed_gallery,sources:this.sources}).render().el),this.$el.append(new this.ExcludeButtons({entities:this.entities}).render().el),this.$el.append(this.entity_list),this.entity_list.sortable({placeholder:"placeholder",forcePlaceholderSize:!0,containment:"parent",opacity:.7,revert:!0,dropOnEmpty:!0,start:function(e,t){return t.placeholder.css({height:t.item.height()}),!0},stop:function(e,t){t.item.trigger("drop",t.item.index())}}),this.entity_list.disableSelection()):this.render_no_images_notice(),this},RefreshButton:Backbone.View.extend({className:"refresh_button button-primary",tagName:"input",label:"Refresh",events:{click:"clicked"},clicked:function(){this.entities.reset()},initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this)},render:function(){return this.$el.attr({value:this.label,type:"button"}),this}}),ExcludeButtons:Backbone.View.extend({className:"header_row",initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this)},render:function(){this.$el.empty(),this.$el.append('<span style="margin-right: 8px;">Exclude:</span>');var e=new this.Button({value:!0,text:"All",entities:this.entities}),e=(this.$el.append(e.render().el),this.$el.append('<span class="separator">|</span>'),new this.Button({value:!1,text:"None",entities:this.entities}));return this.$el.append(e.render().el),this},Button:Backbone.View.extend({tagName:"a",value:1,text:"",events:{click:"clicked"},initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this)},clicked:function(e){e.preventDefault(),this.entities.each(function(e){e.set("exclude",this.value)},this)},render:function(){return this.$el.text(this.text).attr("href","#"),this}})}),SortButtons:Backbone.View.extend({className:"header_row",initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this),this.sortorder_options=new o.DisplayTab.Models.SortOrder_Options,this.sortorder_options.on("change:selected",this.sortoption_changed,this),this.sortdirection_options=new o.DisplayTab.Models.SortDirection_Options([{value:"ASC",title:"Ascending",selected:"ASC"==this.displayed_gallery.get("order_direction")},{value:"DESC",title:"Descending",selected:"DESC"==this.displayed_gallery.get("order_direction")}]),this.sortdirection_options.on("change:selected",this.sortdirection_changed,this),this.displayed_gallery.on("change:order_by",this.displayed_gallery_order_changed,this),this.displayed_gallery.on("change.order_direction",this.displayed_gallery_order_dir_changed,this)},populate_sorting_fields:function(){var e=this.sources.selected().pop().get("returns");-1!==_.indexOf(e,"image")?this.fill_image_sortorder_options():this.fill_gallery_sortorder_options()},create_sortorder_option:function(e,t){return new o.DisplayTab.Models.SortOrder({name:e,title:t,value:e,selected:this.displayed_gallery.get("order_by")==e})},fill_image_sortorder_options:function(){this.sortorder_options.reset(),this.sortorder_options.push(this.create_sortorder_option("","None")),this.sortorder_options.push(this.create_sortorder_option("sortorder","Custom")),this.sortorder_options.push(this.create_sortorder_option(o.DisplayTab.instance.image_key,"Image ID")),this.sortorder_options.push(this.create_sortorder_option("filename","Filename")),this.sortorder_options.push(this.create_sortorder_option("alttext","Alt/Title Text")),this.sortorder_options.push(this.create_sortorder_option("imagedate","Date/Time"))},fill_gallery_sortorder_options:function(){this.sortorder_options.reset(),this.sortorder_options.push(this.create_sortorder_option("","None")),this.sortorder_options.push(this.create_sortorder_option("sortorder","Custom")),this.sortorder_options.push(this.create_sortorder_option("name","Name")),this.sortorder_options.push(this.create_sortorder_option("galdesc","Description"))},displayed_gallery_order_changed:function(e){this.sortorder_options.findWhere({value:e.get("order_by")}).set("selected",!0)},displayed_gallery_order_dir_changed:function(e){this.sortdirection_options.findWhere({value:e.get("order_direction")}).set("selected",!0)},sortoption_changed:function(t){this.sortorder_options.each(function(e){e.set("selected",t.get("value")==e.get("value"),{silent:!0})}),this.displayed_gallery.set("sortorder",[]);var e=t.get("value");0==t.get("value").length&&(e="sortorder"),this.displayed_gallery.set("order_by",e),this.entities.reset(),this.$el.find("a.sortorder").each(function(){var e=n(this);e.attr("value")==t.get("value")?e.addClass("selected"):e.removeClass("selected")})},sortdirection_changed:function(t){this.sortdirection_options.each(function(e){e.set("selected",t.get("value")==e.get("value"),{silent:!0})}),this.displayed_gallery.set("order_direction",t.get("value")),this.entities.reset(),this.$el.find("a.sortdirection").each(function(){var e=n(this);e.attr("value")==t.get("value")?e.addClass("selected"):e.removeClass("selected")})},render:function(){return this.$el.empty(),this.populate_sorting_fields(),this.$el.append('<span style="margin-right: 8px;">Sort By:</span>'),this.sortorder_options.each(function(e,t){e=new this.Button({model:e,className:"sortorder"});this.$el.append(e.render().el),this.sortorder_options.length-1>t&&this.$el.append('<span class="separator">|</span>')},this),this.$el.append('<span style="margin: 0 8px 0 40px;">Order By:</span>'),this.sortdirection_options.each(function(e,t){e=new this.Button({model:e,className:"sortdirection"});this.$el.append(e.render().el),this.sortdirection_options.length-1>t&&this.$el.append('<span class="separator">|</span>')},this),this},Button:Backbone.View.extend({tagName:"a",initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this)},events:{click:"clicked"},clicked:function(e){e.preventDefault(),this.model.set("selected",!0)},render:function(){return this.$el.prop({value:this.model.get("value"),href:"#"}),this.$el.text(this.model.get("title")),this.model.get("selected")&&this.$el.addClass("selected"),this}})}),EntityElement:Backbone.View.extend({tagName:"li",events:{drop:"item_dropped"},initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this),this.initTime=(new Date).getTime(),this.model.on("change",this.render,this),0==this.model.get("sortorder")&&this.model.set("sortorder",-1,{silent:!0}),this.id=this.model.get("id_field")+"_"+this.model.entity_id()},item_dropped:function(e,t){o.DisplayTab.instance.displayed_gallery.set("order_by","sortorder"),this.model.set("sortorder",t)},render:function(){this.$el.empty();var e=n("<div/>").addClass("preview_item"),t=n("<div/>").addClass("image_container"),i=this.model.alttext().replace(/\\&/g,"&").replace(/\\'/g,"'"),s=this.initTime,i=(t.attr({title:i,style:"background-image: url('"+this.model.get("thumb_url")+"?timestamp"+s+"')"}),this.$el.append(e).addClass("ui-state-default"),e.append(t),n("<div/>").addClass("exclude_container")),s=n("<label/>"),t=(s.append(igw_data.i18n.exclude_question),new this.ExcludeCheckbox({model:this.model}));return s.append(t.render().el),i.append(s),e.append(i),this},ExcludeCheckbox:Backbone.View.extend({tagName:"input",events:{change:"entity_excluded"},type_set:!1,entity_excluded:function(e){this.model.set("exclude",e.target.checked)},initialize:function(e){this.options=e||{},_.each(this.options,function(e,t){this[t]=e},this),this.model.on("change:exclude",this.render,this)},render:function(){return this.type_set||(this.$el.attr("type","checkbox"),this.type_set=!0),this.model.is_excluded()?this.$el.prop("checked",!0):this.$el.prop("checked",!1),this}})})}),o.DisplayTab.Views.GalleriesSource=Backbone.View.extend({tagName:"tbody",initialize:function(){this.galleries=o.DisplayTab.instance.galleries},render:function(){var e=new o.Views.Chosen({collection:this.galleries,placeholder:igw_data.i18n.select_gallery,multiple:!0,width:500}),t=n('<tr><td class="galleries_column"></td><td><label>'+igw_data.i18n.galleries+"</label></td></tr>");return this.$el.empty(),this.$el.append(t),this.$el.find(".galleries_column").append(e.render().el),this}}),o.DisplayTab.Views.AlbumsSource=Backbone.View.extend({tagName:"tbody",initialize:function(){this.albums=o.DisplayTab.instance.albums},render:function(){var e=new o.Views.Chosen({collection:this.albums,multiple:!0,placeholder:"Select an album",text_field:"name",width:500});return this.$el.empty(),this.$el.append('<tr><td class="albums_column"></td><td><label>'+igw_data.i18n.albums+"</label></td></tr>"),this.$el.find(".albums_column").append(e.render().el),this}}),o.DisplayTab.Views.TagsSource=Backbone.View.extend({tagName:"tbody",initialize:function(){this.tags=o.DisplayTab.instance.tags},render:function(){var e=new o.Views.Chosen({collection:this.tags,multiple:!0,placeholder:"Select a tag",text_field:"name",width:500});return this.$el.empty(),this.$el.append('<tr><td class="tags_column"></td><td><label>Tags</label></td></tr>'),this.$el.find(".tags_column").append(e.render().el),this}}),o.DisplayTab.Views.Recent_imagesSource=Backbone.View.extend({tagName:"tbody",initialize:function(){this.displayed_gallery=o.DisplayTab.instance.displayed_gallery,this.maximum_entity_count=o.DisplayTab.instance.displayed_gallery.get("maximum_entity_count"),this.displayed_gallery.set("container_ids",[])},render:function(){var e=this,t=n("<input/>").prop({type:"text",value:this.maximum_entity_count,name:"maximum_entity_count"});return t.on("change",function(){e.displayed_gallery.set("maximum_entity_count",n(this).val())}),this.$el.empty(),this.$el.append('<tr><td class="recent_images_column"></td><td><label># of Images To Display</label></td></tr>'),this.$el.find(".recent_images_column").append(t),this}}),o.DisplayTab.Views.Random_imagesSource=Backbone.View.extend({tagName:"tbody",initialize:function(){this.displayed_gallery=o.DisplayTab.instance.displayed_gallery,this.maximum_entity_count=o.DisplayTab.instance.displayed_gallery.get("maximum_entity_count"),this.displayed_gallery.set("container_ids",[])},render:function(){var e=this,t=n("<input/>").prop({type:"text",value:this.maximum_entity_count,name:"maximum_entity_count"});return t.on("change",function(){e.displayed_gallery.set("maximum_entity_count",n(this).val())}),this.$el.empty(),this.$el.append('<tr><td class="random_images_column"></td><td><label># of Images To Display</label></td></tr>'),this.$el.find(".random_images_column").append(t),this}}),o.DisplayTab.Views.SaveButton=Backbone.View.extend({el:"#save_displayed_gallery",errors_el:"#errors",displayed_gallery:null,events:{click:"clicked"},initialize:function(){this.displayed_gallery=o.DisplayTab.instance.displayed_gallery,this.entities=o.DisplayTab.instance.entities,this.render()},clicked:function(){this.set_display_settings();var e,t=this.displayed_gallery.to_shortcode();insert_into_editor(t,this.displayed_gallery.id||igw_data.shortcode_ref);(e=location.toString().match(/editor=([^\&]+)/))&&2<=e.length&&top.tinyMCE.editors[e[1]].fire("ngg-inserted",{shortcode:t}),close_attach_to_post_window()},set_display_settings:function(){var e,a,o,t=this.displayed_gallery.get("display_type");t&&(e=n("form[rel='"+t+"']"),a=e.data("defaults"),o={},n.each(e.serializeArray(),function(e,t){for(var i=t.name.split("["),s=o,l=0;l<i.length;l++){var n=i[l].replace(/\]$/,"");if(a[n]==t.value)return!0;s[n]||(l==i.length-1?s[n]=t.value:s[n]={}),s=s[n]}}),this.displayed_gallery.set("display_settings",o[t]))},render:function(){return this.$el.css("z-index",1e3),this}}),o.DisplayTab.App=Backbone.View.extend({initialize:function(){var e,s;this.displayed_gallery=new o.DisplayTab.Models.Displayed_Gallery(igw_data.displayed_gallery),this.original_displayed_gallery=new o.DisplayTab.Models.Displayed_Gallery(igw_data.displayed_gallery),this.galleries=new o.DisplayTab.Models.Gallery_Collection(igw_data.galleries),this.albums=new o.DisplayTab.Models.Album_Collection(igw_data.albums),this.tags=new o.DisplayTab.Models.Tag_Collection(igw_data.tags),this.sources=new o.DisplayTab.Models.Source_Collection(igw_data.sources),this.display_types=new o.DisplayTab.Models.Display_Type_Collection(igw_data.display_types),this.display_type_order_base=igw_data.display_type_priority_base,this.display_type_order_step=igw_data.display_type_priority_step,this.entities=new o.DisplayTab.Models.Entity_Collection,this.entities.extra_data.displayed_gallery=this.displayed_gallery,this.image_key=igw_data.image_primary_key,this.displayed_gallery.get("source")&&(this.displayed_gallery.get("source")&&(e=this.sources.find_by_name_or_alias(this.displayed_gallery.get("source")))&&e.set("selected",!0),this.displayed_gallery.get("container_ids")&&_.each(this.displayed_gallery.get("container_ids"),function(t){var e=this[this.displayed_gallery.get("source")].find(function(e){return e.id==t},this);e&&e.set("selected",!0)},this),this.displayed_gallery.get("display_type"))&&(e=this.display_types.find_by_name_or_alias(this.displayed_gallery.get("display_type")))&&(e.set("selected",!0),this.displayed_gallery.set("display_type",e.get("name"))),collections=["galleries","albums","tags"],_.each(collections,function(e){this[e].on("selected",function(){this.update_selected_containers(e)},this)},this),this.display_types.on("change:selected",function(){this.displayed_gallery.set("display_type",this.display_types.selected_value())},this),this.sources.on("selected",function(){n("#save_displayed_gallery").prop("disabled",!0),setTimeout(function(){n("#save_displayed_gallery").prop("disabled",!1)},1e3),this.displayed_gallery.set("source",this.sources.selected_value()),this.sources.selected_value()!=this.original_displayed_gallery.get("source")?this.displayed_gallery.set("exclusions",this.entities.excluded_ids()):this.displayed_gallery.set("exclusions",this.original_displayed_gallery.get("exclusions")),"random_images"!=this.sources.selected_value()&&"recent_images"!=this.sources.selected_value()||this.displayed_gallery.set("maximum_entity_count",20),this.galleries.deselect_all(),this.albums.deselect_all(),this.tags.deselect_all();var e=this.display_types.selected(),t=this.sources.selected();0<e.length&&0<t.length&&(e=e[0],t=t[0],e.is_compatible_with_source(t)||this.display_types.deselect_all(),this.display_type_selector)&&this.display_type_selector.render(),this.preview_area&&this.preview_area.render()},this),this.entities.on("change:exclude finished_fetching",function(){this.displayed_gallery.set("exclusions",this.entities.excluded_ids())},this),this.displayed_gallery.get("source")||(e=this.sources.find_by_name_or_alias("galleries"))&&(e.set("selected",!0),this.sources.trigger("selected")),window.Frame_Event_Publisher&&(s=this,Frame_Event_Publisher.listen_for("attach_to_post:new_gallery",function(){s.galleries.reset(),s.galleries.fetch()}),Frame_Event_Publisher.listen_for("attach_to_post:manage_galleries attach_to_post:manage_images",function(e){s.galleries.reset(),s.galleries.fetch();var t=s.sources.selected().pop();t&&(0<=_.indexOf(t.get("returns"),"image")||_.indexOf(t.get("returns"),"gallery"))&&s.entities.reset()}),Frame_Event_Publisher.listen_for("attach_to_post:manage_album",function(e){s.albums.reset(),s.albums.fetch();var t=s.sources.selected().pop();t&&0<=_.indexOf(t.get("returns"),"album")&&s.entities.reset()}),Frame_Event_Publisher.listen_for("attach_to_post:manage_tags attach_to_post:manage_images",function(e){s.tags.reset(),s.tags.fetch();var t=s.sources.selected().pop();t&&(0<=_.indexOf(t.get("returns"),"image")||_.indexOf(t.get("returns"),"gallery"))&&s.entities.reset()}),Frame_Event_Publisher.listen_for("attach_to_post:thumbnail_modified",function(e){var t=s.sources.selected().pop(),i=e.image[e.image.id_field];t&&(0<=_.indexOf(t.get("returns"),"image")?(t=s.entities.find(function(e){return parseInt(e.entity_id())==parseInt(i)},this))&&t.set("thumb_url",e.image.thumb_url):(t=s.entities.find(function(e){return parseInt(e.get("previewpic"))==i},this))&&t.trigger("change"))}))},update_selected_containers:function(e){this.displayed_gallery.set("container_ids",this[e].selected_ids())},render:function(){this.display_type_selector=new o.DisplayTab.Views.Display_Type_Selector,new o.DisplayTab.Views.Source_Config,new o.DisplayTab.Views.Slug_Config,this.preview_area=new o.DisplayTab.Views.Preview_Area,new o.DisplayTab.Views.SaveButton}}),window.Ngg=o,n(window).trigger("ngg_before_igw_render"),o.DisplayTab.instance=new o.DisplayTab.App,o.DisplayTab.instance.render(),n("span.tooltip, label.tooltip").tooltip()});