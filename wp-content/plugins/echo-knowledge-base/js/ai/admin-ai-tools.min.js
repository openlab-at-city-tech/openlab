(function(){"use strict";const{useState:e,useEffect:a,useRef:s,createElement:o}=wp.element;const{__:t}=wp.i18n;const{showError:n,showSuccess:l,makeApiRequest:i,handleSessionError:c}=window.EPKB_AI_Util_React||{};const d=({settings:s,tabData:i})=>{const[d,b]=e(i?.active_sub_tab||"debug");const[p,u]=e(i?.debug_enabled==="on");const[r,g]=e([]);const[k,m]=e([]);const[h,w]=e([]);const[f,v]=e("");const[N,_]=e("");const[y,E]=e("");const[C,A]=e(false);const[j,I]=e(false);const[P,O]=e(false);const[T,x]=e(null);const[L,S]=e(null);const[D,R]=e([]);const[$,F]=e([]);const[W,Q]=e([]);const K=window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes(".local")||window.location.hostname.includes(".test");a((()=>{if(p){q();J();V();G();X()}}),[p]);a((()=>{M()}),[f,D]);a((()=>{H()}),[N,$]);a((()=>{U()}),[y,W]);const M=()=>{if(!D.length)return;if(!f){g(D);return}const e=D.filter((e=>{if(f==="ai-related"){return e.message&&(e.message.toLowerCase().includes("epkb")||e.message.toLowerCase().includes("ai"))}return e.level===f}));g(e)};const H=()=>{if(!$.length)return;if(!N){m($);return}const e=$.filter((e=>{if(N==="ai-related"){return e.message&&(e.message.toLowerCase().includes("epkb")||e.message.toLowerCase().includes("ai"))}return e.level===N}));m(e)};const U=()=>{if(!W.length)return;if(!y){w(W);return}const e=W.filter((e=>e.level===y));w(e)};const B=async e=>{try{const a=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_toggle_debug_mode",enabled:e?"on":"off",_wpnonce:i?.nonce||""}});if(a.success){u(e);l(t("Debug mode updated successfully","echo-knowledge-base"));setTimeout((()=>window.location.reload()),1e3)}else{n(a.data.message||t("Failed to update debug mode","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){n(t("Error updating debug mode","echo-knowledge-base"))}}};const q=async()=>{A(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_php_error_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){R(e.data.logs||[]);if(!f){g(e.data.logs||[])}else{M()}}else{n(e.data.message||t("Failed to load PHP logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){n(t("Error loading PHP logs","echo-knowledge-base"))}}finally{A(false)}};const J=async()=>{I(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_wp_error_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){F(e.data.logs||[]);if(!N){m(e.data.logs||[])}else{H()}}else{n(e.data.message||t("Failed to load WP logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){n(t("Error loading WP logs","echo-knowledge-base"))}}finally{I(false)}};const V=async()=>{O(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_get_ai_logs",filter:"",_wpnonce:i?.nonce||""}});if(e.success){Q(e.data.logs||[]);if(!y){w(e.data.logs||[])}else{U()}}else{n(e.data.message||t("Failed to load AI logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){n(t("Error loading AI logs","echo-knowledge-base"))}}finally{O(false)}};const z=async()=>{O(true);try{const e=await jQuery.ajax({url:ajaxurl,type:"POST",dataType:"json",data:{action:"epkb_ai_clear_ai_logs",_wpnonce:i?.nonce||""}});if(e.success){Q([]);w([]);l(t("All AI logs cleared successfully","echo-knowledge-base"));E("");await V()}else{n(e.data.message||t("Failed to clear AI logs","echo-knowledge-base"))}}catch(e){const a=await c(e);if(!a){n(t("Error clearing AI logs","echo-knowledge-base"))}}finally{O(false)}};const G=()=>{const e=i?.system_info||{};const a={};Object.entries(e).forEach((([e,s])=>{if(!e.includes("ai_")&&!e.includes("openai")&&!e.includes("vector")){a[e]=s}}));x(a)};const X=()=>{const e={ai_config:i?.ai_config||{},data_collections:i?.data_collections||[],openai_status:i?.openai_status||{}};S(e)};const Y=()=>{const e=document.createElement("iframe");e.style.display="none";e.name="download-frame-"+Date.now();document.body.appendChild(e);const a=document.createElement("form");a.method="POST";a.action=window.location.href;a.target=e.name;const s=document.createElement("input");s.type="hidden";s.name="action";s.value="epkb_download_ai_debug_info";a.appendChild(s);const o=document.createElement("input");o.type="hidden";o.name="_wpnonce";o.value=i?.nonce||"";a.appendChild(o);document.body.appendChild(a);a.submit();setTimeout((()=>{document.body.removeChild(a);document.body.removeChild(e)}),5e3)};const Z=e=>o("div",{className:`epkb-ai-log-entry epkb-ai-log-${e.level}`,key:`${e.timestamp}-${Math.random()}`},o("div",{className:"epkb-ai-log-header"},o("span",{className:"epkb-ai-log-timestamp"},e.timestamp),o("span",{className:`epkb-ai-log-level ${e.level}`},e.level)),o("div",{className:"epkb-ai-log-message"},e.message),e.context&&Object.keys(e.context).length>0&&o("div",{className:"epkb-ai-log-context"},o("pre",null,JSON.stringify(e.context,null,2))));const ee=i?.sub_tabs||{};const ae=()=>o("div",{className:"epkb-ai-sub-tabs-nav"},Object.entries(ee).map((([e,a])=>o("button",{key:e,className:`epkb-ai-sub-tab-button ${d===e?"active":""}`,onClick:()=>b(e)},a.icon&&o("span",{className:a.icon})," ",a.title))));const se=()=>o("div",{className:"epkb-ai-debug-content"},o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,t("Debug Mode","echo-knowledge-base")),o("div",{className:"epkb-ai-setting-row"},o("label",{className:"epkb-ai-switch"},o("input",{type:"checkbox",checked:p,onChange:e=>B(e.target.checked)}),o("span",{className:"epkb-ai-slider"})),o("span",{className:"epkb-ai-setting-label"},t("Enable Debug Mode","echo-knowledge-base"),K&&o("span",{className:"epkb-ai-localhost-notice"},t(" (Localhost detected)","echo-knowledge-base")))),o("p",{className:"epkb-ai-setting-description"},t("Enable debug mode to view system logs and troubleshoot AI features. This will load additional debugging tools.","echo-knowledge-base"))),p?o("div",{className:"epkb-ai-debug-sections"},o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,t("AI Information","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-ai-info"},o("div",null,o("div",{className:"epkb-ai-info-grid"},o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},t("AI Chat","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.ai_chat?.value==="Enabled"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.ai_chat?.value==="Enabled"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,t("Disabled","echo-knowledge-base")))),o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},t("AI Search","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.ai_search?.value==="Enabled"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.ai_search?.value==="Enabled"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,t("Disabled","echo-knowledge-base")))),o("div",{className:"epkb-ai-info-item"},o("span",{className:"epkb-ai-info-label"},t("OpenAI API Key","echo-knowledge-base")),o("span",{className:`epkb-ai-info-value epkb-ai-status-indicator ${i?.system_info?.openai_api?.value==="Configured"?"epkb-status-enabled":"epkb-status-disabled"}`},i?.system_info?.openai_api?.value==="Configured"?o("span",{className:"epkbfa epkbfa-check-circle epkb-ai-status-success"}):o("span",null,t("Missing API Key","echo-knowledge-base"))))),o("div",{className:"epkb-ai-subsection"},o("h4",null,t("Data Collections","echo-knowledge-base")),L?.data_collections&&L.data_collections.length>0?o("div",{className:"epkb-ai-data-collections"},L.data_collections.map(((e,a)=>o("div",{className:"epkb-ai-collection-item",key:e.id||a},o("h5",null,e.name||t("Unnamed Collection","echo-knowledge-base")),o("div",{className:"epkb-ai-collection-details"},o("div",null,o("span",null,t("Vector Store:","echo-knowledge-base")+" ",o("strong",null,e.vector_store_status==="created"?t("Created","echo-knowledge-base"):t("Not created","echo-knowledge-base"))),e.vector_store_id&&o("span",null," (ID: "+e.vector_store_id+")")),o("div",null,o("span",null,t("Total Records:","echo-knowledge-base")+" ",o("strong",null,e.db_record_count||"0"))),e.status_counts&&o("div",{className:"epkb-ai-status-counts"},o("span",{className:"epkb-ai-status-label"},t("Status:","echo-knowledge-base")),e.status_counts.added>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-added"},t("Added:","echo-knowledge-base")+" "+e.status_counts.added),e.status_counts.updated>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-updated"},t("Updated:","echo-knowledge-base")+" "+e.status_counts.updated),e.status_counts.outdated>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-outdated"},t("Outdated:","echo-knowledge-base")+" "+e.status_counts.outdated),e.status_counts.error>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-error"},t("Error:","echo-knowledge-base")+" "+e.status_counts.error),e.status_counts.pending>0&&o("span",{className:"epkb-ai-status-item epkb-ai-status-pending"},t("Pending:","echo-knowledge-base")+" "+e.status_counts.pending))))))):o("p",{className:"epkb-ai-no-data"},t("No data collections found.","echo-knowledge-base")))))),o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,t("System Information","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-system-info"},o("div",{className:"epkb-ai-info-grid"},T&&Object.entries(T).map((([e,a])=>o("div",{className:"epkb-ai-info-item",key:e},o("span",{className:"epkb-ai-info-label"},a.label+":"),o("span",{className:`epkb-ai-info-value ${a.class||""}`},a.value))))),o("div",{className:"epkb-ai-debug-actions"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:Y},o("span",{className:"epkbfa epkbfa-download"})," ",t("Download Debug Info","echo-knowledge-base"))))),o("div",{className:"epkb-ai-debug-toggle-section"},o("h3",null,t("Logs","echo-knowledge-base")),o("div",{className:"epkb-ai-logs-subsection"},o("h4",null,t("PHP Error Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-php-error-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:q},o("span",{className:"epkbfa epkbfa-refresh"})," ",t("Refresh","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:f,onChange:e=>v(e.target.value)},o("option",{value:""},t("All","echo-knowledge-base")),o("option",{value:"fatal"},t("Fatal Errors","echo-knowledge-base")),o("option",{value:"warning"},t("Warnings","echo-knowledge-base")),o("option",{value:"notice"},t("Notices","echo-knowledge-base")),o("option",{value:"ai-related"},t("AI Related Only","echo-knowledge-base"))),o("span",{className:"epkb-ai-log-order-indicator"},t("Latest at top","echo-knowledge-base")+" ↑")),o("div",{className:"epkb-ai-log-container"},C?o("div",{className:"epkb-ai-loading-spinner"}):r.length===0?o("div",{className:"epkb-ai-no-logs"},t("No logs found.","echo-knowledge-base")):r.map((e=>Z(e)))))),o("h4",null,t("WordPress Error Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-wp-error-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:J},o("span",{className:"epkbfa epkbfa-refresh"})," ",t("Refresh","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:N,onChange:e=>_(e.target.value)},o("option",{value:""},t("All","echo-knowledge-base")),o("option",{value:"fatal"},t("Fatal Errors","echo-knowledge-base")),o("option",{value:"warning"},t("Warnings","echo-knowledge-base")),o("option",{value:"notice"},t("Notices","echo-knowledge-base")),o("option",{value:"ai-related"},t("AI Related Only","echo-knowledge-base"))),o("span",{className:"epkb-ai-log-order-indicator"},t("Latest at top","echo-knowledge-base")+" ↑")),o("div",{className:"epkb-ai-log-container"},j?o("div",{className:"epkb-ai-loading-spinner"}):k.length===0?o("div",{className:"epkb-ai-no-logs"},t("No logs found.","echo-knowledge-base")):k.map((e=>Z(e))))),o("h4",null,t("AI Activity Log","echo-knowledge-base")),o("div",{className:"epkb-ai-debug-section epkb-ai-activity-log"},o("div",{className:"epkb-ai-debug-controls"},o("button",{className:"epkb-ai-btn epkb-ai-btn-primary",onClick:V},o("span",{className:"epkbfa epkbfa-refresh"})," ",t("Refresh","echo-knowledge-base")),o("button",{className:"epkb-ai-btn epkb-ai-btn-danger",onClick:z},o("span",{className:"epkbfa epkbfa-trash"})," ",t("Clear Log","echo-knowledge-base")),o("select",{className:"epkb-ai-select",value:y,onChange:e=>E(e.target.value)},o("option",{value:""},t("All Levels","echo-knowledge-base")),o("option",{value:"error"},t("Errors Only","echo-knowledge-base")),o("option",{value:"warning"},t("Warnings","echo-knowledge-base")),o("option",{value:"info"},t("Info","echo-knowledge-base"))),o("span",{className:"epkb-ai-log-order-indicator"},t("Latest at top","echo-knowledge-base")+" ↑")),o("div",{className:"epkb-ai-log-container"},P?o("div",{className:"epkb-ai-loading-spinner"}):h.length===0?o("div",{className:"epkb-ai-no-logs"},t("No logs found.","echo-knowledge-base")):h.map((e=>Z(e))))))):o("div",{className:"epkb-ai-debug-disabled"},o("p",null,t("Debug mode is disabled. Enable it above to view debug information.","echo-knowledge-base"))));return o("div",{className:"epkb-ai-tools-container"},Object.keys(ee).length>0&&o("div",{className:"epkb-ai-sub-tabs"},ae()),o("div",{className:"epkb-ai-sub-tab-content"},se()))};window.EPKB_AI_Tools={AIAdminTools:d}})();