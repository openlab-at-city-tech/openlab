(function(){"use strict";const{useState:e,useEffect:a,useCallback:t,createElement:s}=wp.element;const{__:i}=wp.i18n;const{showError:n,showSuccess:o,makeApiRequest:c,showLoadingDialog:l,useTableSearch:r,formatServerDateTime:d,TutorialButton:p,isAuthError:b}=window.EPKB_AI_Util_React||{};const{logError:u}=window.EPKBChatUtils||{};const h=e=>{const a=document.createElement("div");a.className="epkb-ai-dialog epkb-ai-loading-dialog";a.style.cssText=`\n\t\t\tposition: fixed;\n\t\t\tbottom: 20px;\n\t\t\tright: 20px;\n\t\t\tbackground: white;\n\t\t\tborder-radius: 8px;\n\t\t\tpadding: 24px;\n\t\t\tmax-width: 350px;\n\t\t\tbox-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n\t\t\tz-index: 999999;\n\t\t\tdisplay: flex;\n\t\t\talign-items: center;\n\t\t\tgap: 16px;\n\t\t\tborder: 1px solid #ddd;\n\t\t`;const t=document.createElement("div");t.className="epkb-loading-spinner";t.style.cssText="width: 24px; height: 24px; flex-shrink: 0;";const s=document.createElement("p");s.style.cssText="margin: 0; color: #555; font-size: 14px; line-height: 1.5; font-weight: 500;";s.textContent=e;a.appendChild(t);a.appendChild(s);document.body.appendChild(a);a.offsetHeight;return{close:()=>{a.style.transition="opacity 0.3s ease-out";a.style.opacity="0";setTimeout((()=>a.remove()),300)}}};const _=({conversations:a,selectedId:n,onSelect:c,onDelete:l,isLoading:p,onRefresh:b,onSearch:u,allConversations:_,currentPage:m,totalPages:g,onPageChange:k})=>{const[f,v]=e([]);const[w,y]=e(false);const[N,C]=e("desc");const[x,S]=e((()=>{const e="epkb_viewed_chat_conversations";try{const a=localStorage.getItem(e);return a?new Set(JSON.parse(a)):new Set}catch(e){return new Set}}));const A=t((e=>{S((a=>{const t=new Set(a);t.add(e);const s="epkb_viewed_chat_conversations";try{localStorage.setItem(s,JSON.stringify([...t]))}catch(e){}return t}))}),[]);const{searchTerm:P,displayedData:E,isSearching:I,searchMessage:T,handleSearchChange:$,clearSearch:D}=r({data:a,allData:_,onServerSearch:u,searchFields:["first_message","conversation","user_name","user"]});const R=[...E].sort(((e,a)=>{const t=new Date(e.time||e.created_at||0);const s=new Date(a.time||a.created_at||0);if(N==="asc"){return t-s}else{return s-t}}));const L=e=>{if(e){v(R.map((e=>e.id)))}else{v([])}};const O=()=>{C(N==="asc"?"desc":"asc")};const U=(e,a)=>{if(a){v([...f,e])}else{v(f.filter((a=>a!==e)))}};const j=async()=>{if(f.length===0)return;const{showConfirmDialog:e}=window.EPKB_AI_Util_React||{};if(!e){if(!confirm(i("Are you sure you want to delete the selected conversations?","echo-knowledge-base"))){return}}else{const a=await e({title:i("Delete Conversations","echo-knowledge-base"),message:i("Are you sure you want to delete the selected conversations?","echo-knowledge-base"),confirmText:i("Delete","echo-knowledge-base"),cancelText:i("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(!a){return}}const a=h(i("Deleting conversations...","echo-knowledge-base"));f.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="0.5";a.style.transition="opacity 0.3s ease"}}));try{await l(f);v([])}catch(e){f.forEach((e=>{const a=document.getElementById(`chat-row-${e}`);if(a){a.style.opacity="1"}}));throw e}finally{if(a){a.close()}}};const B=async()=>{y(true);await b();y(false);o(i("Conversations refreshed successfully","echo-knowledge-base"))};return s("div",{className:"epkb-ai-data-source-table"},s("div",{className:"epkb-ai-table-content"},s("div",{className:"epkb-submissions-table-container"},s("div",{className:"epkb-table-filter-container"},s("div",{className:"epkb-ai-search-input"},s("input",{type:"text",placeholder:i("Search conversations...","echo-knowledge-base"),value:P,onChange:e=>$(e.target.value)}),s("span",{className:"epkb-ai-search-icon epkbfa epkbfa-search"})),s("button",{className:"epkb-ai-button epkb-ai-button-success",onClick:B,disabled:p||w,style:{backgroundColor:"#46b450",borderColor:"#46b450",color:"#fff",padding:"6px 12px",fontSize:"14px",marginRight:f.length>0?"10px":"0"}},w?i("Refreshing...","echo-knowledge-base"):s("span",null,s("span",{className:"epkbfa epkbfa-refresh",style:{marginRight:"5px"}}),i("Refresh","echo-knowledge-base"))),f.length>0&&s("button",{className:"epkb-ai-button epkb-ai-button-destructive",onClick:j},i("Delete Selected","echo-knowledge-base"))),p?s("div",{className:"epkb-ai-loading"},s("div",{className:"epkb-loading-spinner"}),s("p",null,i("Loading conversations...","echo-knowledge-base"))):R.length===0&&!P?s("div",{className:"epkb-ai-no-data"},s("p",null,i("No conversations found","echo-knowledge-base"))):s("table",{id:"epkb-chat-conversations-table"},s("thead",null,s("tr",null,s("th",null,s("input",{type:"checkbox",checked:f.length===R.length&&R.length>0,onChange:e=>L(e.target.checked)})),s("th",{"data-column":"time",style:{cursor:"pointer",userSelect:"none"},onClick:O},s("span",null,i("Time","echo-knowledge-base")," ",N==="asc"?"↑":"↓")),s("th",{"data-column":"user"},i("User","echo-knowledge-base")),s("th",{"data-column":"conversation"},i("Conversation","echo-knowledge-base")))),s("tbody",null,R.map((e=>s("tr",{key:e.id,id:`chat-row-${e.id}`,className:`${n===e.id?"selected":""} ${!x.has(e.id)?"epkb-ai-unviewed-record":""}`.trim(),onClick:()=>{A(e.id);c(e.id)}},s("td",null,s("input",{type:"checkbox",checked:f.includes(e.id),onChange:a=>U(e.id,a.target.checked),onClick:e=>e.stopPropagation()})),s("td",null,d?d(e.time||e.created_at,"-"):e.time||e.created_at||"-"),s("td",null,e.user_id&&e.user_id>0?s("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer",style:{textDecoration:"none"}},e.user||e.user_name):e.user||e.user_name),s("td",null,e.conversation||e.first_message||"")))))),(T||I)&&s("div",{className:"epkb-ai-search-message",style:{textAlign:"center",padding:"10px",color:"#666",fontStyle:"italic"}},I?i("Searching server for more results...","echo-knowledge-base"):T),(()=>{if(g<=1){return null}return s("div",{className:"epkb-ai-pagination"},s("button",{disabled:m===1,onClick:()=>k(m-1),className:"epkb-ai-button epkb-ai-button-secondary"},i("Previous","echo-knowledge-base")),s("span",{className:"epkb-ai-page-info"},`${i("Page","echo-knowledge-base")} ${m} ${i("of","echo-knowledge-base")} ${g}`),s("button",{disabled:m===g,onClick:()=>k(m+1),className:"epkb-ai-button epkb-ai-button-secondary"},i("Next","echo-knowledge-base")))})())))};const m=({conversation:e})=>{if(!e){return s("div",{className:"epkb-ai-data-source-settings"},s("h3",{className:"epkb-ai-data-source-heading"},i("Conversation Details","echo-knowledge-base")),s("div",{className:"epkb-ai-action-content"},s("div",{className:"epkb-ai-no-selection"},s("p",null,i("Select a conversation to view details","echo-knowledge-base")))))}return s("div",{className:"epkb-ai-data-source-settings"},s("h3",{className:"epkb-ai-data-source-heading"},i("Conversation Details","echo-knowledge-base")),s("div",{className:"epkb-ai-discussion-details-content"},s("div",{className:"epkb-ai-conversation-messages"},s("div",{className:"epkb-ai-conversation-meta"},s("h4",null,i("Conversation Info","echo-knowledge-base")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},i("User:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.user_id&&e.user_id>0?s("a",{href:`user-edit.php?user_id=${e.user_id}`,target:"_blank",rel:"noopener noreferrer"},e.user||"Guest"):e.user||"Guest")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},i("Started:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},d?d(e.time,"-"):e.time||"-")),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},i("Messages:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.message_count||0)),s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},i("Status:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.status||"answered")),e.rating>0&&s("div",{className:"epkb-ai-meta-item"},s("span",{className:"epkb-ai-meta-label"},i("Rating:","echo-knowledge-base")),s("span",{className:"epkb-ai-meta-value"},e.rating+"/5"))),s("div",{className:"epkb-ai-conversation-thread"},s("h4",null,i("Full Conversation","echo-knowledge-base")),e.messages&&e.messages.length>0?s("div",{className:"epkb-ai-messages-list"},e.messages.map(((e,a)=>s("div",{key:a,className:`epkb-ai-message epkb-ai-message-${e.role}`},s("div",{className:"epkb-ai-message-header"},s("span",{className:"epkb-ai-message-role"},e.role==="user"?i("User","echo-knowledge-base"):i("AI Assistant","echo-knowledge-base")),e.timestamp&&s("span",{className:"epkb-ai-message-time"},d?d(e.timestamp,""):e.timestamp)),s("div",{className:"epkb-ai-message-bubble"},s("div",{className:"epkb-ai-message-content"},e.content)))))):s("div",{className:"epkb-ai-no-messages"},s("p",null,i("No messages in this conversation.","echo-knowledge-base")))))))};const g=({field:t,fieldName:i,value:n,onChange:o,onPresetChange:c})=>{const[l,r]=e(false);a((()=>{const e=e=>{if(!e.target.closest(".epkb-ai-custom-dropdown")){r(false)}};const a=document.querySelector(".epkb-ai-behavior-preset-select");const t=a?a.closest(".epkb-ai-settings-section"):null;if(t){if(l){t.classList.add("epkb-has-dropdown-open")}else{t.classList.remove("epkb-has-dropdown-open")}}if(l){document.addEventListener("click",e);return()=>{document.removeEventListener("click",e);if(t){t.classList.remove("epkb-has-dropdown-open")}}}}),[l]);const d=e=>{const a=e.split(" - ");if(a.length===2){return{name:a[0].trim(),description:a[1].trim()}}return{name:e,description:""}};const p=t.options[n]||"";const b=d(p);return s("div",{className:"epkb-ai-field epkb-ai-field-select epkb-ai-behavior-preset-select"},s("label",{className:"epkb-ai-field-label"},t.label),s("div",{className:"epkb-ai-custom-dropdown"},s("div",{className:"epkb-ai-dropdown-trigger",onClick:()=>r(!l)},s("span",{className:"epkb-ai-dropdown-value"},b.name),s("span",{className:"epkb-ai-dropdown-arrow"},l?"▲":"▼")),l&&s("div",{className:"epkb-ai-dropdown-menu"},Object.entries(t.options).map((([e,a])=>{const t=d(a);return s("div",{key:e,className:"epkb-ai-dropdown-option"+(n===e?" selected":""),onClick:()=>{o(i,e);if(c){c(e)}r(false)}},s("div",{className:"epkb-ai-option-name"},t.name),t.description&&s("div",{className:"epkb-ai-option-description"},t.description))})))),t.description&&s("p",{className:"epkb-ai-field-description"},t.description))};const k=({settings:a,onChange:t,onSave:n,isSaving:o,onPresetChange:c})=>{const[l,r]=e("location-1");const d=(e,n)=>{const o=a.hasOwnProperty(e)?a[e]:n.value||"";switch(n.type){case"toggle":return s("div",{className:"epkb-ai-field epkb-ai-field-toggle"},s("label",{className:"epkb-ai-toggle-label"},s("input",{type:"checkbox",checked:o==="on",onChange:a=>t(e,a.target.checked?"on":"off")}),s("span",{className:"epkb-ai-toggle-text"},n.label)),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"radio":return s("div",{className:"epkb-ai-field epkb-ai-field-radio"+(n.field_class?" "+n.field_class:"")},s("div",{className:"epkb-ai-field-label"},n.label),s("div",{className:"epkb-ai-radio-group"},Object.entries(n.options).map((([a,i])=>s("label",{key:a,className:"epkb-ai-radio-label"},s("input",{type:"radio",name:e,value:a,checked:o===a,onChange:a=>t(e,a.target.value)}),s("span",{className:"epkb-ai-radio-text"},i))))),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"password":return s("div",{className:"epkb-ai-field epkb-ai-field-password"},s("label",{className:"epkb-ai-field-label"},n.label),s("input",{type:"password",className:"epkb-ai-input",value:o||"",onChange:a=>t(e,a.target.value),placeholder:n.placeholder}),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"text":return s("div",{className:"epkb-ai-field epkb-ai-field-text"},s("label",{className:"epkb-ai-field-label"},n.label),s("input",{type:"text",className:"epkb-ai-input",value:o||"",onChange:a=>t(e,a.target.value),placeholder:n.placeholder}),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"textarea":const l=e==="ai_chat_instructions"?"epkb-ai-field-description-red":"";return s("div",{className:"epkb-ai-textarea-field"},s("div",{className:"epkb-ai-textarea-header"},s("label",null,n.label),n.show_reset&&s("button",{type:"button",className:"epkb-ai-reset-button",onClick:async()=>{if(n.default){const{showConfirmDialog:a}=window.EPKB_AI_Util_React||{};if(!a){if(confirm(i("Are you sure you want to reset to default instructions?","echo-knowledge-base"))){t(e,n.default)}}else{const s=await a({title:i("Reset Instructions","echo-knowledge-base"),message:i("Are you sure you want to reset to default instructions? Your custom instructions will be lost.","echo-knowledge-base"),confirmText:i("Reset","echo-knowledge-base"),cancelText:i("Cancel","echo-knowledge-base"),confirmButtonClass:"epkb-ai-button-destructive"});if(s){t(e,n.default)}}}}},i("Reset to Default","echo-knowledge-base"))),s("textarea",{value:o,onChange:a=>t(e,a.target.value),rows:n.rows||3,placeholder:n.placeholder}),n.description&&s("p",{className:l},n.description));case"number":return s("div",{className:"epkb-ai-field epkb-ai-field-number"},s("label",{className:"epkb-ai-field-label"},n.label),s("input",{type:"number",className:"epkb-ai-input",value:o,onChange:a=>t(e,a.target.value),min:n.min,max:n.max,step:n.step}),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"color":return s("div",{className:"epkb-ai-field epkb-ai-field-color"},s("label",{className:"epkb-ai-field-label"},n.label),s("input",{type:"color",className:"epkb-ai-color-input",value:o||"#0073aa",onChange:a=>t(e,a.target.value)}),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"select":if(n.field_class&&n.field_class.includes("epkb-ai-behavior-preset-select")){return s(g,{field:n,fieldName:e,value:o,onChange:t,onPresetChange:c})}const r=e=>{const a=typeof e==="string"&&e.indexOf("gpt-5")===0;if(a){return{type:"gpt5",defaults:{verbosity:"medium",reasoning:"medium",max_output_tokens:5e3}}}return{type:"gpt4",defaults:{temperature:.2,top_p:1,max_output_tokens:5e3}}};return s("div",{className:"epkb-ai-field epkb-ai-field-select"+(n.field_class?" "+n.field_class:"")},s("label",{className:"epkb-ai-field-label"},n.label),s("select",{className:"epkb-ai-select",value:o,onChange:s=>{const i=s.target.value;t(e,i);if(e==="ai_chat_model"){const e=a.ai_chat_preset!==undefined?a.ai_chat_preset:a.sections&&a.sections.chat_behavior&&a.sections.chat_behavior.fields&&a.sections.chat_behavior.fields.ai_chat_preset?a.sections.chat_behavior.fields.ai_chat_preset.value:"custom";if(e==="custom"){const e=r(i);if(e.type==="gpt5"){if(e.defaults.verbosity!==undefined)t("ai_chat_verbosity",e.defaults.verbosity);if(e.defaults.reasoning!==undefined)t("ai_chat_reasoning",e.defaults.reasoning)}else{if(e.defaults.temperature!==undefined)t("ai_chat_temperature",e.defaults.temperature);if(e.defaults.top_p!==undefined)t("ai_chat_top_p",e.defaults.top_p)}if(e.defaults.max_output_tokens!==undefined)t("ai_chat_max_output_tokens",e.defaults.max_output_tokens)}}}},Object.entries(n.options).map((([e,a])=>s("option",{key:e,value:e},a)))),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"section_header":return s("div",{className:"epkb-ai-section-divider"},s("h4",{className:"epkb-ai-section-subtitle"},n.label),n.description&&s("p",{className:"epkb-ai-section-description"},n.description));case"checkboxes":return s("div",{className:"epkb-ai-field epkb-ai-field-checkboxes"+(n.field_class?" "+n.field_class:"")},n.label&&s("label",{className:"epkb-ai-field-label"},n.label),s("div",{className:"epkb-field-checkboxes"},Object.entries(n.options||{}).map((([a,i])=>s("label",{key:a,className:"epkb-checkbox-label"},s("input",{type:"checkbox",value:a,checked:Array.isArray(o)?o.includes(a):false,onChange:s=>{const i=Array.isArray(o)?o:[];const n=s.target.checked?[...i,a]:i.filter((e=>e!==a));t(e,n)}}),s("span",null,i))))),n.description&&s("p",{className:"epkb-ai-field-description"},n.description));case"notice":return s("div",{className:"epkb-ai-notice epkb-ai-notice-"+(n.notice_type||"info")},n.message);case"action_button":return null;case"html":return s("div",{className:"epkb-ai-field-html",dangerouslySetInnerHTML:{__html:n.html}});case"section_header":return s("div",{className:"epkb-ai-section-header-field"},s("h4",null,n.label),n.description&&s("p",null,n.description));default:return null}};return s("div",{className:"epkb-ai-settings"},s("div",{className:"epkb-ai-settings-sections-wrapper"},Object.entries(a.sections||{}).map((([e,t])=>s("div",{key:e,className:"epkb-ai-settings-section"},s("div",{className:"epkb-ai-section-header"},t.icon&&s("span",{className:t.icon}),s("div",{className:"epkb-ai-header-text"},s("h3",null,t.title))),s("div",{className:"epkb-ai-section-content"},(()=>{const i=Object.entries(t.fields||{});if(e==="chat_behavior"){const e=a.ai_chat_preset;const t=a.sections&&a.sections.chat_behavior&&a.sections.chat_behavior.fields&&a.sections.chat_behavior.fields.ai_chat_preset?a.sections.chat_behavior.fields.ai_chat_preset.value:undefined;const n=(e?e:t)==="custom";const o=a.ai_chat_model||"";const c=o.indexOf("gpt-5")===0;const l=new Set(["ai_chat_verbosity","ai_chat_reasoning"]);const r=new Set(["ai_chat_temperature","ai_chat_top_p"]);const p=new Set(["ai_chat_preset","ai_chat_model","ai_chat_max_output_tokens"]);return i.filter((([e])=>{if(e==="ai_chat_preset")return true;if(!n)return false;if(p.has(e))return true;if(c){return l.has(e)}else{return r.has(e)}})).map((([e,a])=>s("div",{key:e,className:"epkb-ai-field-row"},d(e,a))))}if(e==="display_settings"){const e=a.ai_chat_display_mode||"all_pages";const n=t.location_tabs||{};const o=Object.keys(n).length>0;const c=i.filter((([a,t])=>{if(a==="collection_tabs_description"&&e==="all_pages"){return false}return true})).map((([a,t])=>{const i=a==="ai_chat_display_collection"&&e!=="all_pages";return s("div",{key:a,className:"epkb-ai-field-row"+(i?" epkb-ai-field-hidden":""),"data-field-name":a},d(a,t))}));if(e==="all_pages"||!o){return c}return[...c,s("div",{key:"location-tabs-container",className:"epkb-ai-location-tabs-container"},s("div",{className:"epkb-ai-location-tabs-nav"},Object.entries(n).map((([e,a])=>s("button",{key:e,type:"button",className:`epkb-ai-location-tab-button ${l===e?"active":""}`,onClick:()=>r(e)},a.icon&&s("span",{className:a.icon}),s("span",null,a.title))))),s("div",{className:"epkb-ai-location-tab-content"},(()=>{const e=n[l];if(!e||!e.fields)return null;return Object.entries(e.fields).map((([e,a])=>s("div",{key:e,className:"epkb-ai-field-row"},d(e,a))))})()))]}return i.map((([e,a])=>s("div",{key:e,className:"epkb-ai-field-row"},d(e,a))))})()))))),s("div",{className:"epkb-ai-settings-actions"},s("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:n,disabled:o},o?i("Saving...","echo-knowledge-base"):i("Save Settings","echo-knowledge-base"))))};const f=({settings:n,tabData:o,isLoading:c,onDataChange:l,makeApiRequest:r,showError:d,showSuccess:h,onTabSwitch:g})=>{const[f,v]=e((()=>{const e=new URL(window.location);return e.searchParams.get("active_sub_tab")||o?.active_sub_tab||"chat-history"}));const[w,y]=e(null);const[N,C]=e([]);const[x,S]=e(null);const[A,P]=e(false);const[E,I]=e(false);const[T,$]=e(o?.ai_config||{});const[D,R]=e(o?.widget_config||{});const[L,O]=e(false);const[U,j]=e(false);const[B,G]=e(1);const[F,K]=e(1);const[q,M]=e({ai_chat_enabled:o?.ai_config?.ai_chat_enabled||"off",ai_search_enabled:o?.ai_config?.ai_search_enabled||"off"});a((()=>{if(o){C([]);if(o.ai_config){$(o.ai_config);M({ai_chat_enabled:o.ai_config.ai_chat_enabled||"off",ai_search_enabled:o.ai_config.ai_search_enabled||"off"})}if(o.widget_config){R(o.widget_config)}}}),[o]);const z=t((async()=>{j(true);try{const e=await r("ai-chat/conversations",{method:"GET",params:{kb_id:n?.kb_id||1,per_page:100}});if(e&&e.conversations){let a=[...e.conversations];const t=e.pagination?.total_pages||1;for(let e=2;e<=t;e++){const t=await r("ai-chat/conversations",{method:"GET",params:{kb_id:n?.kb_id||1,page:e,per_page:100}});if(t&&t.conversations){a=[...a,...t.conversations]}}S(a);return a}}catch(e){u("AI Chat Admin","Failed to fetch all conversations for filtering",{message:e.message||"Unknown error"});throw e}finally{j(false)}return[]}),[r,n?.kb_id]);const H=t((async e=>{if(!e)return null;G(1);if(U)return null;if(x&&x.length>0){return x}try{const e=await z();return e}catch(e){u("AI Chat Admin","Server search failed",{message:e.message||"Unknown error",searchTerm:searchTerm});return null}}),[z,U,x]);const J=async(e=1)=>{if(!r){return Promise.resolve([])}if(T.ai_chat_enabled==="off"){C([]);S(null);O(true);K(1);return Promise.resolve([])}P(true);try{const a=await r("ai-chat/conversations",{method:"GET",params:{kb_id:n?.kb_id||1,per_page:10,page:e}});if(a&&a.conversations){C(a.conversations);O(true);K(a.pages||1);S(null);return a.conversations}else{u("AI Chat Admin","No conversations found in response",{response:a});C([]);O(true);S(null);K(1);return[]}}catch(e){d(e.message||i("Failed to load conversations","echo-knowledge-base"));throw e}finally{P(false)}};a((()=>{if(f==="chat-history"&&!L){J(B)}}),[f,L,n?.kb_id,r]);a((()=>{if(f==="chat-history"&&L){J(B)}}),[B]);a((()=>()=>{O(false);C([]);S(null);y(null)}),[]);const Y=o?.ai_config?.ai_disclaimer_accepted==="on";const Q=(e,a)=>{const t=["widget_header_title","input_placeholder_text","welcome_message","launcher_background_color","widget_header_background_color"];if(e==="ai_chat_display_mode"){setTimeout((()=>{const e=document.querySelector('[data-field-name="ai_chat_display_collection"]');if(e){if(a==="all_pages"){e.classList.remove("epkb-ai-field-hidden")}else{e.classList.add("epkb-ai-field-hidden")}}}),0)}if(t.includes(e)){R((t=>({...t,[e]:a})))}else{$((t=>({...t,[e]:a})))}};const V=e=>{const a=window.epkb_ai_api?.presets?.chat||{};if(e!=="custom"&&a[e]){const t=a[e];$((a=>{const s={...a,ai_chat_preset:e};if(t.model!==undefined)s.ai_chat_model=t.model;if(t.verbosity!==undefined)s.ai_chat_verbosity=t.verbosity;if(t.reasoning!==undefined)s.ai_chat_reasoning=t.reasoning;if(t.temperature!==undefined)s.ai_chat_temperature=t.temperature;if(t.max_output_tokens!==undefined)s.ai_chat_max_output_tokens=t.max_output_tokens;if(t.top_p!==undefined)s.ai_chat_top_p=t.top_p;return s}))}else{$((a=>({...a,ai_chat_preset:e})))}};const W=async()=>{I(true);try{const e={ai_chat_enabled:T.ai_chat_enabled,ai_chat_model:T.ai_chat_model,ai_chat_instructions:T.ai_chat_instructions,ai_chat_verbosity:T.ai_chat_verbosity,ai_chat_reasoning:T.ai_chat_reasoning,ai_chat_temperature:T.ai_chat_temperature,ai_chat_max_output_tokens:T.ai_chat_max_output_tokens,ai_chat_top_p:T.ai_chat_top_p,ai_chat_display_mode:T.ai_chat_display_mode,ai_chat_display_page_rules:T.ai_chat_display_page_rules,ai_chat_display_other_post_types:T.ai_chat_display_other_post_types,ai_chat_display_url_patterns:T.ai_chat_display_url_patterns?T.ai_chat_display_url_patterns.split("\n").filter((e=>e.trim())).join(","):""};if(T.ai_chat_display_mode==="all_pages"){e.ai_chat_display_collection=T.ai_chat_display_collection}for(let a=2;a<=5;a++){const t=`_${a}`;e[`ai_chat_display_collection${t}`]=T[`ai_chat_display_collection${t}`];e[`ai_chat_display_page_rules${t}`]=T[`ai_chat_display_page_rules${t}`];e[`ai_chat_display_other_post_types${t}`]=T[`ai_chat_display_other_post_types${t}`];e[`ai_chat_display_url_patterns${t}`]=T[`ai_chat_display_url_patterns${t}`]?T[`ai_chat_display_url_patterns${t}`].split("\n").filter((e=>e.trim())).join(","):""}const a={settings:e};if(D){a.widget_settings=D;a.widget_id=1}const t=await r("ai/settings",{method:"POST",data:a});if(t.success){h(i("Settings saved successfully","echo-knowledge-base"));const e={ai_config:T};if(t.widget_config){e.widget_config=t.widget_config}else{e.widget_config=D}l(e);const a=q.ai_chat_enabled!==T.ai_chat_enabled;const s=q.ai_search_enabled!==T.ai_search_enabled;if(a||s){setTimeout((()=>{const e=new URL(window.location.href);e.searchParams.set("active_tab","chat");window.location.href=e.toString()}),1e3)}else{M({ai_chat_enabled:T.ai_chat_enabled,ai_search_enabled:T.ai_search_enabled||q.ai_search_enabled})}}}catch(e){if(!b(e)){d(e.message||i("Failed to save settings","echo-knowledge-base"))}}finally{I(false)}};const X=async e=>{try{const a=await r("ai-chat/conversations/bulk",{method:"DELETE",data:{ids:e}});const t=a.success||a===true||typeof a==="string"&&a.includes("deleted successfully")||a.message&&a.message.includes("deleted successfully");if(t){const t=typeof a==="string"?a:a.message||i("Conversations deleted successfully","echo-knowledge-base");h(t);C((a=>a.filter((a=>!e.includes(a.id)))));S((a=>a?a.filter((a=>!e.includes(a.id))):null));if(e.includes(w)){y(null)}}else{throw new Error(a.message||a||i("Failed to delete conversations","echo-knowledge-base"))}}catch(e){d(e.message||i("Failed to delete conversations","echo-knowledge-base"));throw e}};const Z=N.find((e=>e.id===w));const ee=[{id:"chat-history",title:i("Chat History","echo-knowledge-base")},{id:"chat-settings",title:i("Settings","echo-knowledge-base")}];const ae=o?.sub_tabs?Object.values(o.sub_tabs):ee;if(!Y){const{DisclaimerRequiredMessage:e}=window.EPKB_AI_Util_React||{};if(e){return s(e,{i18n:n?.i18n||{},onAccept:()=>{if(g){g("general-settings")}else{const e=new URL(window.location.href);if(e.searchParams.has("page")){e.searchParams.set("active_tab","general-settings");window.location.href=e.toString()}}}})}}const te=o?.ai_config?.ai_key&&o.ai_config.ai_key.length>0;const se=!Y||!te;const ie=()=>{switch(f){case"chat-history":if(T.ai_chat_enabled==="off"){return s("div",{className:"epkb-ai-disabled-message"},s("div",{className:"epkb-ai-notice epkb-ai-notice-warning"},s("h3",null,i("AI Chat is Disabled","echo-knowledge-base")),s("p",null,i("To view chat history, please enable AI Chat in the Settings tab.","echo-knowledge-base")),s("button",{className:"epkb-ai-button epkb-ai-button-primary",onClick:()=>{v("chat-settings");const e=new URL(window.location);e.searchParams.set("active_sub_tab","chat-settings");window.history.pushState({},"",e)}},i("Go to Settings","echo-knowledge-base"))))}return s("div",{className:"epkb-ai-chat-history-wrapper"},se&&s("div",{className:"epkb-ai-notice epkb-ai-notice-warning",style:{marginBottom:"20px"}},s("p",null,!te?i("OpenAI API key is not configured. Please configure it in General Settings to use AI Chat features.","echo-knowledge-base"):i("Please accept the data privacy agreement in General Settings to use AI Chat features.","echo-knowledge-base")),s("a",{href:"#",className:"epkb-ai-button epkb-ai-button-small",onClick:e=>{e.preventDefault();const a=new URL(window.location.href);a.searchParams.set("active_tab","general-settings");window.location.href=a.toString()}},i("Go to General Settings","echo-knowledge-base"))),s("div",{className:"epkb-ai-data-source-layout"},s(_,{conversations:N,allConversations:x,selectedId:w,onSelect:y,onDelete:X,isLoading:A,onRefresh:()=>J(B),onSearch:H,currentPage:B,totalPages:F,onPageChange:G}),s(m,{conversation:Z})));case"chat-settings":return s(k,{settings:{...T,...D,sections:o?.settings_sections||{api_config:{title:i("API Configuration","echo-knowledge-base"),icon:"epkbfa epkbfa-cog",fields:{}}}},onChange:Q,onSave:W,isSaving:E,onPresetChange:V});default:return null}};return s("div",{className:"epkb-ai-chat-container"},ae.length>0&&s("div",{className:"epkb-ai-sub-tabs"},s("div",{className:"epkb-ai-sub-tabs-header"},s("div",{className:"epkb-ai-sub-tabs-nav"},ae.map((e=>s("button",{key:e.id,className:`epkb-ai-sub-tab-button epkb-ai-sub-tab-${e.id} ${f===e.id?"active":""}`,onClick:()=>{v(e.id);const a=new URL(window.location);a.searchParams.set("active_sub_tab",e.id);window.history.pushState({},"",a)}},e.title)))),p&&s(p),f==="chat-settings"&&s("button",{type:"button",className:"epkb-ai-button epkb-ai-button-primary epkb-ai-sub-tabs-save-button",onClick:W,disabled:E},E?i("Saving...","echo-knowledge-base"):i("Save Settings","echo-knowledge-base")))),ie())};window.EPKB_AI_Chat={AIAdminChat:f}})();