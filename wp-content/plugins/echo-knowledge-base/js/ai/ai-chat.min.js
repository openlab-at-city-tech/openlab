(function(){"use strict";const e=window.wp&&window.wp.element;const t=e||window.React;const n=window.ReactDOM;if(!t||!n){window.EPKBChatUtils.logError("AI Chat","React is not available");return}if(!window.EPKBChatAPI||!window.EPKBChatCache||!window.EPKBChatSession||!window.EPKBChatUtils||!window.EPKBChatDisplay){console.error("AI Chat: Required modules not loaded");return}const{useState:r,useEffect:s,useRef:o,createElement:a}=t;const{ChatAPIClient:c}=window.EPKBChatAPI;const{ChatCacheManager:i}=window.EPKBChatCache;const{SessionManager:l}=window.EPKBChatSession;const{isDebugMode:u,createMessage:d,prepareMessage:f,getChatRootElement:g,logError:h,TypingIndicator:w,LoadingSkeleton:m,useFocusTrap:p}=window.EPKBChatUtils;const{darkenColor:C,createMessageComponent:I,renderChatWidget:y}=window.EPKBChatDisplay;const _=w(t);const b=m(t);const v=p(t);const E=I(t);function M(){const e=window.epkbAIChat||{};const n=e.welcome_message||"Hello! How can I help you today?";const a=e.widget_header_background_color||"#0073aa";const w={launcher:e.launcher_background_color||"#0073aa",header:a,headerGradient:`linear-gradient(135deg, ${a} 0%, ${C(a,20)} 100%)`};const m={generic:e.error_generic_message||"Sorry, something went wrong. Please try again.",network:e.error_network_message||"Connection error. Please check your internet and try again.",timeout:e.error_timeout_message||"The request timed out. Please try again.",rateLimit:e.error_rate_limit_message||"Too many requests. Please wait a moment and try again."};const p=g();const I=p&&p.getAttribute("data-is-admin")==="true";const M=p&&p.getAttribute("data-collection-id");const P=u();const S=I||P;if(P&&!I){console.log("EPKB AI Chat: Debug mode enabled. Technical messages will be shown.");console.log("To disable debug mode, run: epkbEnableDebug(false)")}const A=o(new i);const k=o(new l({rest_nonce:e.rest_nonce,isAdmin:I,debugMode:P}));const R=o(new c({rest_url:e.rest_url,rest_nonce:k.current.getNonce(),isAdmin:I,debugMode:P}));s((()=>{k.current.setApiClient(R.current)}),[]);const[x,K]=r(false);const[B,T]=r([d(n,false)]);const[D,U]=r("");const[L,N]=r(false);const[q,W]=r("");const[O,$]=r(false);const[F,V]=r(false);const[j,H]=r(false);const[G,J]=r("");const Y=o(false);const z=o(false);const Q=o("");const X=o(false);const Z=o(null);const ee=o(false);const te=o(null);const ne=o(null);const re=o(null);s((()=>{k.current.onNonceUpdate((e=>{R.current.setNonce(e)}));return()=>{k.current.cleanup()}}),[]);s((()=>{Q.current=G}),[G]);s((()=>{async function e(){const e=A.current.loadChatId();if(e){const t=A.current.loadMessages(e);if(t&&t.length>0){const n=t.map((e=>d(e.content,e.role==="user",e.id)));T(n);J(e);$(true);if(S){console.log(`Loaded ${n.length} messages from cache instantly!`)}return}return}}e()}),[]);s((()=>{if(!x||z.current)return;z.current=true;async function e(){const e=await k.current.startSession();if(!e.success&&S){h("AI Chat","Failed to establish session on chat open",{errorInfo:e.errorInfo})}if(!O){const e=A.current.loadChatId();if(e&&B.length===1){const t=await R.current.getConversation(e);if(t.success&&t.data){if(t.data.chat_id){J(t.data.chat_id);A.current.saveChatId(t.data.chat_id)}if(t.data.messages&&t.data.messages.length>0){const e=t.data.messages.map((e=>d(e.content,e.role==="user",e.id)));T(e);const n=t.data.messages.map((e=>({id:e.id,content:e.content,role:e.role})));A.current.saveMessages(t.data.chat_id,n);if(S){console.log(`Loaded ${e.length} messages from server on chat open`)}}}else if(!t.success&&t.errorInfo){const r=t.errorInfo;if(k.current.isSessionError(r)){if(S){console.log("Authentication error on conversation load, starting fresh")}A.current.clearChatId();A.current.clearMessageCache(e);J("");T([d(n,false)])}}}$(true)}}e()}),[x,S]);s((()=>{if(ne.current){ne.current.scrollIntoView({behavior:"smooth"})}}),[B,L]);v(te,x,(()=>K(false)));s((()=>{if(x){ee.current=true;if(re.current){re.current.focus()}}else if(ee.current){if(Z.current){Z.current.focus()}}}),[x]);s((()=>()=>{Y.current=false;R.current.clearRetries()}),[]);s((()=>{if(G&&B.length>1){const e=B.map((e=>({id:e.messageId,content:e.text,role:e.isUser?"user":"assistant"})));A.current.saveMessages(G,e)}}),[G,B]);function se(){N(false);Y.current=false;H(false)}function oe(e){k.current.handleNewToken(e)}async function ae(e=false){return await k.current.refreshNonce(e)}async function ce(t,n,r=0){if(r>2){se();W("Unable to establish session. Please refresh the page.");return{success:false}}const s=G;if(s&&!s.startsWith("chat_")){if(S){console.warn("Invalid chat ID format:",s)}J("");A.current.clearChatId()}const o=X.current;if(o){X.current=false;if(S){console.log("Forcing new conversation for this message")}}const a=await R.current.sendMessageWithRetry(t,n,s,e.widget_id||"1",M,0,false,o,{onNewToken:oe,onSessionUpdate:e=>{if(s&&Q.current!==s){if(S){console.log("Session update ignored - conversation changed")}return}J(e.chatId);A.current.saveChatId(e.chatId);if(e.chatId){$(true)}},onSuccess:e=>{if(s&&Q.current!==s){if(S){console.log("Message response ignored - conversation cleared")}se();return}let t;if(typeof e.response==="object"&&e.response!==null){t=e.response.text||e.response.content||JSON.stringify(e.response);if(S){console.log("Response object structure:",e.response)}}else{t=String(e.response)}const n=d(t,false,e.message_id);T((e=>{const t=e.some((e=>e.messageId===n.messageId||!e.isUser&&e.text===n.text&&Math.abs(e.id-n.id)<5e3));if(t){if(S){console.log("Duplicate bot message detected, skipping:",n.messageId)}return e}return[...e,n]}));se()},onInvalidNonce:async()=>{await ae(true)},onTimeoutError:(t,n)=>{se();const r=n?n.finalMessage:e.error_generic||"Unable to connect. Please refresh the page and try again.";W(r)},onRetry:(e,t)=>{if(e>1){N(true)}},onFinalError:async(t,s)=>{if(s&&s.code){if(s.code==="duplicate_request"){if(S){console.log("Duplicate request detected, original request still processing")}return}const e=k.current.handleSessionError(s);if(e==="clear"){se();le();return}else if(e==="expired_conversation"){se();ue(s);return}else if(e==="refresh_nonce"){return}if(e==="new_session"){if(S){console.log("Session expired during message send, creating new session...")}const e=await k.current.startSession();if(e.canceled){se();de();return}if(e.success){J("");A.current.clearChatId();await ce(o,n,r+1);return}}}se();if(k.current.isSessionError(s)){if(S){console.log("Authentication/cookie error detected, starting new conversation")}de();return}let o;if(s){o=s.finalMessage;if(s.type==="rate_limit"&&s.context.retryAfter){o+=` Please try again in ${s.context.retryAfter} seconds.`}if(I&&s.code){h("AI Chat","Message send failed",{type:s.type,code:s.code,statusCode:s.statusCode,context:s.context})}}else{o=e.error_generic||"Unable to connect. Please refresh the page and try again."}W(o)}});return a}const ie=async()=>{if(Y.current)return;const e=f(D);if(!e.valid){return}R.current.clearRetries();W("");T((t=>[...t,e.message]));U("");N(true);Y.current=true;H(true);try{await ce(e.text,e.messageId)}catch(e){if(S){h("AI Chat","Unexpected error in handleSend",{error:e.message||e,stack:e.stack})}W("An unexpected error occurred. Please try again.");se()}finally{if(Y.current){Y.current=false}}};function le(){if(S){console.log("User state changed - starting new conversation")}const e=G;J("");A.current.clearChatId();if(e){A.current.clearMessageCache(e)}T([d(n,false)]);$(false);X.current=true}function ue(e){const t=e?.finalMessage||"Your previous conversation has expired. Starting a new conversation...";W(t);const r=G;J("");A.current.clearChatId();if(r){A.current.clearMessageCache(r)}T([d(n,false)]);$(false);setTimeout((()=>{W("")}),5e3)}function de(){if(Y.current){if(S){console.log("Cannot clear - message is being sent")}return}if(S){console.log("Clearing conversation...")}const e=G;R.current.clearRetries();J("");A.current.clearChatId();if(e){A.current.clearMessageCache(e)}T([d(n,false)]);W("");$(false);X.current=true;if(S){console.log("Conversation cleared. New chat_id will be generated on next message.")}}const fe=e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();ie()}};return y({isOpen:x,messages:B,inputValue:D,isTyping:L,errorMessage:q,isInitialConversationLoading:F,isSending:j,setIsOpen:K,setInputValue:U,handleSend:ie,handleKeyDown:fe,clearConversation:de,chatWindowRef:te,messagesEndRef:ne,inputRef:re,toggleButtonRef:Z,config:e,widgetColors:w,isAdmin:I,showTechnicalLogs:S,Message:E,TypingIndicator:_,LoadingSkeleton:b},t)}function P(){const e=g();if(!e){h("AI Chat","Widget root element not found",{expectedId:window.epkbChatWidgetRoot||"epkb-ai-chat-widget-root"});return}if(typeof n.createRoot==="function"){const t=n.createRoot(e);t.render(a(M))}else{n.render(a(M),e)}}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",P)}else{P()}})();