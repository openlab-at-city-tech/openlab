jQuery(document).ready((function(e){const{parseAIChatErrorResponse:a,parseMessageFormatting:t,logError:s,showErrorMessage:r,createErrorReport:i}=window.EPKBChatUtils;function n(n,l,o,c,d,h){const p=window.epkbAISearch||{};let _=p.rest_url+p.search_endpoint;l.show();o.hide();c.hide();const m={query:n};if(d){m.kb_id=d}if(h){m.collection_id=h}return e.ajax({type:"POST",dataType:"json",url:_,data:JSON.stringify(m),contentType:"application/json",headers:{"X-WP-Nonce":p.rest_nonce}}).done((function(e){l.hide();if(e&&e.response){const a=t(e.response);o.html(a).show()}else{let a=e&&e.message||p.msg_try_again;c.text(a).show()}})).fail((function(e,t,o){l.hide();let d={};try{d=e.responseJSON||{}}catch(e){}s("AI Search","Search request failed",{status:e.status,statusText:e.statusText,errorThrown:o,response:d,query:n});const h=a(new Error(d.message||"Request failed"),{status:e.status,data:d},p.is_admin);const _=p.is_admin?h.adminMessage:h.userMessage;r({message:_,isAdmin:p.is_admin,container:c,onReport:function(e){const a=i("AI Search",e,d,n);console.log("AI Search Error Report:\n",a);if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(a).then((()=>{alert("Error report copied to clipboard. Please share with support.")})).catch((()=>{alert("Error report logged to console. Please check console and share with support.")}))}else{alert("Error report logged to console. Please check console and share with support.")}},source:"search"})}))}e(document).on("click",".epkb-ml-ai-search-button",(function(a){a.preventDefault();let t=e(this);let s=t.closest(".epkb-ml-ai-search-section");let r=s.data("kb-id");let i=null;let l="";if(e("#asea_search_form").length){l=e("#asea_advanced_search_terms").val();i=e("#asea_search_form").data("collection-id")}else if(e("#epkb-ml-search-box").length){l=e(".epkb-ml-search-box__input").val();i=e("#epkb-ml-search-form").data("collection-id")}let o=t.find(".epkb-ml-ai-search-button__text");let c=o.text();o.text("Thinking...");t.prop("disabled",true);let d=s.find(".epkb-ml-ai-search-answer");if(d.length===0){let e='<div class="epkb-ml-ai-search-answer" style="display:none;">'+'<div class="epkb-ml-ai-search-answer__loading" style="display:none;">Loading...</div>'+'<div class="epkb-ml-ai-search-answer__content" style="display:none;"></div>'+'<div class="epkb-ml-ai-search-answer__error" style="display:none;"></div>'+"</div>";s.append(e);d=s.find(".epkb-ml-ai-search-answer")}let h=d.find(".epkb-ml-ai-search-answer__loading");let p=d.find(".epkb-ml-ai-search-answer__content");let _=d.find(".epkb-ml-ai-search-answer__error");if(d.is(":visible")){d.slideUp();o.text(c);t.prop("disabled",false);return}d.slideDown();if(p.html().trim()!==""){h.hide();p.show();o.text(c);t.prop("disabled",false);return}n(l,h,p,_,r,i).always((function(){o.text(c);t.prop("disabled",false)}))}));function l(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__loading");let r=a.find(".epkb-ml-ai-search-answer__content");let i=a.find(".epkb-ml-ai-search-answer__error");let l=a.data("kb-id");let o=null;let c="";if(e("#asea_advanced_search_terms").length){c=e("#asea_advanced_search_terms").val();o=e("#asea_search_form").data("collection-id")}else if(e(".epkb-ml-search-box__input").length){c=e(".epkb-ml-search-box__input").val();o=e("#epkb-ml-search-form").data("collection-id")}if(!c||r.html().trim()!==""){return}t.show();n(c,s,r,i,l,o)}))}let o=window.epkb_ml_search_result_callback;window.epkb_ml_search_result_callback=function(a){if(o){o(a)}e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));setTimeout(l,100);e('.epkb-ml-ai-search-section[data-display-mode="button"] .epkb-ml-ai-search-answer__content').empty()};window.epkb_perform_ai_search=n;window.epkb_init_ai_search_auto=l;e(document).on("ajaxComplete",(function(a,t,s){if(s&&s.url&&s.url.indexOf("asea-advanced-search-kb")!==-1){setTimeout((function(){e('.epkb-ml-ai-search-section[data-display-mode="auto"]').each((function(){let a=e(this);let t=a.find(".epkb-ml-ai-search-answer");let s=a.find(".epkb-ml-ai-search-answer__content");let r=a.find(".epkb-ml-ai-search-answer__error");s.empty().hide();r.hide()}));l()}),100)}}))}));