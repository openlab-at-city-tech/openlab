jQuery(document).ready((function(e){const t=e("#epkb-analytics-date-range-preset");const a=e(".epkb-analytics-date-range-custom");const i=e("#epkb-analytics-date-range-apply");const n=e("#epkb-analytics-date-start");const o=e("#epkb-analytics-date-end");const s=e(".epkb-analytics-page-container");if(t.length){t.on("change",(function(){if(e(this).val()==="custom"){a.show()}else{a.hide()}}))}e(".epkb-analytics-date-range-quick-btn").on("click",(function(){const a=e(this).data("preset");t.val(a).trigger("change");i.trigger("click")}));if(i.length){i.on("click",(function(){const a=t.val();const i=n.val();const r=o.val();const l=s.data("kb-id");if(a==="custom"&&(!i||!r)){alert("Please select both start and end dates.");return}if(a==="custom"&&new Date(i)>new Date(r)){alert("Start date must be before end date.");return}u("Loading...");e.ajax({url:window.ajaxurl||window.epkb_vars&&window.epkb_vars.ajax_url,method:"POST",dataType:"json",data:{action:"epkb_get_filtered_analytics",kb_id:l,preset:a,start_date:i,end_date:r,_wpnonce_epkb_ajax_action:window.epkb_vars&&window.epkb_vars.nonce?window.epkb_vars.nonce:""}}).done((function(t){if(t&&t.success&&t.data&&t.data.sections){const a=t.data.sections;e.each(a,(function(t,a){const i=e('.epkb-analytics-tab-panel[data-analytics-panel="'+t+'"]');if(i.length){i.find(".epkb-analytics-tab-panel__inner").html(a)}}));const i=e(".epkb-analytics-tab-button.is-active").data("analytics-tab");setTimeout((function(){if(i==="time-based-analytics"){p()}else if(i==="article-views"){d()}else if(i==="rating"){b()}else if(i==="all-data"||i==="kb-search"||i==="search-shortcode"||i==="widgets"){f()}}),100)}else{alert("Failed to load analytics data. Please try again.")}})).fail((function(){alert("Failed to load analytics data. Please try again.")})).always((function(){h()}))}))}const r=e(".epkb-analytics-tab-button");const l=e(".epkb-analytics-tab-panel");if(r.length){r.on("click",(function(){const t=e(this).data("analytics-tab");r.removeClass("is-active");e(this).addClass("is-active");l.removeClass("is-active");l.filter(`[data-analytics-panel="${t}"]`).addClass("is-active");if(t==="time-based-analytics"){setTimeout(p,80)}else if(t==="article-views"){setTimeout(d,80)}else if(t==="rating"){setTimeout(b,80)}else if(t==="all-data"||t==="kb-search"||t==="search-shortcode"||t==="widgets"){setTimeout(f,80)}}))}function c(t){let a;let i;let n;let o;let s;if(e(".epkb-analytics-page-container").length>0){a=[];i=[];s=e("#"+t+" .epkb-pie-data-list .epkb-first-10").length;e("#"+t+" .epkb-pie-data-list .epkb-first-10").each((function(){a.push(e(this).find(".epkb-pie-chart-count").text());i.push(e(this).find(".epkb-pie-chart-word").text())}));if(e("#"+t).hasClass("epkb-pie-chart-container-show-data")){n=0;o="Remaining Results";s=e("#"+t+" .epkb-pie-data-list li").length;e("#"+t+" .epkb-pie-data-list .epkb-after-10").each((function(){n+=Number(e(this).find(".epkb-pie-chart-count").text())}));a.push(n);i.push(o)}e("#"+t+" .epkb-pie-data-total").remove();e("#"+t+" h4").append('<span class="epkb-pie-data-total"> ( '+s+" )</span>");e("#"+t+"-chart").remove();e("#"+t+" .epkb-pie-chart-right-col #epkb-pie-chart").append('<canvas id="'+t+"-chart"+'"><canvas>');const r=document.getElementById(t+"-chart").getContext("2d");new Chart(r,{type:"doughnut",data:{labels:i,datasets:[{data:a,backgroundColor:["#aed581","#4fc3f7","#FED32F","#ef5350","#D0D8E0","#ff8a65","#ba68c8","#4A7BEC","#768CA3","#8d6e63","#444444"]}]},options:{maintainAspectRatio:false,legend:{display:false,position:"left"}}})}}function d(){if(!e("#epkb-article-views-data-content").length){return}if(e("#epkb-popular-articles").length){c("epkb-popular-articles")}if(e("#epkb-not-popular-articles").length){c("epkb-not-popular-articles")}if(e("#epkb-high-performers").length){c("epkb-high-performers")}if(e("#epkb-low-performers").length){c("epkb-low-performers")}}function p(){if(!e(".epkb-time-based-analytics-container").length){return}const t=e("#epkb-time-chart");if(t.length){const e=t.data("weekly-data");if(e&&e.length>0){const t=e.map((e=>e.week_label));const a=e.map((e=>e.total_views));const i=document.getElementById("epkb-time-chart").getContext("2d");if(window.epkbTimeChart&&typeof window.epkbTimeChart.destroy==="function"){window.epkbTimeChart.destroy()}window.epkbTimeChart=new Chart(i,{type:"line",data:{labels:t,datasets:[{label:"Views",data:a,borderColor:"#4A7BEC",backgroundColor:"rgba(74, 123, 236, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#4A7BEC",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:false,callbacks:{title:function(e){return e[0].label},label:function(e){return"Views: "+e.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}const a=e("#epkb-engagement-distribution-chart");if(a.length){const e=a.data("distribution");if(e&&e.length>0){const t=e.map((e=>e.label));const a=e.map((e=>e.count));const i=document.getElementById("epkb-engagement-distribution-chart").getContext("2d");if(window.epkbEngagementChart&&typeof window.epkbEngagementChart.destroy==="function"){window.epkbEngagementChart.destroy()}const n={"0 Views":"#ef5350","1-10 Views":"#ff8a65","11-50 Views":"#FED32F","51-100 Views":"#aed581","101-500 Views":"#4fc3f7","500+ Views":"#4A7BEC"};const o=t.map((e=>n[e]||"#999999"));window.epkbEngagementChart=new Chart(i,{type:"bar",data:{labels:t,datasets:[{label:"Number of Articles",data:a,backgroundColor:o,borderColor:o,borderWidth:1,borderRadius:4}]},options:{indexAxis:"y",responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:false,callbacks:{label:function(e){const t=e.parsed.x;const a=e.dataset.data.reduce(((e,t)=>e+t),0);const i=(t/a*100).toFixed(1);return t+" articles ("+i+"%)"}}}},scales:{x:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},y:{grid:{display:false}}}}})}}const i=e("#epkb-searches-chart");if(i.length){const e=i.data("searches-data");if(e&&e.length>0){const t=e.map((e=>e.week_label));const a=e.map((e=>e.total_searches));const i=document.getElementById("epkb-searches-chart").getContext("2d");if(window.epkbSearchesChart&&typeof window.epkbSearchesChart.destroy==="function"){window.epkbSearchesChart.destroy()}window.epkbSearchesChart=new Chart(i,{type:"line",data:{labels:t,datasets:[{label:"Searches",data:a,borderColor:"#f39c12",backgroundColor:"rgba(243, 156, 18, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#f39c12",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#f39c12",borderWidth:1,displayColors:false,callbacks:{title:function(e){return e[0].label},label:function(e){return"Searches: "+e.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}const n=e("#epkb-ratings-chart");if(n.length){const e=n.data("ratings-data");if(e&&e.length>0){const t=e.map((e=>e.week_label));const a=e.map((e=>e.positive_ratings));const i=e.map((e=>e.negative_ratings));const n=document.getElementById("epkb-ratings-chart").getContext("2d");if(window.epkbRatingsChart&&typeof window.epkbRatingsChart.destroy==="function"){window.epkbRatingsChart.destroy()}window.epkbRatingsChart=new Chart(n,{type:"line",data:{labels:t,datasets:[{label:"Positive Feedback",data:a,borderColor:"#27ae60",backgroundColor:"rgba(39, 174, 96, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#27ae60",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6},{label:"Negative Feedback",data:i,borderColor:"#e74c3c",backgroundColor:"rgba(231, 76, 60, 0.1)",borderWidth:2,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:"#e74c3c",pointBorderColor:"#fff",pointBorderWidth:2,pointHoverRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true,position:"top",labels:{usePointStyle:true,padding:15}},tooltip:{mode:"index",intersect:false,backgroundColor:"rgba(0, 0, 0, 0.8)",padding:12,titleColor:"#fff",bodyColor:"#fff",borderColor:"#4A7BEC",borderWidth:1,displayColors:true,callbacks:{title:function(e){return e[0].label},label:function(e){return e.dataset.label+": "+e.parsed.y.toLocaleString()}}}},scales:{y:{beginAtZero:true,ticks:{precision:0},grid:{color:"rgba(0, 0, 0, 0.05)"}},x:{grid:{display:false},ticks:{maxRotation:45,minRotation:45}}}}})}}}function b(){if(!e("#eprf-rating-data-content").length){return}if(typeof display_eprf_pie_chart==="function"){display_eprf_pie_chart("eprf-best-ratinges-data");display_eprf_pie_chart("eprf-worst-ratinges-data");display_eprf_pie_chart("eprf-popular-ratinges-data");display_eprf_pie_chart("eprf-no-result-popular-ratinges-data")}}function f(){if(typeof display_asea_pie_chart!=="function"){return}const t=e(".epkb-analytics-tab-panel.is-active");t.find(".asea-pie-chart-container").each((function(){const t=e(this).attr("id");if(t){display_asea_pie_chart(t)}}))}const g=e(".epkb-article-views-toggle__input");if(g.length){g.on("change",(function(){const t=e(this);const a=t.is(":checked");if(!a){t.prop("checked",false);return}const i=t.closest(".epkb-analytics-article-views-disabled");const n=i.data("kb-id");const o=i.find(".epkb-article-views-toggle__status");const s=window.ajaxurl||window.epkb_vars&&window.epkb_vars.ajax_url;if(!n||!s){console.error("EPKB: Missing data to toggle article views counter.",{kbId:n,ajaxUrl:s});t.prop("checked",false);return}if(i.hasClass("is-processing")){return}const r=i.data("enablingMessage")||"Enabling article views counter...";const l=i.data("successMessage")||"Article views counter enabled. Reloading...";const c=i.data("errorMessage")||"Unable to update setting. Please try again.";i.addClass("is-processing");t.prop("disabled",true);if(o.length){o.text(r)}e.ajax({url:s,method:"POST",dataType:"json",data:{action:"epkb_toggle_article_views_counter",kb_id:n,enable:"on",_wpnonce_epkb_ajax_action:window.epkb_vars&&window.epkb_vars.nonce?window.epkb_vars.nonce:""}}).done((function(e){if(e&&e.success){if(o.length){o.text(l)}setTimeout((function(){window.location.reload()}),600);return}d(e&&e.data&&e.data.message?e.data.message:c)})).fail((function(){d(c)}));function d(e){i.removeClass("is-processing");t.prop("disabled",false).prop("checked",false);if(o.length){o.text(e)}}}))}if(e(".epkb-analytics-page-container").length>0){e(document).on("click",".epkb-pie-chart__more-button",(function(){const t=e(this).closest(".epkb-pie-chart-container").attr("id");e("#"+t).toggleClass("epkb-pie-chart-container-show-data");e(`#${t} .epkb-pie-chart__more-button__more-text`).toggleClass("epkb-hidden");e(`#${t} .epkb-pie-chart__more-button__less-text`).toggleClass("epkb-hidden");c(t)}));e(document).on("click",".epkb-article-list__more-button",(function(){const t=e(this);const a=t.closest(".epkb-list-container, .epkb-improvement-container");const i=a.find(".epkb-after-20");i.toggle();t.find(".epkb-article-list__more-button__more-text").toggleClass("epkb-hidden");t.find(".epkb-article-list__more-button__less-text").toggleClass("epkb-hidden")}))}if(e('.epkb-analytics-tab-button[data-analytics-tab="article-views"]').hasClass("is-active")){setTimeout(d,80)}if(e('.epkb-analytics-tab-button[data-analytics-tab="time-based-analytics"]').hasClass("is-active")){setTimeout(p,80)}if(e('.epkb-analytics-tab-button[data-analytics-tab="rating"]').hasClass("is-active")){setTimeout(b,80)}function u(t){h();const a='<div class="epkb-admin-dialog-box-loading">'+'<div class="epkb-admin-dbl__header">'+'<div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+"</div>"+"</div>"+'<div class="epkb-admin-dialog-box-overlay"></div>';e("body").append(a)}function h(){e(".epkb-admin-dialog-box-loading").remove();e(".epkb-admin-dialog-box-overlay").remove()}}));