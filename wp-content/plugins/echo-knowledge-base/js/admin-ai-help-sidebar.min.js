jQuery(document).ready(function(e){function t(e){return e.trim().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function a(){if("off"===e(".epkb-ai-help-sidebar").attr("data-apikey-state")){let t=e("#openai_api_key");return t.length&&!t.val().trim().length?(p(epkb_ai_vars.msg_no_key_admin),e(".epkb-ai-help-sidebar__nav-link").trigger("click")):t.length||p(epkb_ai_vars.msg_no_key),!1}return!0}function i(e){return e.replace(/(<\/?(?:span|p|li|ul|ol|br|i|strong|b|h1|h2|h3|h4|h5|h6|em|sub|sup|pre)[^>]*>)|<[^>]+>/gi,"$1").replace(/\s+\S+?=("|')(.*?)("|')/g,"")}function n(e){return e.replace(/<[^>]*>/g,"").replace(/&nbsp;/g,"").trim().length}function o(e,t,a){return'<div class="eckb-bottom-notice-message"><span class="eckb-bottom-notice-message-icon '+("success"==a?"ep_font_icon_checkmark":"epkbfa epkbfa-times-circle")+'"></span><div class="contents"><span class="'+a+'">'+(e?"<h4>"+e+"</h4>":"")+(t?"<p>"+t+"</p>":"")+"</span></div></div>"}function p(t,a=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(o(a,t,"error")),clearTimeout(_),_=setTimeout(function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")},1e4)}function s(t,a=""){e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(o(a,t,"success")),clearTimeout(_),_=setTimeout(function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")},1e4)}function r(t,a,i,n,p,s){let r,b;a=void 0===a?"epkb_callback_noop":a,e.ajax({type:"POST",dataType:"json",data:t,url:ajaxurl,beforeSend:function(e){void 0!==s&&!1!==s||l("show",epkb_ai_vars.msg_ai_help_loading),"object"==typeof s&&l("show",epkb_ai_vars.msg_ai_help_loading,s)}}).done(function(e){((b=e||"").error||void 0===b.message)&&(r=b.message?b.message:o("",epkb_ai_vars.reload_try_again,"error"))}).fail(function(e,t,a){r=a?" ["+a+"]":epkb_ai_vars.unknown_error,r=o(epkb_ai_vars.error_occurred+". "+epkb_ai_vars.msg_try_again,r,"error")}).always(function(){if(b=void 0===b?"":b,"function"==typeof p&&p(b),void 0!==s&&!1!==s||l("remove",""),"object"==typeof s&&l("remove","",s),r)return e(".epkb-ai-help-sidebar__bottom-notice-message-container").html(""),e(".epkb-ai-help-sidebar__bottom-notice-message-container").append(r),void setTimeout(function(){e(".eckb-bottom-notice-message").addClass("fadeOutDown")},1e4);"function"==typeof a?"undefined"===i?a(b):a(b,i):n&&location.reload()})}function l(e,t,a){if("show"===e){let e='<div class="epkb-admin-dialog-box-loading"><div class="epkb-admin-dbl__header"><div class="epkb-admin-dbl-icon epkbfa epkbfa-hourglass-half"></div>'+(t?'<div class="epkb-admin-text">'+t+"</div>":"")+'</div></div><div class="epkb-admin-dialog-box-overlay"></div>';a.append(e)}else"remove"===e&&(a.find(".epkb-admin-dialog-box-loading").remove(),a.find(".epkb-admin-dialog-box-overlay").remove())}wp&&wp.data&&wp.data.subscribe(function(){setTimeout(function(){if(0===e("#epkb-ai-help-sidebar-button").length){var t=e(".edit-post-header-toolbar");void 0!==t&&e(t).append('<input type="button" id="epkb-ai-help-sidebar-button" value="'+epkb_ai_vars.ai_help_button_title+'">')}},100)}),e(document).on("click","#wp-admin-bar-epkb-ai-help-sidebar-button",function(t){return t.preventDefault(),e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active"),e("#wp-admin-bar-epkb-ai-help-sidebar-button").addClass("wp-admin-bar-epkb-ai-help-sidebar-button--active"),!1}),e(document).on("click","#epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button",function(){e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--active")}),e(document).on("click",".epkb-ai-help-sidebar-btn-close",function(t){return t.preventDefault(),e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--active"),e("#wp-admin-bar-epkb-ai-help-sidebar-button").removeClass("wp-admin-bar-epkb-ai-help-sidebar-button--active"),!1}),e(document).on("click",".epkb-ai-help-sidebar__nav-link",function(){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active"),e(this).addClass("epkb-ai-help-sidebar__nav-link--active");let t=e(this).data("target");e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar__body-"+t).addClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar").attr("data-active-tab",t)}),e(document).on("click",".epkb-ai-help-sidebar__open-settings-tab-btn",function(t){return t.stopPropagation(),e(".epkb-ai-help-sidebar__nav-link").trigger("click"),!1}),e(document).on("click",".epkb-ai-help-sidebar__main-intro__dismiss-btn",function(){e(this).closest(".epkb-ai-help-sidebar__main-intro").remove();r({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_dismiss_main_intro"},void 0,void 0,!1,!1,e(".epkb-ai-help-sidebar__improve-text-selected-text-container"))}),e(document).on("click",".epkb-ai__fix-improve-text-btn",function(t){return t.preventDefault(),!!a()&&(e(".epkb-ai-help-sidebar__main").hide(),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),e(".epkb-ai-help-sidebar__improve-text").show(),e(".epkb-ai-help-sidebar").addClass("epkb-ai-help-sidebar--select-text-mode"),!1)}),e(document).on("click",".epkb-ai-help-sidebar__nav-back-btn",function(){e('[data-target="helper-functions"]').trigger("click"),e(".epkb-ai-help-sidebar__main").show(),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","hide"),e(".epkb-ai-help-sidebar__improve-text").hide(),e(".epkb-ai-help-sidebar__article-outline").hide(),e(".epkb-ai-help-sidebar").removeClass("epkb-ai-help-sidebar--select-text-mode")}),e(document).on("selectionchange",function(){if(0==e(this.getSelection().anchorNode).closest("#wpbody-content").length)return;if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||"none"==e(".epkb-ai-help-sidebar__improve-text").css("display"))return;if(0==document.getSelection().toString().length)return;let t=document.getSelection().getRangeAt(0),a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a),e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let n=i(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(n);let o=e(t.commonAncestorContainer).prop("tagName");!o||"UL"!==o&&"OL"!==o||"LI"!==e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")||e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+o.toLowerCase()+">"+n+"</"+o.toLowerCase()+">")}),e("#wp-admin-bar-epkb-ai-help-sidebar-button, #epkb-ai-help-meta-box-button").one("click",function(){e("#content_ifr").contents().on("selectionchange",function(){if(!e(".epkb-ai-help-sidebar").hasClass("epkb-ai-help-sidebar--active")||"none"==e(".epkb-ai-help-sidebar__improve-text").css("display"))return;if(0==document.getElementById("content_ifr").contentDocument.getSelection().toString().length)return;let t=document.getElementById("content_ifr").contentDocument.getSelection().getRangeAt(0),a=t.cloneContents();e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(a),e(".epkb-ai-help-sidebar__improve-text-input__textarea").find("#elementor-editor").remove();let n=i(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html());e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(n);let o=e(t.commonAncestorContainer).prop("tagName");!o||"UL"!==o&&"OL"!==o||"LI"!==e(".epkb-ai-help-sidebar__improve-text-input__textarea").find(":first-child").prop("tagName")||e(".epkb-ai-help-sidebar__improve-text-input__textarea").html("<"+o.toLowerCase()+">"+n+"</"+o.toLowerCase()+">")})});let b="";e(document).on("selectionchange",function(){if(0==e(this.getSelection().anchorNode).closest(".epkb-ai-help-sidebar__improve-text-input__textarea-wrap").length)return;let t=document.getSelection().getRangeAt(0);b=t.cloneContents()}),e('.epkb-ai-help-sidebar__improve-text-toolbar input[type="submit"]').on("click",function(t){let a=e("<div></div>").append(b).html(),i=n(a)>3?a:e(".epkb-ai-help-sidebar__improve-text-input__textarea").html();if(n(i)<3)return p(epkb_ai_vars.msg_empty_input),!1;if(e(this).hasClass("epkb_ai_copy")){let t;n(a)>3?t=document.getSelection().getRangeAt(0):(t=document.createRange()).selectNodeContents(e(".epkb-ai-help-sidebar__improve-text-input__textarea").get(0));let i=window.getSelection();return i.removeAllRanges(),i.addRange(t),document.execCommand("copy"),i.removeAllRanges(),void s(epkb_ai_vars.msg_ai_copied_to_clipboard)}return r({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:i,ai_action:e(this).attr("class").trim()},function(t){t.error||void 0===t.message||(s(t.message),e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used),void 0!==t.fixed_input_text&&t.fixed_input_text.length>0&&(n(a)>3?e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(e(".epkb-ai-help-sidebar__improve-text-input__textarea").html().replace(i,t.fixed_input_text)):e(".epkb-ai-help-sidebar__improve-text-input__textarea").html(t.fixed_input_text)))},void 0,!1,!1,e(".epkb-ai-help-sidebar__improve-text-selected-text-container")),!1}),e(document).on("click",".epkb_ai_generate_article_outline",function(i){if(i.preventDefault(),!a())return!1;let n="";return n=t(e("input#title").length?e("input#title").val():wp.data.select("core/editor").getEditedPostAttribute("title")),e(".epkb-ai-help-sidebar__screen-usage").hide(),e(".epkb-ai-help-sidebar__main").hide(),e(".epkb-ai-help-sidebar__article-outline").show(),e(".epkb-ai-help-sidebar__article-outline-input-container").show(),e(".epkb-ai-help-sidebar__article-outline-results-container").hide(),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),e("#epkb_ai_article_title").val(n),!1}),e(document).on("click",".epkb_ai_generate_article_outline_button ",function(t){if(t.preventDefault(),!a())return!1;let i=e("#epkb_ai_article_title").val();if(i.length<3)return p(epkb_ai_vars.msg_empty_input),!1;r({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:i,ai_action:"epkb_ai_generate_outline"},function(t){!t.error&&void 0!==t.message&&void 0!==t.result&&t.result.length>0&&s(t.message),void 0!==t.result&&t.result.length>0&&(e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(t.tokens_used),e(".epkb-ai-help-sidebar__article-outline-result__textarea").html(t.result),e(".epkb-ai-help-sidebar__article-outline-input-container").hide(),e(".epkb-ai-help-sidebar__article-outline-results-container").show())},void 0,!1,!1,e(".epkb-ai-help-sidebar__article-outline"))}),e(document).on("keypress",".epkb-ai-help-sidebar__ai-input",function(a){if(13!==a.which)return;let i=e(this),n=t(i.val());e(".epkb-ai-help-sidebar__ai-response-container").html('<div class="epkb-ai-help-sidebar__ai-response-prompt"><span class="epkbfa epkbfa-user epkb-ai-help-sidebar__ai-response-prompt-icon"></span><div class="epkb-ai-help-sidebar__ai-response-prompt-text">'+n+"</div></div>"),i.attr("disabled","disabled");r({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,input_text:n,ai_action:"epkb_ai_chat"},function(a){void 0!==a.result&&a.result.length>0&&(e(".epkb-ai-help-sidebar__screen-usage").show().find(".epkb-ai-help-sidebar__screen-usage-tokens span").html(a.tokens_used),e(".epkb-ai-help-sidebar__ai-response-container").append('<div class="epkb-ai-help-sidebar__ai-response-result"><span class="ep_font_icon_light_bulb epkb-ai-help-sidebar__ai-response-result-icon"></span><div class="epkb-ai-help-sidebar__ai-response-result-text">'+t(a.result)+"</div></div>"))},void 0,!1,function(){i.removeAttr("disabled").focus()},e(".epkb-ai-help-sidebar__ai-response-container"))}),e(document).on("click",".epkb-ai__open-feedback-btn, #ai-help-feedback-link",function(t){e(".epkb-ai-help-sidebar__nav-link").removeClass("epkb-ai-help-sidebar__nav-link--active");let a=e(this).data("target");return e(".epkb-ai-help-sidebar__body").removeClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar__body-"+a).addClass("epkb-ai-help-sidebar__body--active"),e(".epkb-ai-help-sidebar").attr("data-active-tab",a),e(".epkb-ai-help-sidebar").attr("data-back-btn","show"),!1}),e(document).on("submit",".epkb-ai-help-sidebar__feedback-form",function(t){t.preventDefault(),t.stopPropagation();let a=e(this);r({action:"epkb_ai_feedback",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,feedback_text:a.find('textarea[name="feedback_text"]').val(),feedback_email:a.find('input[name="feedback_email"]').val(),feedback_name:a.find('input[name="feedback_name"]').val()},function(t){void 0!==t.message&&t.message.length>0&&(s(t.message),e(".epkb-ai-help-sidebar__nav-back-btn").trigger("click"))},void 0,!1,!1,e(".epkb-ai-help-sidebar__feedback-form"))}),e(document).on("click",".epkb-ai-help-sidebar__settings-save-btn",function(){if(!e(".epkb-ai-help-sidebar__settings-form").length)return;let t=e('input[name="openai_api_key"]').val().trim();return r({action:"epkb_ai_request",_wpnonce_epkb_ajax_action:epkb_ai_vars.nonce,ai_action:"epkb_ai_save_settings",openai_api_key:t,disable_openai:e('input[name="disable_openai"]').prop("checked")?"on":"off"},function(a){if(!a.error&&void 0!==a.message){s(a.message);let i=t.length>0?"on":"off";e(".epkb-ai-help-sidebar").attr("data-apikey-state",i)}},void 0,!1,!1,e(".epkb-ai-help-sidebar__body-settings")),!1});let _;e(document.body).on("click",".epkb-close-notice",function(){let t=e(this).closest(".eckb-bottom-notice-message");t.addClass("fadeOutDown"),setTimeout(function(){t.html("")},1e3)}),e(document.body).on("click",".epkbfa-times-circle",function(){let t=e(this).closest(".epkb-ai-help-sidebar__bottom-notice-message-container");t.addClass("fadeOutDown"),setTimeout(function(){t.html("")},1e3)}),e(".epkb-ai-help-sidebar__improve-text-result__textarea").on("click",function(){this.focus(),this.select()})});