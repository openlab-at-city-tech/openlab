jQuery(document).ready(function(e){function t(){return 0==o.$wrap.length?(e(document).epkb("notice/show",{message:epkb_vars.reload_try_again,type:"error"}),!1):1==o.step?o.$wrap.find("[name=epkb_convert_post]")&&0==o.$wrap.find("[name=epkb_convert_post]").first().prop("checked")?(e(document).epkb("notice/show",{message:epkb_vars.msg_confirm_kb,type:"error"}),!1):o.$wrap.find("[name=epkb_convert_backup]")&&0==o.$wrap.find("[name=epkb_convert_backup]").first().prop("checked")?(e(document).epkb("notice/show",{message:epkb_vars.msg_confirm_backup,type:"error"}),!1):!(o.$wrap.find("[name=epkb_convert_post_type]")&&!o.$wrap.find("[name=epkb_convert_post_type]").val())||(e(document).epkb("notice/show",{message:epkb_vars.msg_empty_post_type,type:"error"}),!1):2==o.step?0==o.$wrap.find("[name=row_id]").length?(e(document).epkb("notice/show",{message:epkb_vars.msg_nothing_to_convert,type:"error"}),!1):0!=o.$wrap.find("[name=row_id]:checked").length||(e(document).epkb("notice/show",{message:epkb_vars.msg_select_article,type:"error"}),!1):3==o.step||(e(document).epkb("notice/show",{message:epkb_vars.reload_try_again,type:"error"}),!1)}function n(t=1){"next"==t?o.step++:"prev"==t?o.step--:o.step=t;let a=1;for(;a<5;)o.step>=a?o.$wrap.find(".epkb-import-step--"+a).addClass("epkb-import-step--done"):o.$wrap.find(".epkb-import-step--"+a).removeClass("epkb-import-step--done"),a++;o.$wrap.find(".epkb-import-step").addClass("epkb-hidden"),o.$wrap.find(".epkb-import-step--"+o.step).removeClass("epkb-hidden"),1==o.step&&(o.$wrap.find(".epkb-convert-button-back").removeClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-exit").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-cancel").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-next").removeClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-start_convert").addClass("epkb-hidden"),o.$wrap.find(".convert-kb-name-checkbox").prop("checked",!1)),2==o.step&&(o.$wrap.find(".epkb-convert-button-back").removeClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-exit").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-cancel").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-next").removeClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-start_convert").addClass("epkb-hidden"),function(){let t=o.$wrap.find(".epkb-import-step--2 .epkb-progress");o.$wrap.find(".epkb-dsl__article-list-container, .epkb-convert-categories-filters").remove(),t.epkb("progress/clear_log"),t.epkb("progress/set",0),t.epkb("progress/add_log",{message:epkb_vars.msg_reading_posts});let r={_wpnonce_epkb_ajax_action:epkb_vars.nonce,action:"epkb_load_articles_list",kb_id:o.kb_id,epkb_convert_step:o.step,post_type:o.post_type,categories:[]};e.ajax({type:"POST",dataType:"json",data:r,url:ajaxurl}).done(function(r){if("object"==typeof r.success){for(let e in r.success)t.epkb("progress/add_log",{message:r.success[e],type:"success"});t.epkb("progress/set",100)}if(void 0!==r.response_html_1&&o.$wrap.find(".epkb-import-step.epkb-import-step--2").append(r.response_html_1),void 0!==r.response_html_2&&o.$wrap.find(".epkb-import-step.epkb-import-step--3").html(r.response_html_2),void 0!==r.error)return e(document).epkb("ajax/error_message",r.message),n(),!1}).fail(function(t,r,o){e(document).epkb("ajax/error_message",epkb_vars.msg_admin_error_l012),n()})}()),o.step>1&&(o.$wrap.find(".epkb-convert-button-start").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-next").removeClass("epkb-hidden")),3==o.step&&(o.$wrap.find(".epkb-convert-button-next").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-start_convert").removeClass("epkb-hidden")),4==o.step&&function(){let t=o.$wrap.find(".epkb-import-step--4 .epkb-progress");o.selected_array=[],o.$wrap.find("input[name=row_id]:checked").each(function(){o.selected_array.push(e(this).val())}),o.selected_count=o.selected_array.length,o.$wrap.find('input[name="convert_terms_mode"]:checked').length&&(o.convert_terms_mode=o.$wrap.find('input[name="convert_terms_mode"]:checked').val());o.$wrap.find("[name=categories_taxonomy]").length&&(o.category_taxonomy=o.$wrap.find("[name=categories_taxonomy]").val());o.$wrap.find("[name=tags_taxonomy]").length&&(o.tags_taxonomy=o.$wrap.find("[name=tags_taxonomy]").val());o.$wrap.find(".epkb-convert-button-next").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-back").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-start_convert").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-cancel").removeClass("epkb-hidden"),o.$wrap.find(".epkb-form-field-non_attachments-message").html(""),t.epkb("progress/clear_log"),t.epkb("progress/set",0),t.epkb("progress/add_log",{message:epkb_vars.msg_converting}),r()}(),o.step<4&&(o.$wrap.find(".epkb-convert-button-cancel").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-exit").addClass("epkb-hidden"))}function r(){let t=o.$wrap.find(".epkb-import-step--4 .epkb-progress"),a=parseInt(100*(o.selected_count-o.selected_array.length)/o.selected_count);t.epkb("progress/set",a);let s=o.selected_array.splice(0,5),p={action:"epkb_convert_kb_content",_wpnonce_epkb_ajax_action:epkb_vars.nonce,epkb_kb_id:o.kb_id,epkb_convert_post_type:o.post_type,selected_rows:JSON.stringify(s),convert_terms_mode:o.convert_terms_mode,epkb_convert_step:o.step,category_taxonomy:o.category_taxonomy,tags_taxonomy:o.tags_taxonomy};e.ajax({type:"POST",dataType:"json",data:p,url:ajaxurl}).done(function(a){if(o.step<4)return!1;if(void 0!==a.error)return e(document).epkb("ajax/error_message",a.message),n(),!1;if("object"==typeof a.process_errors)for(let e in a.process_errors)t.epkb("progress/add_log",{message:a.process_errors[e],type:"error"});void 0!==a.success&&o.selected_array.length?r():void 0!==a.success&&(t.epkb("progress/add_log",{message:a.success,type:"success"}),t.epkb("progress/add_log",{message:o.selected_count-o.selected_array.length+" "+epkb_vars.msg_articles_converted,type:"success"}),t.epkb("progress/set",100),o.$wrap.find(".epkb-convert-button-cancel").addClass("epkb-hidden"),o.$wrap.find(".epkb-convert-button-exit").removeClass("epkb-hidden"))})}let o={kb_id:1,step:1,selected_array:[],$wrap:[],post_type:"post",convert_terms_mode:"copy_terms",selected_count:0,category_taxonomy:"",tags_taxonomy:""};e(".epkb-convert-button-back").on("click",function(){o.step<2?e(document).epkb("tools/hide_panels"):o.step<5?n("prev"):n()}),e(".epkb-convert-button-next").on("click",function(){if(1==o.step&&(o={kb_id:e(this).data("kb_id"),step:1,selected_array:[],$wrap:e(this).closest(".epkb-form-wrap"),post_type:e(this).closest(".epkb-form-wrap").find("[name=epkb_convert_post_type]").val(),convert_terms_mode:"copy_terms",selected_count:0,category_taxonomy:"",tags_taxonomy:""}),!t())return!1;n("next")}),e(".epkb-convert-button-start_convert").on("click",function(){if(!t())return!1;n("next")}),e(".epkb-convert-button-cancel").on("click",function(){e(this).addClass("epkb-hidden"),n()}),e(".epkb-convert-button-exit").on("click",function(){n(),e(document).epkb("tools/hide_panels")}),e(document).on("change keyup",".epkb-convert-form--posts .epkb-convert-categories-select select, .epkb-convert-form--posts .epkb-convert-categories-filters--name-filter input",function(){e("[name=row_id]").prop("checked",!1),e("#check_all_convert").prop("checked",!1),o.$wrap.find(".epkb-dsl__article-list__body .epkb-admin-row").each(function(){let t=!0,n=e(this);o.$wrap.find(".epkb-convert-categories-select select").each(function(){if(""==e(this).val())return!0;let r=e(this).data("taxonomy-name");return 0==n.find("[data-kb-import-tax="+r+"]").length?(t=!1,!1):0==n.find("[data-kb-import-tax="+r+"]").find("[data-kb-import-cat-id="+e(this).val()+"]").length?(t=!1,!1):void 0});let r=o.$wrap.find(".epkb-convert-categories-filters--name-filter input").val().toLowerCase();r&&-1==n.find(".title").text().toLowerCase().indexOf(r)&&(t=!1),t?e(this).removeClass("hidden"):e(this).addClass("hidden")})}),e(".epkb-convert-form--posts").on("change","#check_all_convert",function(){e(this).prop("checked")?o.$wrap.find(".epkb-dsl__article-list__body .epkb-admin-row").each(function(){!o.current_category||e(this).find("[data-kb-import-cat-id="+o.current_category+"]").length?e(this).find("[name=row_id]").prop("checked","checked"):e(this).find("[name=row_id]").prop("checked",!1)}):o.$wrap.find(".epkb-dsl__article-list__body .epkb-admin-row [name=row_id]").prop("checked",!1)}),e(document).on("change",".epkb-author__curr_auth [name=categories_taxonomy]",function(){e(this).val()==e(".epkb-author__curr_auth [name=tags_taxonomy]").val()&&e(".epkb-author__curr_auth [name=tags_taxonomy]").val("")}),e(document).on("change",".epkb-author__curr_auth [name=tags_taxonomy]",function(){e(this).val()==e(".epkb-author__curr_auth [name=categories_taxonomy]").val()&&e(".epkb-author__curr_auth [name=categories_taxonomy]").val("")})});