jQuery(document).ready(function(e){"use strict";e.widget("cp.OutoftheBoxDashboard",{options:{$container_totals:e("#outofthebox-totals"),$container_events_chart:e("#outofthebox-events-chart"),$container_top_downloads:e("#top-downloads"),$container_top_users:e("#top-users"),$container_latest_uploads:e("#latest-uploads"),$container_top_uploads:e("#top-uploads"),$container_full_log:e("#full-log")},_create:function(){this._initiate()},_destroy:function(){return this._super()},_setOption:function(e,t){this._super(e,t)},_initiate:function(){var t=this;e("body").addClass("outofthebox"),this._initChartDatePicker(),this.options.$container_totals.one("inview",function(e,a){t.loadTotalsData(t.options.$container_totals,null,null)}),this.options.$container_events_chart.one("inview",function(e,a){t.loadChartData()}),this.options.$container_top_downloads.one("inview",function(e,a){t.loadTopDownloads()}),this.options.$container_top_users.one("inview",function(e,a){t.loadTopUsers()}),this.options.$container_latest_uploads.one("inview",function(e,a){t.loadLatestUploads()}),this.options.$container_top_uploads.one("inview",function(e,a){t.loadTopUploads()}),this.options.$container_full_log.one("inview",function(e,a){t.loadFullLog()}),this._initEvents()},_initEvents:function(){var t=this;e(t.element).on("click","a.open-entry-details",function(a){var n=e(this).data("entry-id"),o=e(this).data("account-id");t.viewEntryDetails(n,o)}),e("body").on("click","#outofthebox-modal-action a.open-entry-details",function(a){var n=e(this).data("entry-id"),o=e(this).data("account-id");t.viewEntryDetails(n,o)}),e(t.element).on("click","a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e("body").on("click","#outofthebox-modal-action a.open-user-details",function(a){var n=e(this).data("user-id");t.viewUserDetails(n)}),e(t.element).on("click","#clear_statistics",function(e){t.clearStatistics()})},clearStatistics:function(){var t=this,a=e("#clear_statistics");a.addClass("disabled"),a.find(".wpcp-spinner").fadeIn(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"outofthebox-reset-statistics",_ajax_nonce:t.options.admin_nonce},complete:function(){a.removeClass("disabled"),a.find(".wpcp-spinner").fadeOut(),location.reload()},dataType:"json"})},_initChartDatePicker:function(){var e=this,t=e.element.find(".chart_datepicker_from"),a=e.element.find(".chart_datepicker_to");e.chart_datepicker_from=t.datepicker({altField:".chart_datepicker_from",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0}).on("change",function(){e.chart_datepicker_to.datepicker("option","minDate",moment(t.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData(),e.fullLog.ajax.reload()},1e3)}),t.datepicker("setDate",moment().subtract(1,"months").toDate()),e.chart_datepicker_to=a.datepicker({altField:".chart_datepicker_to",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0,maxDate:"+0d"}).on("change",function(){e.chart_datepicker_from.datepicker("option","maxDate",moment(a.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(e.updateChartTimer),e.updateChartTimer=setTimeout(function(){e.loadChartData(),e.fullLog.ajax.reload()},1e3)}),a.datepicker("setDate",moment().toDate())},loadChartData:function(){var t=this;t.options.$container_events_chart.prev().fadeIn(),e.ajax({method:"POST",url:t.options.ajax_url,data:{action:"outofthebox-event-stats",type:"activities",periodstart:moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e){t._setChart(e)},complete:function(e){t.options.$container_events_chart.prev().fadeOut()},dataType:"json"})},_setChart:function(e){var t=this;new Chart(t.options.$container_events_chart,{type:"line",options:{responsive:!0,maintainAspectRatio:!1,legend:{position:"bottom"},tooltips:{mode:"x"},scales:{xAxes:[{type:"time",time:{parser:"DD-MM-YYYY",unit:"day",tooltipFormat:"LL"},scaleLabel:{display:!1},ticks:{beginAtZero:!1}}],yAxes:[{scaleLabel:{display:!1},ticks:{beginAtZero:!0}}]}},data:e})},loadTotalsData:function(t,a,n){var o=this;t.find(".outofthebox-counter span").css({"background-color":"",color:""}),e.ajax({method:"POST",url:o.options.ajax_url,data:{action:"outofthebox-event-stats",type:"totals",detail:a,id:n,_ajax_nonce:o.options.admin_nonce},success:function(e){o._setTotalsData(t,e)},complete:function(e){t.find(".loading").fadeOut()},dataType:"json"})},_setTotalsData:function(t,a){e.each(t.find(".outofthebox-counter"),function(){var t=e(this).data("type");if(void 0===a[t])return e(this).find("span").append("0"),!0;var n=parseInt(a[t].total);e(this).find("span").css({"background-color":a[t].colors.normal,color:"white"}).append(n)})},loadTopDownloads:function(){var e=this;e.options.$container_top_downloads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'" data-account-id="'+a.account_id+'">'+a.entry_name+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"topdownloads",_ajax_nonce:e.options.admin_nonce}}})},loadTopUsers:function(){var e=this;e.options.$container_top_users.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"user_name",targets:2,className:"dt-left",render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:3,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[3,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"topusers",_ajax_nonce:e.options.admin_nonce}}})},loadLatestUploads:function(){var e=this;e.options.$container_latest_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"datetime"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'"><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'" data-account-id="'+a.account_id+'">'+a.entry_name+"</a>"}},{name:"datetime",targets:2,width:"120px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"latestuploads",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadTopUploads:function(){var e=this;e.options.$container_top_uploads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+e+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all",responsivePriority:1,render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"user_name",targets:2,className:"dt-left",render:function(e,t,a,n){return"display"!==t?e:"0"===a.user_id?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"total",targets:3,width:"30px",className:"dt-right",render:function(e,t,a,n){return e}}],order:[[3,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"topuploads",length:25,_ajax_nonce:e.options.admin_nonce}}})},loadFullLog:function(){var t=this;t.fullLog=t.options.$container_full_log.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:500,scroller:!0,scrollCollapse:!0,pageLength:50,searchDelay:600,buttons:[{text:'<i class="fas fa-file-export fa-lg"></i>',className:"simple-button blue",action:function(a,n,o,i){e.ajax({url:t.options.ajax_url,data:{action:"outofthebox-event-stats",type:"full-log",export:!0,periodstart:moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:t.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.setAttribute("download","data.csv"),i.click()}})}},{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='fas "+e+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i> '+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:t.options.ajax_url,data:function(e){e.action="outofthebox-event-stats",e.type="full-log",e.periodstart=moment(t.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),e.periodend=moment(t.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),e._ajax_nonce=t.options.admin_nonce}}})},loadDetailedLog:function(t,a,n){var o=this;t.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:300,scroller:!0,pageLength:50,searchDelay:600,responsive:!0,buttons:[{text:'<i class="fas fa-file-export fa-lg"></i>',className:"simple-button blue",action:function(t,i,s,r){e.ajax({url:o.options.ajax_url,data:{action:"outofthebox-event-stats",type:"full-log",detail:a,id:n,export:!0,_ajax_nonce:o.options.admin_nonce},success:function(e,t,a){var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.setAttribute("download","data.csv"),i.click()}})}},{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(e,t,a,n){return"display"!==t?e:"<i class='fas "+e+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(e,t,a,n){return e}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(e,t,a,n){return e}},{name:"type",targets:3,className:"all",visible:!1,render:function(e,t,a,n){return e}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+e+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(e,t,a,n){return"display"!==t?e:""===e?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i>'+e+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(e,t,a,n){return e}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:o.options.ajax_url+"?action=outofthebox-event-stats&type=full-log&detail="+a+"&id="+n+"&_ajax_nonce="+o.options.admin_nonce})},viewEntryDetails:function(e,t){var a=this;a.openModal("entry",e,t)},viewUserDetails:function(e){var t=this;t.openModal("user",e,null)},openModal:function(t,a,n){var o=this;e("#outofthebox-modal-action").remove();var i="";i+='<button class="simple-button blue outofthebox-modal-cancel-btn secondary" data-action="cancel" type="button" onclick="modal_action.close();" title="'+o.options.str_close_title+'" >'+o.options.str_close_title+"</button>";var s=e('<a tabindex="0" class="close-button" title="'+o.options.str_close_title+'" onclick="modal_action.close();"><i class="fas fa-times fa-lg" aria-hidden="true"></i></a></div>'),r=e('<div class="outofthebox-modal-body" tabindex="0" style="display:none"></div>'),d=e('<div class="outofthebox-modal-footer" style="display:none"><div class="outofthebox-modal-buttons">'+i+"</div></div>"),l=e('<div id="outofthebox-modal-action" class="OutoftheBox outofthebox-modal outofthebox-modal80 '+o.options.content_skin+'"><div class="modal-dialog"><div class="modal-content"><div class="loading"><div class="loader-beat"></div></div></div></div></div>');e("body").append(l);var c=e(".event-details-template").clone().appendTo(r).show();switch(e("#outofthebox-modal-action .modal-content").append(s,r,d),t){case"user":var u=e(".modal-content  .event-details-user-template").show();break;case"entry":u=e(".modal-content  .event-details-entry-template").show()}var p=e(".modal-content .event-details-totals-template");p.find("span").html('<div class="loading"><div class="loader-beat"></div></div>'),o.loadTotalsData(p,t,a),e.ajax({type:"POST",url:o.options.ajax_url,data:{action:"outofthebox-event-stats",account_id:n,type:"get-detail",detail:t,id:a,_ajax_nonce:o.options.admin_nonce},success:function(a){switch(t){case"user":c.find(".event-details-name").text(a.user.user_name),u.find(".event-details-email").text(a.user.user_email),u.find(".event-details-roles").text(a.user.user_roles),u.find(".event-details-entry-img").css("background-image","url("+a.user.avatar+")"),u.find(".event-visit-profile").attr("href",a.user.user_link);break;case"entry":c.find(".event-details-name").text(a.entry.entry_name),u.find(".event-details-description").text(a.entry.entry_description),u.find(".event-details-entry-img").css("background-image","url("+a.entry.entry_thumbnails+")"),!1===a.entry.entry_link?u.find(".event-download-entry").fadeOut():u.find(".event-download-entry").attr("href",a.entry.entry_link+"&_ajax_nonce="+o.options.admin_nonce)}e(".outofthebox-modal-body").fadeIn(),e(".outofthebox-modal-footer").fadeIn(),e(".modal-content .loading:first").fadeOut()},complete:function(){u.find(".loading").fadeOut()},dataType:"json"}),o.loadDetailedLog(e("#outofthebox-modal-action .modal-content table"),t,a);var m=new RModal(document.getElementById("outofthebox-modal-action"),{bodyClass:"rmodal-open",dialogOpenClass:"animated slideInDown",dialogCloseClass:"animated slideOutUp",escapeClose:!0});document.addEventListener("keydown",function(e){m.keydown(e)},!1),m.open(),window.modal_action=m}}),e(".OutoftheBoxDashboard").OutoftheBoxDashboard(OutoftheBox_Dashboard_vars)});