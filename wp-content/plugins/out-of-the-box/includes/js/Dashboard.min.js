(function(t){"use strict";t.widget("cp.OutoftheBoxDashboard",{options:{$container_totals:t("#outofthebox-totals"),$container_events_chart:t("#outofthebox-events-chart"),$container_top_downloads:t("#top-downloads"),$container_top_users:t("#top-users"),$container_full_log:t("#full-log")},_create:function(){this._initiate()},_destroy:function(){return this._super()},_setOption:function(t,e){this._super(t,e)},_initiate:function(){var e=this;t("body").addClass("outofthebox"),this._initChartDatePicker(),this.options.$container_totals.one("inview",function(t,a){e.loadTotalsData(e.options.$container_totals,null,null)}),this.options.$container_events_chart.one("inview",function(t,a){e.loadChartData()}),this.options.$container_top_downloads.one("inview",function(t,a){e.loadTopDownloads()}),this.options.$container_top_users.one("inview",function(t,a){e.loadTopUsers()}),this.options.$container_full_log.one("inview",function(t,a){e.loadFullLog()}),this._initEvents()},_initEvents:function(){var e=this;t(e.element).on("click","a.open-entry-details",function(a){var n=t(this).data("entry-id"),o=t(this).data("account-id");e.viewEntryDetails(n,o)}),t("body").on("click","#outofthebox-modal-action a.open-entry-details",function(a){var n=t(this).data("entry-id"),o=t(this).data("account-id");e.viewEntryDetails(n,o)}),t(e.element).on("click","a.open-user-details",function(a){var n=t(this).data("user-id");e.viewUserDetails(n)}),t("body").on("click","#outofthebox-modal-action a.open-user-details",function(a){var n=t(this).data("user-id");e.viewUserDetails(n)}),t(e.element).on("click","#clear_statistics",function(t){e.clearStatistics()})},clearStatistics:function(){var e=this,a=t("#clear_statistics");a.addClass("disabled"),a.find(".oftb-spinner").fadeIn(),t.ajax({method:"POST",url:e.options.ajax_url,data:{action:"outofthebox-reset-statistics",_ajax_nonce:e.options.admin_nonce},complete:function(){a.removeClass("disabled"),a.find(".oftb-spinner").fadeOut(),location.reload(!0)},dataType:"json"})},_initChartDatePicker:function(){var t=this,e=t.element.find(".chart_datepicker_from"),a=t.element.find(".chart_datepicker_to");t.chart_datepicker_from=e.datepicker({altField:".chart_datepicker_from",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0}).on("change",function(){t.chart_datepicker_to.datepicker("option","minDate",moment(e.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(t.updateChartTimer),t.updateChartTimer=setTimeout(function(){t.loadChartData(),t.fullLog.ajax.reload()},1e3)}),e.datepicker("setDate",moment().subtract(1,"months").toDate()),t.chart_datepicker_to=a.datepicker({altField:".chart_datepicker_to",autoSize:!0,dateFormat:"dd-mm-yy",changeMonth:!0,maxDate:"+0d"}).on("change",function(){t.chart_datepicker_from.datepicker("option","maxDate",moment(a.datepicker("getDate")).format("DD-MM-YYYY")),clearTimeout(t.updateChartTimer),t.updateChartTimer=setTimeout(function(){t.loadChartData(),t.fullLog.ajax.reload()},1e3)}),a.datepicker("setDate",moment().toDate())},loadChartData:function(){var e=this;e.options.$container_events_chart.prev().fadeIn(),t.ajax({method:"POST",url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"activities",periodstart:moment(e.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(e.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce},success:function(t){e._setChart(t)},complete:function(t){e.options.$container_events_chart.prev().fadeOut()},dataType:"json"})},_setChart:function(t){var e=this;new Chart(e.options.$container_events_chart,{type:"line",options:{responsive:!0,maintainAspectRatio:!1,legend:{position:"bottom"},tooltips:{mode:"x"},scales:{xAxes:[{type:"time",time:{parser:"DD-MM-YYYY",unit:"day",tooltipFormat:"LL"},scaleLabel:{display:!1},ticks:{beginAtZero:!1}}],yAxes:[{scaleLabel:{display:!1},ticks:{beginAtZero:!0}}]}},data:t})},loadTotalsData:function(e,a,n){var o=this;e.find(".outofthebox-counter span").css({"background-color":"",color:""}),t.ajax({method:"POST",url:o.options.ajax_url,data:{action:"outofthebox-event-stats",type:"totals",detail:a,id:n,_ajax_nonce:o.options.admin_nonce},success:function(t){o._setTotalsData(e,t)},complete:function(t){e.find(".loading").fadeOut()},dataType:"json"})},_setTotalsData:function(e,a){t.each(e.find(".outofthebox-counter"),function(){var e=t(this).data("type");if(void 0===a[e])return t(this).find("span").append("0"),!0;var n=parseInt(a[e].total);t(this).find("span").css({"background-color":a[e].colors.normal,color:"white"}).append(n)})},loadTopDownloads:function(){var t=this;t.options.$container_top_downloads.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"entry_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(t,e,a,n){return"display"!==e?t:'<a href="#'+a.entry_id+'"><img src="'+t+'" width="24px" height="24px"/></a>'}},{name:"entry_name",targets:1,className:"all",responsivePriority:1,render:function(t,e,a,n){return"display"!==e?t:'<a href="#'+a.entry_id+'" title="'+a.parent_path+"/"+a.entry_name+'" class="open-entry-details" data-entry-id="'+a.entry_id+'">'+a.entry_name+"</a>"}},{name:"total",targets:2,width:"30px",className:"dt-right",render:function(t,e,a,n){return t}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:t.options.ajax_url,data:{action:"outofthebox-event-stats",type:"topdownloads",_ajax_nonce:t.options.admin_nonce}}})},loadTopUsers:function(){var t=this;t.options.$container_top_users.DataTable({dom:'<"top">rt<"bottom">p<"clear">',language:{loadingRecords:"",processing:'<div class="loading"><div class="loader-beat"></div></div>'},searching:!1,autoWidth:!0,scrollY:"300px",paging:!1,deferRender:!0,responsive:{details:{type:"column",target:-1}},columns:[{data:"icon"},{data:"user_display_name"},{data:"user_name"},{data:"total"}],columnDefs:[{name:"icon",targets:0,width:"20px",className:"all",responsivePriority:4,searchable:!1,orderable:!1,render:function(t,e,a,n){return"display"!==e?t:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'" ><img src="'+t+'" width="24px" height="24px"/></a>'}},{name:"user_display_name",targets:1,className:"all",responsivePriority:1,render:function(t,e,a,n){return"display"!==e?t:"0"===a.user_id?t:'<a href="#'+a.user_id+'" class="open-user-details" data-user-id="'+a.user_id+'">'+t+"</a>"}},{name:"user_name",targets:2,className:"dt-left",render:function(t,e,a,n){return"display"!==e?t:"0"===a.user_id?t:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+t+"</a>"}},{name:"total",targets:3,width:"30px",className:"dt-right",render:function(t,e,a,n){return t}}],order:[[3,"desc"]],processing:!0,serverSide:!0,ajax:{url:t.options.ajax_url,data:{action:"outofthebox-event-stats",type:"topusers",_ajax_nonce:t.options.admin_nonce}}})},loadFullLog:function(){var e=this;e.fullLog=e.options.$container_full_log.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:500,scroller:!0,scrollCollapse:!0,pageLength:50,searchDelay:600,buttons:[{text:'<i class="fas fa-file-export fa-lg"></i>',className:"simple-button blue",action:function(a,n,o,i){t.ajax({url:e.options.ajax_url,data:{action:"outofthebox-event-stats",type:"full-log",export:!0,periodstart:moment(e.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),periodend:moment(e.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),_ajax_nonce:e.options.admin_nonce},success:function(t,e,a){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.setAttribute("download","data.csv"),i.click()}})}},{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(t,e,a,n){return"display"!==e?t:"<i class='fas "+t+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(t,e,a,n){return t}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(t,e,a,n){return t}},{name:"type",targets:3,className:"all",visible:!1,render:function(t,e,a,n){return t}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(t,e,a,n){return"display"!==e?t:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+t+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(t,e,a,n){return"display"!==e?t:""===t?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i> '+t+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:{url:e.options.ajax_url,data:function(t){t.action="outofthebox-event-stats",t.type="full-log",t.periodstart=moment(e.chart_datepicker_from.datepicker("getDate")).format("YYYY-MM-DD"),t.periodend=moment(e.chart_datepicker_to.datepicker("getDate")).format("YYYY-MM-DD"),t._ajax_nonce=e.options.admin_nonce}}})},loadDetailedLog:function(e,a,n){var o=this;e.DataTable({dom:'fBrtip<"clear">',language:{loadingRecords:'<div class="loading"><div class="loader-beat"></div></div>',processing:'<div class="loading"><div class="loader-beat"></div></div>'},autoWidth:!0,deferRender:!0,scrollY:300,scroller:!0,pageLength:50,searchDelay:600,responsive:!0,buttons:[{text:'<i class="fas fa-file-export fa-lg"></i>',className:"simple-button blue",action:function(e,i,s,r){t.ajax({url:o.options.ajax_url,data:{action:"outofthebox-event-stats",type:"full-log",detail:a,id:n,export:!0,_ajax_nonce:o.options.admin_nonce},success:function(t,e,a){var n=new Blob([t],{type:"text/csv;charset=utf-8;"}),o=window.URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.setAttribute("download","data.csv"),i.click()}})}},{extend:"copy",text:'<i class="fas fa-copy fa-lg"></i>',className:"simple-button blue"},{extend:"print",text:'<i class="fas fa-print fa-lg"></i>',className:"simple-button blue",title:""},{extend:"colvis",text:'<i class="fas fa-filter fa-lg"></i>',className:"simple-button blue",background:!1,columns:[1,2,3,4,5,6,7,8]}],columns:[{data:"icon"},{data:"description"},{data:"datetime"},{data:"type"},{data:"user"},{data:"entry_name"},{data:"parent_path"},{data:"location"},{data:"extra"}],columnDefs:[{name:"icon",targets:0,orderable:!1,width:"24px",className:"dt-left all",searchable:!1,render:function(t,e,a,n){return"display"!==e?t:"<i class='fas "+t+" fa-lg'></i>"}},{name:"description",targets:1,className:"dt-left",searchable:!1,render:function(t,e,a,n){return t}},{name:"datetime",targets:2,width:"150px",className:"dt-left all",render:function(t,e,a,n){return t}},{name:"type",targets:3,className:"all",visible:!1,render:function(t,e,a,n){return t}},{name:"user",targets:4,className:"dt-left",visible:!1,render:function(t,e,a,n){return"display"!==e?t:'<a href="#'+a.user_id+'" class="open-user-details"  data-user-id="'+a.user_id+'">'+t+"</a>"}},{name:"entry_name",targets:5,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}},{name:"parent_path",targets:6,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}},{name:"location",targets:7,className:"dt-left",visible:!1,render:function(t,e,a,n){return"display"!==e?t:""===t?"":'<a href="'+a.location_full+'" target="_blank"><i class="fas fa-external-link-alt"></i>'+t+"</a>"}},{name:"extra",targets:8,className:"dt-left",visible:!1,render:function(t,e,a,n){return t}}],order:[[2,"desc"]],processing:!0,serverSide:!0,ajax:o.options.ajax_url+"?action=outofthebox-event-stats&type=full-log&detail="+a+"&id="+n+"&_ajax_nonce="+o.options.admin_nonce})},viewEntryDetails:function(t,e){var a=this;a.openModal("entry",t,e)},viewUserDetails:function(t){var e=this;e.openModal("user",t,null)},openModal:function(e,a,n){var o=this;t("#outofthebox-modal-action").remove();var i="";i+='<button class="simple-button blue outofthebox-modal-cancel-btn secondary" data-action="cancel" type="button" onclick="modal_action.close();" title="'+o.options.str_close_title+'" >'+o.options.str_close_title+"</button>";var s=t('<a tabindex="0" class="close-button" title="'+o.options.str_close_title+'" onclick="modal_action.close();"><i class="fas fa-times fa-lg" aria-hidden="true"></i></a></div>'),r=t('<div class="outofthebox-modal-body" tabindex="0" style="display:none"></div>'),l=t('<div class="outofthebox-modal-footer" style="display:none"><div class="outofthebox-modal-buttons">'+i+"</div></div>"),d=t('<div id="outofthebox-modal-action" class="OutoftheBox outofthebox-modal outofthebox-modal80 '+o.options.content_skin+'"><div class="modal-dialog"><div class="modal-content"><div class="loading"><div class="loader-beat"></div></div></div></div></div>');t("body").append(d);var c=t(".event-details-template").clone().appendTo(r).show();switch(t("#outofthebox-modal-action .modal-content").append(s,r,l),e){case"user":var u=t(".modal-content  .event-details-user-template").show();break;case"entry":u=t(".modal-content  .event-details-entry-template").show()}var p=t(".modal-content .event-details-totals-template");p.find("span").html('<div class="loading"><div class="loader-beat"></div></div>'),o.loadTotalsData(p,e,a),t.ajax({type:"POST",url:o.options.ajax_url,data:{action:"outofthebox-event-stats",account_id:n,type:"get-detail",detail:e,id:a,_ajax_nonce:o.options.admin_nonce},success:function(a){switch(e){case"user":c.find(".event-details-name").text(a.user.user_name),u.find(".event-details-email").text(a.user.user_email),u.find(".event-details-roles").text(a.user.user_roles),u.find(".event-details-entry-img").css("background-image","url("+a.user.avatar+")"),u.find(".event-visit-profile").attr("href",a.user.user_link);break;case"entry":c.find(".event-details-name").text(a.entry.entry_name),u.find(".event-details-description").text(a.entry.entry_description),u.find(".event-details-entry-img").css("background-image","url("+a.entry.entry_thumbnails+")"),!1===a.entry.entry_link?u.find(".event-download-entry").fadeOut():u.find(".event-download-entry").attr("href",a.entry.entry_link+"&_ajax_nonce="+o.options.admin_nonce)}t(".outofthebox-modal-body").fadeIn(),t(".outofthebox-modal-footer").fadeIn(),t(".modal-content .loading:first").fadeOut()},complete:function(){u.find(".loading").fadeOut()},dataType:"json"}),o.loadDetailedLog(t("#outofthebox-modal-action .modal-content table"),e,a);var f=new RModal(document.getElementById("outofthebox-modal-action"),{bodyClass:"rmodal-open",dialogOpenClass:"animated slideInDown",dialogCloseClass:"animated slideOutUp",escapeClose:!0});document.addEventListener("keydown",function(t){f.keydown(t)},!1),f.open(),window.modal_action=f}})})(jQuery),function(t){t(".OutoftheBoxDashboard").OutoftheBoxDashboard(OutoftheBox_Dashboard_vars)}(jQuery);