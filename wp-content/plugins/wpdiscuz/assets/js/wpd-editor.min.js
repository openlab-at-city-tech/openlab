"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?!!e[Symbol.hasInstance](t):t instanceof e}function _get(t,e,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=_superPropBase(t,e);if(i){var r=Object.getOwnPropertyDescriptor(i,e);return r.get?r.get.call(n):r.value}})(t,e,n||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(t){var e=_isNativeReflectConstruct();return function(){var n,i=_getPrototypeOf(t);if(e){var r=_getPrototypeOf(this).constructor;n=Reflect.construct(i,arguments,r)}else n=i.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(t,e){if(e&&("object"===_typeof(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(t)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}var wpdEditorCounter=function(){function t(e,n){_classCallCheck(this,t),this.quill=e,this.options=n,this.commentmaxcount=n.commentmaxcount,this.replymaxcount=n.replymaxcount,this.commentmincount=n.commentmincount,this.replymincount=n.replymincount,this.container=document.getElementById("wpd-editor-char-counter-"+n.uniqueID),this.submit=document.getElementById("wpd-field-submit-"+n.uniqueID),e.on("editor-change",this.update.bind(this)),this.update()}return _createClass(t,[{key:"calculate",value:function(){var t=this.quill.getText().length,e=this.quill.container.id,n=document.querySelectorAll("#".concat(e," .ql-editor img"));return n.length&&n.forEach(function(e){null!==e.src.match(/https\:\/\/s\.w\.org\/images\/core\/emoji/gi)?t+=e.alt.length:e.classList.contains("wpdem-sticker")?t+=e.alt.length:t+=e.src.length}),t}},{key:"update",value:function(){var t=this.calculate(),e=t-1,n=this.quill.container.id.substring(this.quill.container.id.lastIndexOf("_")+1),i=parseInt(n)?this.replymaxcount:this.commentmaxcount;if(i>0&&t>=i&&this.quill.deleteText(i,t),i>0){var r=i-e;this.container.innerText=r>=0?r:0,t+10>i?this.container.classList.add("error"):this.container.classList.remove("error")}else this.container&&this.container.remove()}}]),t}();Quill.register("modules/counter",wpdEditorCounter);var Link=Quill.import("formats/link"),wpdEditorLink=function(t){_inherits(n,Link);var e=_createSuper(n);function n(){return _classCallCheck(this,n),e.apply(this,arguments)}return _createClass(n,null,[{key:"create",value:function(t){var e=_get(_getPrototypeOf(n),"create",this).call(this,t);t=this.sanitize(t),e.setAttribute("href",t);var i=location.protocol+"//"+location.hostname;return(t.startsWith(i)||"#"===t.charAt(0)||"/"===t.charAt(0)&&"/"!==t.charAt(1))&&e.removeAttribute("target"),e}},{key:"sanitize",value:function(t){var e=_get(_getPrototypeOf(n),"sanitize",this).call(this,t),i=e.slice(0,e.indexOf(":"));return"#"!==e.charAt(0)&&"/"!==e.charAt(0)&&-1===this.PROTOCOL_WHITELIST.indexOf(i)&&(e="http://"+t),e}}]),n}();Quill.register(wpdEditorLink,!0);var WpdEditor=function(){function t(){_classCallCheck(this,t),this.editorWraperPrefix="wpd-editor-wraper",this.textEditorContainer="ql-texteditor",this.textEditorPrefix="wc-textarea",this.editorToolbarPrefix="wpd-editor-toolbar",this.sourceCodeButtonName="sourcecode",this.spoiler="spoiler",this.spoilerPromtTitle=wpdiscuzAjaxObj.wc_spoiler_title,this._container="",this._uniqueid="",this.currentEditor=null,this._editors=new Map,this._handlers=new Map,this._initDefaults()}return _createClass(t,[{key:"addButtonEventHandler",value:function(t,e){this._handlers.set(t,e)}},{key:"uniqueid",get:function(){return this._uniqueid},set:function(t){""!==t&&"string"==typeof t?this._uniqueid=t:""===t?this._uniqueid=this._findUniqueId():console.error("Incorrect uniqueid.")}},{key:"container",get:function(){return this._container},set:function(t){""!==t&&"string"==typeof t?(this._container=t,this.uniqueid=this._findUniqueId()):console.error("Incorrect uniqueid.")}},{key:"createEditor",value:function(t){var e=this;if(this.container=t,this._editors.has(this.uniqueid))this.currentEditor=this._editors.get(this.uniqueid);else{var n="#".concat(this.editorToolbarPrefix,"-").concat(this.uniqueid);wpdiscuzEditorOptions.modules.toolbar=n,wpdiscuzEditorOptions.modules.counter.uniqueID=this.uniqueid;var i=new Quill(this.container,wpdiscuzEditorOptions);i.on("editor-change",function(t){null!==(arguments.length<=1?void 0:arguments[1])&&(e.currentEditor=i,e.container=i.container.id)}),i.clipboard.addMatcher("a",function(t,e){return t.getAttribute("href")===t.innerHTML?new(Quill.import("delta"))([{insert:t.innerHTML}]):e}),i.clipboard.addMatcher("img",function(t,e){var n=Quill.import("delta"),i=t.getAttribute("src");return/^data:image\/.+;base64/.test(i)?new n([{insert:""}]):new n([{insert:i}])}),document.querySelectorAll("".concat(n," button")).forEach(function(t){t.onclick=function(){e.currentEditor=i,e.container=i.container.id;var n=t.dataset.wpde_button_name;void 0!==n&&"string"==typeof n&&""!==n.trim()&&e._handlers.has(n)&&e._handlers.get(n)(e.currentEditor,e.uniqueid)}}),this._bindTextEditor(i),this._editors.set(this.uniqueid,i),document.getElementById("".concat(this.editorWraperPrefix,"-").concat(this.uniqueid)).style.display=""}var r=0;document.getElementsByClassName("wpd-thread-info").length&&(r=parseInt(document.getElementsByClassName("wpd-thread-info")[0].getAttribute("data-comments-count")));var o=r?"wc_comment_join_text":"wc_be_the_first_text";return this.currentEditor.root.setAttribute("data-placeholder",wpdiscuzAjaxObj.applyFilterOnPhrase(wpdiscuzEditorOptions[o],o,jQuery(t))),this.currentEditor}},{key:"removeEditor",value:function(t){this.container=t,this._editors.has(this.uniqueid)&&this._editors.delete(this.uniqueid)}},{key:"_bindTextEditor",value:function(t){var e="".concat(this.textEditorPrefix,"-").concat(this.uniqueid),n=document.getElementById(e);n&&(n.style.cssText="display: none;",t.addContainer(this.textEditorContainer).appendChild(n)),this.currentEditor=t}},{key:"_findUniqueId",value:function(){return this.container.substring(this.container.lastIndexOf("-")+1)}},{key:"_initDefaults",value:function(){var t=this;this.addButtonEventHandler(this.sourceCodeButtonName,function(e){document.getElementById("".concat(t.textEditorPrefix,"-").concat(t.uniqueid));var n=document.getElementById("wpd-editor-source-code-wrapper-bg"),i=document.getElementById("wpd-editor-source-code-wrapper"),r=document.getElementById("wpd-editor-source-code"),o=document.getElementById("wpd-editor-uid");n.style.display="block",i.style.display="block",o.value=e.container.id,r.value=e.root.innerHTML}),this.addButtonEventHandler(this.spoiler,function(e){var n=prompt(t.spoilerPromtTitle);if(null!==n){var i=' [spoiler title="'.concat(n,'"] '),r=e.getSelection();null===r&&(r={index:e.getLength()-1,length:0}),0===r.length?(e.insertText(r.index,i+" [/spoiler] ",Quill.sources.USER),e.setSelection(r.index+i.length,Quill.sources.USER)):(e.insertText(r.index,i),e.insertText(r.index+i.length+r.length," [/spoiler] ",Quill.sources.USER),e.setSelection(r.index+i.length+r.length+" [/spoiler] ".length,Quill.sources.USER))}})}}]),t}();